name: Build and Release MCPB Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build-mcpb:
    name: Build MCPB Package
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install MCPB CLI
      run: |
        npm install -g @anthropic-ai/mcpb
        mcpb --version
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install "fastmcp>=2.12.0,<3.0.0"
        pip install -r requirements.txt
        
    - name: Validate FastMCP version
      run: |
        python -c "import fastmcp; print(f'FastMCP version: {fastmcp.__version__}')"
        python -c "import fastmcp; v=fastmcp.__version__.split('.'); assert int(v[0])>=2 and int(v[1])>=12, 'FastMCP must be >= 2.12.0'"
        
    - name: Create dist directory
      run: mkdir -p dist
        
    - name: Validate manifest.json
      run: mcpb validate mcpb/manifest.json
      
    - name: Build MCPB package
      run: |
        mcpb pack . dist/tapo-camera-mcp.mcpb
        
    - name: Verify package
      run: |
        ls -lh dist/
        file dist/tapo-camera-mcp.mcpb || echo "Package created"
        
    - name: Sign MCPB package (optional)
      if: ${{ secrets.MCPB_SIGNING_KEY }}
      run: |
        echo "${{ secrets.MCPB_SIGNING_KEY }}" > signing.key
        mcpb sign --key signing.key dist/tapo-camera-mcp.mcpb
        rm signing.key
        
    - name: Upload MCPB artifact
      uses: actions/upload-artifact@v3
      with:
        name: tapo-camera-mcp-package
        path: dist/*.mcpb
        retention-days: 90
        
    - name: Build Python package
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        python -m pip install build
        python -m build
        
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/*.mcpb
          dist/*.whl
          dist/*.tar.gz
        generate_release_notes: true
        draft: false
        prerelease: false
        body: |
          ## ðŸ“¦ Tapo Camera MCP Release
          
          ### Installation
          
          #### Method 1: MCPB Package (Recommended)
          1. Download the `.mcpb` file from the assets below
          2. Drag the file to Claude Desktop
          3. Configure camera settings when prompted
          4. Restart Claude Desktop
          5. Access 26+ camera tools in Claude!
          
          #### Method 2: Manual Installation
          1. Download the source code
          2. Extract to a directory
          3. Add manual configuration to `claude_desktop_config.json`:
          ```json
          {
            "mcpServers": {
              "tapo-camera-mcp": {
                "command": "python",
                "args": ["-m", "tapo_camera_mcp.server_v2", "--direct"],
                "cwd": "D:/path/to/tapo-camera-mcp",
                "env": {
                  "PYTHONPATH": "D:/path/to/tapo-camera-mcp/src",
                  "PYTHONUNBUFFERED": "1"
                }
              }
            }
          }
          ```
          
          ### Features
          
          - âœ… **4 Camera Types**: Tapo, Ring, Furbo, USB webcams
          - âœ… **26+ MCP Tools**: Complete camera control suite
          - âœ… **PTZ Control**: Pan, tilt, zoom with presets
          - âœ… **Video Streaming**: Live video in web dashboard
          - âœ… **Motion Detection**: Real-time event monitoring
          - âœ… **AI Vision**: DINOv3-powered scene analysis
          - âœ… **Web Dashboard**: http://localhost:7777
          - âœ… **Grafana Integration**: Metrics and monitoring
          
          ### Quick Start
          
          ```
          # After installation, add a USB webcam:
          "Connect to my USB webcam using add_camera tool"
          
          # Or add a Tapo camera:
          "Add a Tapo camera at 192.168.1.100 with username X and password Y"
          
          # View the dashboard:
          "Start the dashboard and show me the camera feed"
          ```
          
          ### Documentation
          
          - [README.md](https://github.com/sandraschi/tapo-camera-mcp/blob/main/README.md)
          - [Assessment](https://github.com/sandraschi/tapo-camera-mcp/blob/main/docs/assessment.md)
          - [PRD](https://github.com/sandraschi/tapo-camera-mcp/blob/main/docs/PRD.md)
          
          ### Dependencies
          
          - Python 3.10+
          - FastMCP 2.12.0+
          - pytapo 3.3.0+
          - opencv-python 4.8.0+
          - ring-doorbell 0.8.0+
          
          ### What's New
          
          See the auto-generated release notes below.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Publish to PyPI
      if: startsWith(github.ref, 'refs/tags/') && secrets.PYPI_API_TOKEN
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        user: __token__
        password: ${{ secrets.PYPI_API_TOKEN }}
        
    - name: Summary
      run: |
        echo "âœ… Build completed successfully!"
        echo "ðŸ“¦ Package: dist/tapo-camera-mcp.mcpb"
        ls -lh dist/

