name: Comprehensive CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run comprehensive tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_focus:
        description: 'Focus area for testing'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - unit
        - integration
        - performance
        - security
        - api
        - mcp

env:
  PYTHON_VERSION: "3.10"
  POETRY_VERSION: "1.7.1"
  NODE_VERSION: "18"

jobs:
  # ============================================================================
  # QUALITY GATES
  # ============================================================================

  quality-checks:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 - --version ${{ env.POETRY_VERSION }}
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure Poetry
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true

      - name: Install dependencies
        run: poetry install --with dev --no-interaction

      - name: Run Ruff linting
        run: poetry run ruff check .

      - name: Run Ruff formatting check
        run: poetry run ruff format --check .

      - name: Run MyPy type checking
        run: poetry run mypy tapo_camera_mcp --ignore-missing-imports

      - name: Run security linting (Bandit)
        run: poetry run bandit -r tapo_camera_mcp -f json -o security-report.json

      - name: Check for security vulnerabilities
        run: poetry run safety check --json > safety-report.json

      - name: Archive security reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-reports
          path: |
            security-report.json
            safety-report.json

  # ============================================================================
  # UNIT TESTS
  # ============================================================================

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]
        test-group: ["core", "api", "mcp", "utils"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 - --version ${{ env.POETRY_VERSION }}
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure Poetry
        run: poetry config virtualenvs.create true

      - name: Install dependencies
        run: poetry install --with dev --no-interaction

      - name: Run unit tests
        run: |
          if [ "${{ matrix.test-group }}" = "core" ]; then
            poetry run pytest tests/unit/ -k "not (integration or performance or security)" --cov=tapo_camera_mcp --cov-report=xml --cov-report=term-missing -x
          elif [ "${{ matrix.test-group }}" = "api" ]; then
            poetry run pytest tests/unit/test_api_*.py --cov=tapo_camera_mcp --cov-report=xml --cov-report=term-missing -x
          elif [ "${{ matrix.test-group }}" = "mcp" ]; then
            poetry run pytest tests/unit/test_mcp_*.py --cov=tapo_camera_mcp --cov-report=xml --cov-report=term-missing -x
          else
            poetry run pytest tests/unit/ -k "${{ matrix.test-group }}" --cov=tapo_camera_mcp --cov-report=xml --cov-report=term-missing -x
          fi

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unit,${{ matrix.python-version }},${{ matrix.test-group }}
          name: unit-tests-${{ matrix.python-version }}-${{ matrix.test-group }}

  # ============================================================================
  # INTEGRATION TESTS
  # ============================================================================

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: poetry install --with dev --no-interaction

      - name: Run integration tests
        run: |
          poetry run pytest tests/integration/ -v --cov=tapo_camera_mcp --cov-report=xml --cov-report=term-missing --durations=10
        env:
          REDIS_URL: redis://localhost:6379
          TEST_INTEGRATION: true

      - name: Upload integration test artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: integration-test-results
          path: |
            test-results/
            *.log

  # ============================================================================
  # API CONTRACT TESTS
  # ============================================================================

  api-contract-tests:
    name: API Contract Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: poetry install --with dev --no-interaction

      - name: Start test server
        run: |
          poetry run uvicorn tapo_camera_mcp.web.server:create_app --host 0.0.0.0 --port 8000 &
          sleep 10

      - name: Run API contract tests
        run: |
          poetry run pytest tests/e2e/test_sensor_api.py -v --base-url http://localhost:8000

      - name: Generate API documentation
        run: |
          poetry run python -c "
          from tapo_camera_mcp.web.server import create_app
          from fastapi.openapi.utils import get_openapi
          import json

          app = create_app()
          openapi_schema = get_openapi(
              title='Tapo Camera MCP API',
              version='1.16.0',
              description='Home Security MCP Platform API',
              routes=app.routes,
          )

          with open('openapi.json', 'w') as f:
            json.dump(openapi_schema, f, indent=2)
          "

      - name: Archive API documentation
        uses: actions/upload-artifact@v3
        with:
          name: api-documentation
          path: openapi.json

  # ============================================================================
  # PERFORMANCE TESTS
  # ============================================================================

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: poetry install --with dev --no-interaction

      - name: Run performance benchmarks
        run: |
          poetry run pytest tests/unit/ -k "performance" -v --benchmark-only --benchmark-json=benchmark-results.json

      - name: Run load tests
        run: |
          poetry run python -m pytest tests/integration/test_load.py -v --maxfail=5

      - name: Generate performance report
        run: |
          poetry run python scripts/generate_performance_report.py benchmark-results.json

      - name: Archive performance results
        uses: actions/upload-artifact@v3
        with:
          name: performance-results
          path: |
            benchmark-results.json
            performance-report.html
            performance-report.md

  # ============================================================================
  # SECURITY TESTS
  # ============================================================================

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: poetry install --with dev --no-interaction

      - name: Run security unit tests
        run: poetry run pytest tests/unit/ -k "security" -v

      - name: Run dependency vulnerability scan
        run: |
          poetry run safety check --full-report > security-audit.txt

      - name: Run secrets scanning
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run container security scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload security scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: trivy-results.sarif

      - name: Archive security audit
        uses: actions/upload-artifact@v3
        with:
          name: security-audit
          path: security-audit.txt

  # ============================================================================
  # CROSS-PLATFORM TESTS
  # ============================================================================

  cross-platform-tests:
    name: Cross-Platform Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.9", "3.10"]
        exclude:
          # Reduce matrix size for faster CI
          - os: windows-latest
            python-version: "3.9"
          - os: macos-latest
            python-version: "3.9"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        run: poetry install --with dev --no-interaction

      - name: Run cross-platform tests
        run: |
          poetry run pytest tests/unit/test_imports.py tests/unit/test_core.py -v --cov=tapo_camera_mcp --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: cross-platform,${{ matrix.os }},${{ matrix.python-version }}

  # ============================================================================
  # CONTAINER TESTS
  # ============================================================================

  container-tests:
    name: Container Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test container
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: false
          tags: tapo-camera-mcp:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test container startup
        run: |
          docker run --rm -d --name test-container -p 8000:8000 tapo-camera-mcp:test
          sleep 30
          docker logs test-container
          curl -f http://localhost:8000/api/health || exit 1
          docker stop test-container

      - name: Run containerized tests
        run: |
          docker run --rm -v $(pwd):/app -w /app tapo-camera-mcp:test \
            python -m pytest tests/unit/test_imports.py -v

  # ============================================================================
  # DEPLOYMENT TESTS
  # ============================================================================

  deployment-tests:
    name: Deployment Tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: poetry install --with dev --no-interaction

      - name: Build distribution packages
        run: |
          poetry build
          ls -la dist/

      - name: Test package installation
        run: |
          python -m pip install --user dist/*.whl
          python -c "import tapo_camera_mcp; print('Package installed successfully')"

      - name: Test CLI commands
        run: |
          tapo-camera-mcp --help || echo "CLI not available in test environment"

  # ============================================================================
  # COMPREHENSIVE TEST REPORT
  # ============================================================================

  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    if: always()
    needs: [quality-checks, unit-tests, integration-tests, api-contract-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download test artifacts
        uses: actions/download-artifact@v3

      - name: Generate comprehensive test report
        run: |
          python scripts/generate_test_report.py \
            --quality-results quality-checks-results \
            --unit-results unit-tests-results \
            --integration-results integration-test-results \
            --api-results api-documentation \
            --output comprehensive-test-report.html

      - name: Upload test report
        uses: actions/upload-artifact@v3
        with:
          name: comprehensive-test-report
          path: comprehensive-test-report.html

  # ============================================================================
  # DEPLOYMENT
  # ============================================================================

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && needs.test-report.result == 'success'
    needs: [test-report]
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Build and push Docker image
        run: |
          aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
          docker build -t tapo-camera-mcp:${{ github.sha }} .
          docker tag tapo-camera-mcp:${{ github.sha }} ${{ secrets.ECR_REGISTRY }}/tapo-camera-mcp:${{ github.sha }}
          docker push ${{ secrets.ECR_REGISTRY }}/tapo-camera-mcp:${{ github.sha }}

      - name: Deploy to production
        run: |
          aws ecs update-service \
            --cluster ${{ secrets.ECS_CLUSTER }} \
            --service ${{ secrets.ECS_SERVICE }} \
            --force-new-deployment \
            --task-definition ${{ secrets.ECS_TASK_DEFINITION }}

      - name: Run post-deployment health checks
        run: |
          # Wait for deployment to complete
          aws ecs wait services-stable \
            --cluster ${{ secrets.ECS_CLUSTER }} \
            --services ${{ secrets.ECS_SERVICE }}

          # Run health checks
          curl -f ${{ secrets.HEALTH_CHECK_URL }} || exit 1

  # ============================================================================
  # NOTIFICATIONS
  # ============================================================================

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    if: always()
    needs: [quality-checks, unit-tests, integration-tests, deploy]
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.24.0
        if: always()
        with:
          payload: |
            {
              "text": "Tapo Camera MCP CI/CD Results",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üè† Tapo Camera MCP CI/CD Results"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Status:* ${{ needs.quality-checks.result == 'success' && needs.unit-tests.result == 'success' && needs.integration-tests.result == 'success' && '‚úÖ All Passed' || '‚ùå Some Failed' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:* ${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:* ${{ github.sha }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Triggered by:* ${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Quality Checks:* ${{ needs.quality-checks.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}\n*Unit Tests:* ${{ needs.unit-tests.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}\n*Integration Tests:* ${{ needs.integration-tests.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}\n*Deployment:* ${{ needs.deploy.result == 'success' && '‚úÖ Successful' || needs.deploy.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create GitHub issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `CI/CD Pipeline Failed - ${context.runNumber}`,
              body: `## CI/CD Pipeline Failure

            **Run:** #${context.runNumber}
            **Branch:** ${context.ref}
            **Commit:** ${context.sha}
            **Triggered by:** ${context.actor}

            ### Failed Jobs:
            - Quality Checks: ${{ needs.quality-checks.result }}
            - Unit Tests: ${{ needs.unit-tests.result }}
            - Integration Tests: ${{ needs.integration-tests.result }}

            ### Actions Required:
            1. Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${context.runId}}) for detailed logs
            2. Review failed tests and fix issues
            3. Ensure all dependencies are properly configured
            4. Verify test environment setup

            ### Recent Commits:
            \`\`\`
            ${{ github.event.head_commit.message }}
            \`\`\`

            /cc @${context.actor}`,
              labels: ['bug', 'ci-failure', 'needs-attention']
            })