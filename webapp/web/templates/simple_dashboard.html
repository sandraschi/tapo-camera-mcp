{% extends "base.html" %}

{% block title %}Dashboard - Home Security MCP{% endblock %}

{% block extra_css %}
<style>
    .card {
        background: white;
        border-radius: 0.5rem;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border-color);
    }

    /* Camera thumbnail styles - compact for dashboard */
    .camera-thumb-link {
        display: block;
        width: 200px;
        height: 150px;
    }
    .camera-thumb-container {
        width: 200px;
        height: 150px;
    }
    .camera-thumb-img {
        width: 200px;
        height: 150px;
        object-fit: cover;
    }
    .camera-thumb-fallback {
        width: 200px;
        height: 150px;
        display: none;
        align-items: center;
        justify-content: center;
        background: var(--text-color);
        color: var(--gray-400);
        font-size: 36px;
    }

    @media (max-width: 768px) {
        .camera-thumb-link,
        .camera-thumb-container,
        .camera-thumb-img,
        .camera-thumb-fallback {
            width: 160px;
            height: 120px;
        }
        .camera-thumb-fallback {
            font-size: 28px;
        }
    }

    .security-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #dc2626;
    }

    .status-online { border-left-color: #16a34a; }
    .status-offline { border-left-color: var(--muted-text); }
    .status-alert { border-left-color: #dc2626; }

    .alert-critical { border-left-color: #dc2626; background-color: #fef2f2; }
    .alert-warning { border-left-color: #d97706; background-color: #fffbeb; }
    .alert-info { border-left-color: var(--primary-blue-dark); background-color: #eff6ff; }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    @media screen and (max-width: 768px) {
        .stats-grid {
            display: grid !important;
            grid-template-columns: 1fr 1fr !important;
            gap: 0.75rem !important;
        }
        .stat-card {
            padding: 0.75rem !important;
        }
        .stat-card .text-3xl {
            font-size: 1.5rem !important;
        }
        .stat-card .text-lg {
            font-size: 0.9rem !important;
        }
        .stat-card .text-sm {
            font-size: 0.75rem !important;
        }
    }

    .stat-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        text-align: center;
        text-decoration: none;
        color: inherit;
        display: block;
    }

    [data-theme="dark"] {
        --bg-color: var(--text-color);
        --text-color: var(--card-bg);
        --card-bg: var(--text-color);
        --border-color: var(--gray-600);
    }

    [data-theme="dark"] body {
        background-color: var(--bg-color);
        color: var(--text-color);
    }

    [data-theme="dark"] .card,
    [data-theme="dark"] .security-card,
    [data-theme="dark"] .stat-card {
        background-color: var(--card-bg);
        color: var(--text-color);
        border-color: var(--border-color);
    }
</style>
{% endblock %}

{% block content %}
    <div class="dashboard-content">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">üè† Home Security Dashboard</h1>
            <a href="/settings" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                ‚öôÔ∏è Settings
            </a>
        </div>

        <!-- Quick Links -->
        <div class="stats-grid mb-6">
            <a href="/lighting" class="stat-card hover:shadow-lg transition-shadow cursor-pointer">
                <div class="text-3xl mb-1">üí°</div>
                <div class="text-lg font-bold text-yellow-600">Lighting</div>
                <div class="text-sm text-gray-600">18 Hue lights</div>
            </a>

            <a href="/weather" class="stat-card hover:shadow-lg transition-shadow cursor-pointer">
                <div class="text-3xl mb-1">üå§Ô∏è</div>
                <div class="text-lg font-bold text-blue-600">Weather</div>
                <div class="text-sm text-gray-600">Netatmo + Vienna</div>
            </a>

            <a href="/energy" class="stat-card hover:shadow-lg transition-shadow cursor-pointer">
                <div class="text-3xl mb-1">‚ö°</div>
                <div class="text-lg font-bold text-green-600">Energy</div>
                <div class="text-sm text-gray-600">3 Tapo P115 plugs</div>
            </a>

            <a href="/cameras" class="stat-card hover:shadow-lg transition-shadow cursor-pointer">
                <div class="text-3xl mb-1">üìπ</div>
                <div class="text-lg font-bold text-purple-600">Cameras</div>
                <div class="text-sm text-gray-600">View feeds</div>
            </a>
        </div>

        <!-- Vienna Public Alerts -->
        <div class="card mb-6" id="vienna-alerts-section">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">ALERT Vienna Public Alerts</h3>
                <button onclick="refreshAlerts()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div id="alerts-container">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin text-gray-400 text-2xl"></i>
                    <p class="text-gray-500 mt-2">Loading alerts...</p>
                </div>
            </div>
        </div>

        <!-- Camera Thumbnails -->
        <div class="card mb-6" id="camera-thumbnails">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-semibold">üìπ Cameras</h3>
                <a href="/cameras" class="text-blue-600 hover:text-blue-800 text-sm">View All ‚Üí</a>
            </div>
            <div id="camera-row" style="display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px; flex-wrap: nowrap;">
                <div style="text-align: center; color: var(--muted-text); font-size: 14px; padding: 16px 0; width: 100%;">
                    <i class="fas fa-spinner fa-spin"></i> Loading cameras...
                </div>
            </div>
        </div>

        <!-- Security Systems -->
        <div class="card mt-6" id="security-section">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">üõ°Ô∏è Security & Safety</h3>
                <button onclick="loadRingStatus()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>

            <!-- Ring Alarm Status -->
            <div id="ring-alarm-section" class="mb-4">
                <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-indigo-500">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">üîî</span>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">Ring Alarm</h4>
                            <p class="text-sm text-gray-600" id="ring-alarm-mode">Loading...</p>
                        </div>
                        <div class="text-right" id="ring-alarm-controls">
                            <div class="flex gap-1">
                                <button onclick="setRingMode('disarmed')" class="px-2 py-1 rounded text-xs font-semibold bg-gray-200 hover:bg-gray-300" id="btn-disarmed">Off</button>
                                <button onclick="setRingMode('home')" class="px-2 py-1 rounded text-xs font-semibold bg-gray-200 hover:bg-blue-300" id="btn-home">Home</button>
                                <button onclick="setRingMode('away')" class="px-2 py-1 rounded text-xs font-semibold bg-gray-200 hover:bg-red-300" id="btn-away">Away</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ring Doorbell -->
            <div id="ring-doorbell-section" class="mb-4 hidden">
                <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-yellow-500">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">üö™</span>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">Ring Doorbell</h4>
                            <p class="text-sm text-gray-600" id="ring-doorbell-status">-</p>
                        </div>
                        <div class="text-right" id="ring-doorbell-battery">
                            <!-- Battery shown here -->
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-500" id="ring-last-event">
                        Last event: -
                    </div>
                </div>
            </div>

            <!-- Fire & CO Alarms -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <!-- Smoke/Fire Alarm -->
                <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-orange-500">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">üî•</span>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">Smoke & Fire</h4>
                            <p class="text-sm text-gray-600">Nest Protect</p>
                        </div>
                        <div class="text-right">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                OK OK
                            </span>
                        </div>
                    </div>
                </div>

                <!-- CO Alarm -->
                <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-purple-500">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">üí®</span>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">Carbon Monoxide</h4>
                            <p class="text-sm text-gray-600">Nest Protect</p>
                        </div>
                        <div class="text-right">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                OK OK
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ring Sensors -->
            <div id="ring-sensors-section" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Placeholder - will be populated by JS -->
            </div>

            <!-- Status Banner -->
            <div class="mt-4 bg-green-50 border border-green-200 rounded-lg p-3 flex items-center gap-3" id="security-status-banner">
                <span class="text-2xl">‚úÖ</span>
                <div>
                    <span class="font-semibold text-green-800">All Systems Normal</span>
                    <span class="text-green-600 text-sm ml-2">No alerts</span>
                </div>
            </div>
        </div>

        <div class="mt-8 text-center">
            <a href="/help" class="text-blue-600 hover:text-blue-800 underline">
                <i class="fas fa-question-circle mr-2"></i>Help & Documentation
            </a>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Load alerts, cameras, and Ring status on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadAlerts();
        loadCameras();
        loadRingStatus();
    });

    // Ring Alarm Functions
    async function loadRingStatus() {
        try {
            const response = await fetch('/api/ring/summary');
            if (!response.ok) throw new Error('Failed to fetch Ring status');

            const data = await response.json();
            renderRingStatus(data);
        } catch (error) {
            console.error('Error loading Ring status:', error);
            document.getElementById('ring-alarm-mode').textContent = 'Not connected';
        }
    }

    function renderRingStatus(data) {
        const modeEl = document.getElementById('ring-alarm-mode');
        const controlsEl = document.getElementById('ring-alarm-controls');
        const doorbellSection = document.getElementById('ring-doorbell-section');
        const sensorsSection = document.getElementById('ring-sensors-section');
        const lastEventEl = document.getElementById('ring-last-event');
        const statusBanner = document.getElementById('security-status-banner');

        if (!data.initialized) {
            if (data.two_fa_pending) {
                modeEl.textContent = '2FA code required';
                controlsEl.innerHTML = `
                    <input type="text" id="ring-2fa-code" placeholder="Enter code" class="px-2 py-1 text-xs border rounded w-20">
                    <button onclick="submitRing2FA()" class="px-2 py-1 rounded text-xs font-semibold bg-blue-500 text-white">Submit</button>
                `;
            } else {
                modeEl.textContent = 'Not connected';
                controlsEl.innerHTML = `<span class="text-xs text-gray-500">Configure in settings</span>`;
            }
            return;
        }

        // Render alarm mode
        if (data.alarm) {
            const modeNames = { 'none': 'Disarmed', 'some': 'Home', 'all': 'Away' };
            const modeColors = { 'none': 'gray', 'some': 'blue', 'all': 'red' };
            const currentMode = data.alarm.mode;
            modeEl.textContent = `Mode: ${modeNames[currentMode] || 'Unknown'}`;

            // Highlight active mode button
            ['disarmed', 'home', 'away'].forEach(m => {
                const btn = document.getElementById(`btn-${m}`);
                if (btn) {
                    const isActive = (m === 'disarmed' && currentMode === 'none') ||
                                   (m === 'home' && currentMode === 'some') ||
                                   (m === 'away' && currentMode === 'all');
                    if (isActive) {
                        btn.classList.remove('bg-gray-200');
                        btn.classList.add(m === 'away' ? 'bg-red-500' : m === 'home' ? 'bg-blue-500' : 'bg-green-500', 'text-white');
                    } else {
                        btn.classList.remove('bg-red-500', 'bg-blue-500', 'bg-green-500', 'text-white');
                        btn.classList.add('bg-gray-200');
                    }
                }
            });

            // Render sensors
            if (data.alarm.sensors && data.alarm.sensors.length > 0) {
                let sensorHtml = '';
                const contactSensors = data.alarm.sensors.filter(s => s.sensor_type === 'contact');
                const motionSensors = data.alarm.sensors.filter(s => s.sensor_type === 'motion');
                const openDoors = contactSensors.filter(s => s.is_open);

                // Contact Sensors
                if (contactSensors.length > 0) {
                    sensorHtml += `
                        <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-blue-500">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">üö™</span>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800">Entry Points</h4>
                                    <p class="text-sm text-gray-600">Ring Sensors</p>
                                </div>
                                <div class="text-right">
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${openDoors.length > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                        ${openDoors.length > 0 ? openDoors.length + ' Open' : 'All Secured'}
                                    </span>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-gray-500">
                                ${contactSensors.length} sensor${contactSensors.length !== 1 ? 's' : ''}
                                ${openDoors.length > 0 ? ' ‚Ä¢ ' + openDoors.map(s => s.name).join(', ') : ''}
                            </div>
                        </div>
                    `;
                }

                // Motion Sensors
                if (motionSensors.length > 0) {
                    sensorHtml += `
                        <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-cyan-500">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">MONITOR</span>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800">Motion Detection</h4>
                                    <p class="text-sm text-gray-600">Ring Sensors</p>
                                </div>
                                <div class="text-right">
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">
                                        Monitoring
                                    </span>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-gray-500">
                                ${motionSensors.length} sensor${motionSensors.length !== 1 ? 's' : ''}
                            </div>
                        </div>
                    `;
                }

                sensorsSection.innerHTML = sensorHtml;

                // Update status banner based on alarm state
                if (data.alarm.is_armed) {
                    statusBanner.className = 'mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center gap-3';
                    statusBanner.innerHTML = `
                        <span class="text-2xl">üõ°Ô∏è</span>
                        <div>
                            <span class="font-semibold text-blue-800">System Armed</span>
                            <span class="text-blue-600 text-sm ml-2">${modeNames[currentMode]} mode</span>
                        </div>
                    `;
                } else if (openDoors.length > 0) {
                    statusBanner.className = 'mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-3 flex items-center gap-3';
                    statusBanner.innerHTML = `
                        <span class="text-2xl">WARNING</span>
                        <div>
                            <span class="font-semibold text-yellow-800">Entry Point Open</span>
                            <span class="text-yellow-600 text-sm ml-2">${openDoors.map(s => s.name).join(', ')}</span>
                        </div>
                    `;
                }
            }
        }

        // Render doorbells
        if (data.doorbells && data.doorbells.length > 0) {
            doorbellSection.classList.remove('hidden');
            const doorbell = data.doorbells[0];
            document.getElementById('ring-doorbell-status').textContent = doorbell.kind || 'Video Doorbell';
            const batteryEl = document.getElementById('ring-doorbell-battery');
            if (doorbell.battery_level) {
                batteryEl.innerHTML = `<span class="text-sm">üîã ${doorbell.battery_level}%</span>`;
            }
        }

        // Last event
        if (data.last_event) {
            const eventTime = new Date(data.last_event.timestamp);
            const timeStr = eventTime.toLocaleTimeString('de-AT', { hour: '2-digit', minute: '2-digit' });
            const eventType = data.last_event.event_type === 'ding' ? 'üîî Doorbell' : 'üèÉ Motion';
            lastEventEl.textContent = `Last event: ${eventType} at ${timeStr}`;
        }
    }

    async function setRingMode(mode) {
        const btn = document.getElementById(`btn-${mode}`);
        if (btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }

        try {
            const response = await fetch('/api/ring/alarm/mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode: mode })
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.detail || 'Failed to set mode');
            }

            // Reload Ring status
            await loadRingStatus();
        } catch (error) {
            console.error('Error setting Ring mode:', error);
            alert('Failed to set alarm mode: ' + error.message);
            loadRingStatus(); // Restore button state
        }
    }

    async function submitRing2FA() {
        const codeInput = document.getElementById('ring-2fa-code');
        const code = codeInput.value.trim();
        if (!code) return;

        try {
            const response = await fetch('/api/ring/auth/2fa', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code })
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.detail || 'Invalid code');
            }

            // Reload Ring status
            await loadRingStatus();
        } catch (error) {
            console.error('Ring 2FA error:', error);
            alert('2FA failed: ' + error.message);
        }
    }

    // Auto-refresh Ring status every minute
    setInterval(loadRingStatus, 60 * 1000);
    
    async function loadCameras() {
        const container = document.getElementById('camera-row');
        
        try {
            const response = await fetch('/api/cameras');
            if (!response.ok) throw new Error('Failed to fetch cameras');
            
            const data = await response.json();
            const cameras = data.cameras || [];
            
            if (cameras.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--muted-text); font-size: 14px; padding: 8px 0; width: 100%;">
                        No cameras configured. <a href="/cameras" style="color: var(--primary-blue-dark); text-decoration: underline;">Add cameras</a>
                    </div>
                `;
                return;
            }
            
            // Build live stream previews
            let html = '';
            for (const cam of cameras) {
                const name = cam.name || cam.id || 'Camera';
                const status = cam.status === 'online' ? 'üü¢' : 'CRITICAL';
                const streamUrl = `/api/cameras/${encodeURIComponent(name)}/stream`;
                
                html += `
                    <a href="/cameras" class="camera-thumb-link" style="flex-shrink: 0; text-decoration: none;">
                        <div class="camera-thumb-container" style="background: var(--text-color); border-radius: 8px; overflow: hidden; position: relative;">
                            <img src="${streamUrl}" 
                                 alt="${name}" 
                                 class="camera-thumb-img"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="camera-thumb-fallback">
                                üìπ
                            </div>
                            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); padding: 8px 12px;">
                                <span style="color: white; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;">${status} ${name}</span>
                            </div>
                        </div>
                    </a>
                `;
            }
            
            container.innerHTML = html;
            
        } catch (error) {
            console.error('Error loading cameras:', error);
            container.innerHTML = `
                <div style="text-align: center; color: var(--muted-text); font-size: 14px; padding: 8px 0; width: 100%;">
                    <a href="/cameras" style="color: var(--primary-blue-dark); text-decoration: underline;">View cameras</a>
                </div>
            `;
        }
    }
    
    // Refresh alerts every 5 minutes (don't reload full page for alerts)
    setInterval(loadAlerts, 5 * 60 * 1000);
    
    async function loadAlerts() {
        const container = document.getElementById('alerts-container');
        
        try {
            const response = await fetch('/alerts/summary');
            if (!response.ok) throw new Error('Failed to fetch alerts');
            
            const data = await response.json();
            renderAlerts(data);
        } catch (error) {
            console.error('Error loading alerts:', error);
            container.innerHTML = `
                <div class="text-center py-4">
                    <p class="text-gray-500">
                        <i class="fas fa-exclamation-triangle text-yellow-500"></i> 
                        Unable to load alerts. <a href="#" onclick="loadAlerts(); return false;" class="text-blue-600 hover:underline">Retry</a>
                    </p>
                </div>
            `;
        }
    }
    
    async function refreshAlerts() {
        const container = document.getElementById('alerts-container');
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-spinner fa-spin text-gray-400 text-2xl"></i>
                <p class="text-gray-500 mt-2">Refreshing alerts...</p>
            </div>
        `;
        
        try {
            const response = await fetch('/alerts/refresh');
            if (!response.ok) throw new Error('Failed to refresh');
            
            const data = await response.json();
            // Convert to summary format
            const summary = {
                total_alerts: data.total,
                highest_severity: data.alerts.length > 0 ? data.alerts[0].severity : 'unknown',
                highest_severity_color: data.alerts.length > 0 ? data.alerts[0].severity_color : 'var(--gray-400)',
                highest_severity_icon: data.alerts.length > 0 ? data.alerts[0].severity_icon : 'OK',
                alerts: data.alerts.slice(0, 5),
                status: data.total === 0 ? 'ok' : 'warning'
            };
            renderAlerts(summary);
        } catch (error) {
            console.error('Error refreshing alerts:', error);
            loadAlerts(); // Fallback to cached
        }
    }
    
    function renderAlerts(data) {
        const container = document.getElementById('alerts-container');
        
        if (data.total_alerts === 0) {
            container.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                    <div class="text-4xl mb-2">‚úÖ</div>
                    <h4 class="font-semibold text-green-800">All Clear</h4>
                    <p class="text-green-600 text-sm">No active weather or emergency alerts for Vienna</p>
                    <p class="text-green-500 text-xs mt-2">Sources: GeoSphere Austria, Meteoalarm</p>
                </div>
            `;
            return;
        }
        
        // Build alerts HTML
        let alertsHtml = `
            <div class="flex gap-4">
                <div class="flex-shrink-0 text-center px-4 py-3 rounded-lg" style="background: ${data.highest_severity_color};">
                    <div class="text-2xl">${data.highest_severity_icon}</div>
                    <div class="text-2xl font-bold text-white">${data.total_alerts}</div>
                    <div class="text-xs text-white opacity-80">Alert${data.total_alerts !== 1 ? 's' : ''}</div>
                </div>
                <div class="flex-1 space-y-2">
        `;
        
        for (const alert of data.alerts) {
            const typeIcon = getAlertTypeIcon(alert.alert_type);
            alertsHtml += `
                <div class="bg-gray-50 p-3 rounded border-l-4" style="border-left-color: ${alert.severity_color};">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">${typeIcon}</span>
                        <div class="flex-1">
                            <div class="font-medium text-gray-800 text-sm">${escapeHtml(alert.title)}</div>
                            <div class="text-xs text-gray-500">${alert.region} ‚Ä¢ ${alert.source === 'geosphere' ? 'GeoSphere' : 'Meteoalarm'}</div>
                        </div>
                        <span class="text-sm" title="${alert.severity}">${alert.severity_icon}</span>
                    </div>
                    ${alert.description ? `<p class="text-gray-600 text-xs mt-1 ml-7">${escapeHtml(truncate(alert.description, 120))}</p>` : ''}
                </div>
            `;
        }
        
        alertsHtml += `
                </div>
            </div>
            <div class="text-center text-gray-400 text-xs mt-3">
                Last updated: ${new Date().toLocaleTimeString('de-AT')} ‚Ä¢ Sources: GeoSphere Austria, Meteoalarm
            </div>
        `;
        
        container.innerHTML = alertsHtml;
    }
    
    function getAlertTypeIcon(type) {
        const icons = {
            'weather': 'üå§Ô∏è', 'storm': 'üå™Ô∏è', 'wind': 'üí®', 'rain': 'üåßÔ∏è',
            'snow': '‚ùÑÔ∏è', 'ice': 'üßä', 'fog': 'üå´Ô∏è', 'heat': 'üå°Ô∏è',
            'cold': 'ü•∂', 'thunderstorm': '‚õàÔ∏è', 'flood': 'üåä', 'fire': 'üî•'
        };
        return icons[type] || 'WARNING';
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function truncate(text, maxLength) {
        if (!text || text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }
</script>
{% endblock %}



