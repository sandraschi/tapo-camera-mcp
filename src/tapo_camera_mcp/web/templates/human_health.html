{% extends "base.html" %}

{% block title %}Human Health - Tapo Camera MCP{% endblock %}

{% block extra_css %}
<style>
    .human-health-dashboard {
        padding: 20px;
    }

    .health-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .health-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
    }

    .health-card h3 {
        margin: 0 0 16px 0;
        color: #1f2937;
        font-size: 18px;
        font-weight: 600;
    }

    .health-value {
        font-size: 32px;
        font-weight: 700;
        color: #10b981;
        margin-bottom: 8px;
    }

    .health-unit {
        color: #6b7280;
        font-size: 14px;
    }

    .health-status {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 12px;
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .status-normal {
        background-color: #10b981;
    }

    .status-warning {
        background-color: #f59e0b;
    }

    .status-critical {
        background-color: #ef4444;
    }

    .devices-section {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
    }

    .device-card {
        background: #f9fafb;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 16px;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
    }

    .device-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .device-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .device-name {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
    }

    .device-location {
        color: #6b7280;
        font-size: 14px;
    }

    .device-status {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .device-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }

    .metric {
        text-align: center;
    }

    .metric-value {
        font-size: 20px;
        font-weight: 600;
        color: #1f2937;
    }

    .metric-label {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
    }

    .device-controls {
        display: flex;
        gap: 12px;
        margin-top: 16px;
    }

    .btn {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-primary {
        background-color: #3b82f6;
        color: white;
    }

    .btn-primary:hover {
        background-color: #2563eb;
    }

    .btn-secondary {
        background-color: #e5e7eb;
        color: #374151;
    }

    .btn-secondary:hover {
        background-color: #d1d5db;
    }

    .btn-danger {
        background-color: #ef4444;
        color: white;
    }

    .btn-danger:hover {
        background-color: #dc2626;
    }

    .setup-notice {
        background: #fef3c7;
        border: 1px solid #f59e0b;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
    }

    .setup-notice h3 {
        margin: 0 0 12px 0;
        color: #92400e;
        font-size: 18px;
    }

    .setup-notice p {
        margin: 0;
        color: #92400e;
    }

    .setup-notice a {
        color: #92400e;
        text-decoration: underline;
        font-weight: 500;
    }

    .setup-notice a:hover {
        color: #78350f;
    }

    .health-alerts {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        margin-top: 20px;
    }

    .alert-item {
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .alert-critical {
        border-left-color: #dc2626 !important;
        background: #fee2e2 !important;
    }

    .alert-warning {
        border-left-color: #f59e0b !important;
        background: #fef3c7 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="human-health-dashboard">
    <div class="page-header">
        <h1>üë§ Human Health</h1>
        <p>Monitor and manage personal health devices and vital signs</p>
    </div>

    <!-- Setup Notice -->
    <div class="setup-notice">
        <h3>üè• Set Up Health Devices</h3>
        <p>Connect your medical devices for continuous health monitoring. Configure blood pressure monitors, glucose meters, and other health gadgets.</p>
        <a href="/onboarding">Setup Health Devices ‚Üí</a>
    </div>

    <!-- Health Overview -->
    <div class="health-overview">
        <div class="health-card">
            <h3>‚ù§Ô∏è Heart Rate</h3>
            <div class="health-value">72</div>
            <div class="health-unit">BPM</div>
            <div class="health-status">
                <div class="status-indicator status-normal"></div>
                <span>Normal</span>
            </div>
        </div>

        <div class="health-card">
            <h3>ü©∏ Blood Pressure</h3>
            <div class="health-value">120/80</div>
            <div class="health-unit">mmHg</div>
            <div class="health-status">
                <div class="status-indicator status-normal"></div>
                <span>Optimal</span>
            </div>
        </div>

        <div class="health-card">
            <h3>ü©∏ Blood Glucose</h3>
            <div class="health-value">95</div>
            <div class="health-unit">mg/dL</div>
            <div class="health-status">
                <div class="status-indicator status-normal"></div>
                <span>Normal</span>
            </div>
        </div>

        <div class="health-card">
            <h3>üèÉ Activity Level</h3>
            <div class="health-value">8,450</div>
            <div class="health-unit">Steps Today</div>
            <div class="health-status">
                <div class="status-indicator status-normal"></div>
                <span>Good Progress</span>
            </div>
        </div>
    </div>

    <!-- Medical Devices Section -->
    <div class="devices-section">
        <h2>üè• Medical Devices</h2>
        <p>Monitor connected health and medical devices</p>

        <!-- Real Device Cards (populated via JavaScript) -->
        <div id="devices-container">
            <p>Loading medical devices...</p>
        </div>
    </div>

    <!-- Health Alerts Section -->
    <div class="health-alerts" id="alerts-section" style="display: none;">
        <h3>‚ö†Ô∏è Health Alerts</h3>
        <div id="alerts-container">
            <!-- Alerts will be populated here -->
        </div>
    </div>
</div>

<script>
// Global variables
let healthDevices = [];

// Load health devices
async function loadDevices() {
    try {
        console.log('Loading human health devices...');

        // For now, show placeholder devices since actual device integration would need hardware
        const devices = [
            {
                id: 'bp_monitor_1',
                name: 'Omron Blood Pressure Monitor',
                type: 'blood_pressure',
                location: 'Bedroom',
                last_reading: '120/80 mmHg',
                last_time: '2 hours ago',
                status: 'connected',
                battery: 85
            },
            {
                id: 'glucose_meter_1',
                name: 'Accu-Chek Glucose Monitor',
                type: 'glucose',
                location: 'Kitchen',
                last_reading: '95 mg/dL',
                last_time: '1 hour ago',
                status: 'connected',
                battery: 92
            },
            {
                id: 'fitness_tracker_1',
                name: 'Fitbit Charge 5',
                type: 'fitness',
                location: 'Wrist',
                last_reading: '8,450 steps',
                last_time: '5 minutes ago',
                status: 'connected',
                battery: 78
            },
            {
                id: 'scale_1',
                name: 'Withings Body Scale',
                type: 'scale',
                location: 'Bathroom',
                last_reading: '165 lbs',
                last_time: 'This morning',
                status: 'connected',
                battery: 100
            }
        ];

        healthDevices = devices;

        const container = document.getElementById('devices-container');

        if (!container) {
            console.error('devices-container element not found!');
            return;
        }

        console.log(`Found ${devices.length} health devices`);

        if (devices.length === 0) {
            container.innerHTML = '<p>No health devices found. Configure devices in settings.</p>';
            return;
        }

        // Render device cards
        console.log('Rendering health device cards...');
        const deviceCardsHtml = devices.map(device => createDeviceCard(device)).join('');

        container.innerHTML = deviceCardsHtml;
        console.log(`Rendered ${devices.length} health device cards`);

    } catch (error) {
        console.error('Error loading health devices:', error);
        const container = document.getElementById('devices-container');
        if (container) {
            container.innerHTML = '<p style="color: red;">Error loading health devices: ' + error.message + '</p>';
        }
    }
}

function createDeviceCard(device) {
    const isOnline = device.status === 'connected';
    const statusClass = isOnline ? 'status-normal' : 'status-offline';
    const statusText = isOnline ? 'Connected' : 'Disconnected';

    let icon = 'fas fa-heartbeat';
    let metrics = [];

    switch (device.type) {
        case 'blood_pressure':
            icon = 'fas fa-heartbeat';
            metrics = [
                { value: device.last_reading, label: 'Blood Pressure' },
                { value: device.battery + '%', label: 'Battery' },
                { value: device.last_time, label: 'Last Reading' }
            ];
            break;
        case 'glucose':
            icon = 'fas fa-tint';
            metrics = [
                { value: device.last_reading, label: 'Blood Glucose' },
                { value: device.battery + '%', label: 'Battery' },
                { value: device.last_time, label: 'Last Reading' }
            ];
            break;
        case 'fitness':
            icon = 'fas fa-running';
            metrics = [
                { value: device.last_reading, label: 'Steps Today' },
                { value: device.battery + '%', label: 'Battery' },
                { value: device.last_time, label: 'Last Sync' }
            ];
            break;
        case 'scale':
            icon = 'fas fa-weight';
            metrics = [
                { value: device.last_reading, label: 'Weight' },
                { value: device.battery + '%', label: 'Battery' },
                { value: device.last_time, label: 'Last Reading' }
            ];
            break;
        default:
            metrics = [
                { value: device.last_reading || 'N/A', label: 'Last Reading' },
                { value: device.battery + '%', label: 'Battery' },
                { value: device.last_time, label: 'Last Update' }
            ];
    }

    return `
        <div class="device-card">
            <div class="device-header">
                <div>
                    <div class="device-name"><i class="${icon}"></i> ${device.name}</div>
                    <div class="device-location">${device.location}</div>
                </div>
                <div class="device-status">
                    <div class="status-indicator ${statusClass}"></div>
                    <span>${statusText}</span>
                </div>
            </div>

            <div class="device-metrics">
                ${metrics.map(metric => `
                    <div class="metric">
                        <div class="metric-value">${metric.value}</div>
                        <div class="metric-label">${metric.label}</div>
                    </div>
                `).join('')}
            </div>

            <div class="device-controls">
                <button class="btn btn-primary" onclick="viewDeviceHistory('${device.id}')">History</button>
                <button class="btn btn-secondary" onclick="syncDevice('${device.id}')">Sync</button>
                <button class="btn btn-secondary" onclick="deviceSettings('${device.id}')">Settings</button>
            </div>
        </div>
    `;
}

// Device action functions
function viewDeviceHistory(deviceId) {
    const device = healthDevices.find(d => d.id === deviceId);
    if (device) {
        window.location.href = `/human-health?device=${deviceId}&view=history`;
    }
}

function syncDevice(deviceId) {
    const device = healthDevices.find(d => d.id === deviceId);
    if (device) {
        alert(`Syncing ${device.name}...`);
        // Implement sync logic here
    }
}

function deviceSettings(deviceId) {
    const device = healthDevices.find(d => d.id === deviceId);
    if (device) {
        window.location.href = `/settings?section=health-devices&device=${deviceId}`;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('Human health dashboard loaded');
    loadDevices();

    // Refresh every 30 seconds
    setInterval(loadDevices, 30000);
});
</script>
{% endblock %}