{% extends "base.html" %}

{% block title %}Cameras - Home Security MCP{% endblock %}

{% block extra_css %}
<style>
    .cameras-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .camera-card {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease-in-out;
    }

    .camera-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .camera-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .camera-name {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .status-online {
        background-color: #dcfce7;
        color: #166534;
    }

    .status-offline {
        background-color: #fef3c7;
        color: #92400e;
    }

    .status-error {
        background-color: #fee2e2;
        color: #991b1b;
    }

    .camera-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1.25rem;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
    }

    .detail-label {
        font-size: 0.75rem;
        font-weight: 500;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.25rem;
    }

    .detail-value {
        font-size: 0.875rem;
        color: #1f2937;
        font-weight: 500;
    }

    .capabilities-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .capability-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background-color: #f9fafb;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
    }

    .capability-icon {
        width: 1rem;
        height: 1rem;
        color: #6b7280;
    }

    .capability-supported .capability-icon {
        color: #16a34a;
    }

    .capability-name {
        font-size: 0.75rem;
        font-weight: 500;
        color: #374151;
    }

    .camera-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e5e7eb;
    }

    .action-button {
        padding: 0.4rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.8rem;
        font-weight: 500;
        text-decoration: none;
        white-space: nowrap;
        flex-shrink: 0;
        transition: all 0.2s ease-in-out;
        border: 1px solid #d1d5db;
        background-color: white;
        color: #374151;
    }

    .action-button:hover {
        background-color: #f9fafb;
        border-color: #9ca3af;
    }

    .action-button-primary {
        background-color: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .action-button-primary:hover {
        background-color: #2563eb;
        border-color: #2563eb;
    }

    .stats-overview {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e5e7eb;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #1f2937;
        line-height: 1;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
        margin-top: 0.25rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6b7280;
    }

    .empty-state-icon {
        width: 4rem;
        height: 4rem;
        margin: 0 auto 1rem;
        opacity: 0.5;
    }

    .empty-state-title {
        font-size: 1.125rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .empty-state-description {
        font-size: 0.875rem;
        color: #6b7280;
    }

    @media (max-width: 768px) {
        .cameras-grid {
            grid-template-columns: 1fr;
        }

        .camera-details {
            grid-template-columns: 1fr;
        }

        .capabilities-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .camera-actions {
            justify-content: center;
        }
        
        .action-button {
            padding: 0.35rem 0.6rem;
            font-size: 0.75rem;
        }
        
        .action-button svg {
            display: none;
        }
    }

    /* PTZ Control Panel Styles */
    .ptz-panel {
        margin-top: 1rem;
        padding: 1rem;
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        border-radius: 0.75rem;
        border: 1px solid #475569;
    }

    .ptz-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .ptz-title {
        color: #e2e8f0;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .ptz-close {
        background: none;
        border: none;
        color: #94a3b8;
        font-size: 1.25rem;
        cursor: pointer;
        padding: 0 0.25rem;
    }

    .ptz-close:hover {
        color: #f1f5f9;
    }

    .ptz-controls {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        justify-content: center;
    }

    .ptz-dpad {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
    }

    .ptz-middle-row {
        display: flex;
        gap: 0.25rem;
    }

    .ptz-btn {
        width: 44px;
        height: 44px;
        border: none;
        border-radius: 0.5rem;
        background: #3b82f6;
        color: white;
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
        user-select: none;
    }

    .ptz-btn:hover {
        background: #2563eb;
        transform: scale(1.05);
    }

    .ptz-btn:active {
        background: #1d4ed8;
        transform: scale(0.95);
    }

    .ptz-center {
        background: #64748b;
        font-size: 0.75rem;
    }

    .ptz-center:hover {
        background: #475569;
    }

    .ptz-zoom {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .ptz-zoom-in, .ptz-zoom-out {
        width: 50px;
        font-size: 0.85rem;
    }

    /* Audio Control Panel Styles */
    .audio-panel {
        margin-top: 1rem;
        padding: 1rem;
        background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%);
        border-radius: 0.75rem;
        border: 1px solid #3d5a7f;
    }

    .audio-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .audio-title {
        color: #e2e8f0;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .audio-close {
        background: none;
        border: none;
        color: #94a3b8;
        font-size: 1.25rem;
        cursor: pointer;
        padding: 0 0.25rem;
    }

    .audio-close:hover {
        color: #f1f5f9;
    }

    .audio-content {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .audio-status {
        background: rgba(0, 0, 0, 0.2);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        text-align: center;
        color: #94a3b8;
        font-size: 0.85rem;
    }

    .audio-controls {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: center;
    }

    .audio-btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        background: rgba(255, 255, 255, 0.15);
        color: white;
    }

    .audio-btn:hover {
        background: rgba(255, 255, 255, 0.25);
    }

    .audio-btn-primary {
        background: #3b82f6;
    }

    .audio-btn-primary:hover {
        background: #2563eb;
    }

    .audio-btn-vlc {
        background: #ff6600;
    }

    .audio-btn-vlc:hover {
        background: #e55c00;
    }

    .audio-warning {
        background: rgba(251, 191, 36, 0.15);
        border: 1px solid rgba(251, 191, 36, 0.3);
        border-radius: 0.5rem;
        padding: 0.75rem;
        font-size: 0.8rem;
        color: #fde68a;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Cameras</h1>
        <p class="text-gray-600">Manage and monitor your security cameras</p>
    </div>

    <!-- Stats Overview -->
    <div class="stats-overview">
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value">{{ total_cameras }}</div>
                <div class="stat-label">Total Cameras</div>
            </div>
            <div class="stat-item">
                <div class="stat-value text-green-600">{{ online_cameras }}</div>
                <div class="stat-label">Online</div>
            </div>
            <div class="stat-item">
                <div class="stat-value text-yellow-600">{{ total_cameras - online_cameras }}</div>
                <div class="stat-label">Offline</div>
            </div>
            <div class="stat-item">
                <div class="stat-value text-blue-600">{{ total_cameras }}</div>
                <div class="stat-label">Configured</div>
            </div>
        </div>
    </div>

    <!-- Cameras Grid -->
    {% if cameras %}
    <div class="cameras-grid">
        {% for camera in cameras %}
        <div class="camera-card">
            <!-- Camera Header -->
            <div class="camera-header">
                <h3 class="camera-name">{{ camera.name }}</h3>
                <span class="status-badge status-{{ 'online' if (camera.status == 'online' or (camera.status is mapping and camera.status.get('connected'))) else 'offline' if camera.status == 'offline' else 'error' }}">
                    {% if camera.status is mapping %}
                        {{ 'Online' if camera.status.get('connected') else 'Offline' }}
                    {% else %}
                        {{ (camera.status|string|title) if camera.status else 'Unknown' }}
                    {% endif %}
                </span>
            </div>

            <!-- Teams/Webcam Blocking Warning -->
            {% if camera.teams_blocked or (camera.warning and ('teams' in camera.warning.lower() or 'in use' in camera.warning.lower() or 'locked' in camera.warning.lower())) %}
            <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.25rem;">‚ö†Ô∏è</span>
                    <strong style="color: #92400e;">Camera Blocked by Another Application</strong>
                </div>
                <p style="color: #78350f; margin: 0.5rem 0; font-size: 0.9rem;">
                    {{ camera.error_message or camera.warning or 'This USB camera is currently locked by Microsoft Teams, Zoom, Skype, or another video application.' }}
                </p>
                <p style="color: #78350f; margin: 0.5rem 0 0 0; font-size: 0.85rem;">
                    <strong>üí° Solution:</strong> Close Microsoft Teams, Zoom, or other video applications that are using the camera, then refresh this page.
                </p>
            </div>
            {% endif %}

            <!-- Camera Details + Thumbnail -->
            <div class="camera-details">
                <div class="detail-item">
                    <span class="detail-label">Type</span>
                    <span class="detail-value">{{ camera.type|title }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Model</span>
                    <span class="detail-value">{{ camera.model|default('Unknown') }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Resolution</span>
                    <span class="detail-value">{{ camera.resolution|default('Unknown') }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Firmware</span>
                    <span class="detail-value">{{ camera.firmware|default('Unknown') }}</span>
                </div>
            </div>

            <!-- Live Thumbnail (160x160) - Always show, try to load snapshot -->
            <div style="margin-top: 0.75rem; display: flex; gap: 0.75rem; align-items: center;">
                <div style="width: 160px; height: 160px; border-radius: 0.5rem; overflow: hidden; border: 1px solid #e5e7eb; background:#000; position: relative;">
                    <img src="/api/cameras/{{ camera.name or camera.id }}/snapshot"
                         alt="{{ camera.name }}"
                         style="width: 100%; height: 100%; object-fit: cover;"
                         onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';"
                         onload="this.nextElementSibling.style.display='none';">
                    <div style="width: 100%; height: 100%; display: none; align-items: center; justify-content: center; color: #9ca3af; font-size: 0.75rem; position: absolute; top: 0; left: 0;">
                        Camera Offline
                    </div>
                </div>
                <div style="font-size: 0.8rem; color: #6b7280;">
                    <div>Live thumbnail (click stream button below for full view).</div>
                    <div style="margin-top: 0.25rem;">USB webcam will appear first, followed by Tapo, doorcam, and Petcube.</div>
                </div>
            </div>

            <!-- Capabilities -->
            <div class="capabilities-grid">
                <div class="capability-item {% if camera.ptz_capable %}capability-supported{% endif %}">
                    <svg class="capability-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.293l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="capability-name">PTZ</span>
                </div>
                <div class="capability-item {% if camera.audio_capable %}capability-supported{% endif %}">
                    <svg class="capability-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.617.816L4.414 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.414l3.969-3.816a1 1 0 011.234 0zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="capability-name">Audio</span>
                </div>
                <div class="capability-item {% if camera.streaming_capable %}capability-supported{% endif %}">
                    <svg class="capability-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm3 7a1 1 0 011-1h.01a1 1 0 110 2H8a1 1 0 01-1-1zm3-1a1 1 0 100 2h.01a1 1 0 100-2H10zm-2 4a1 1 0 011-1h.01a1 1 0 110 2H9a1 1 0 01-1-1zm6-4a1 1 0 100 2h.01a1 1 0 100-2H14zm-2 4a1 1 0 011-1h.01a1 1 0 110 2H12a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="capability-name">Streaming</span>
                </div>
                <div class="capability-item capability-supported">
                    <svg class="capability-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6zm2 2a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="capability-name">Capture</span>
                </div>
            </div>

            <!-- Status Indicators -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-4 text-sm">
                    <div class="flex items-center gap-1">
                        <span class="font-medium">Stream:</span>
                        <span class="w-3 h-3 rounded-full {{ 'bg-green-500' if camera.streaming_capable else 'bg-red-500' }}"></span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="font-medium">Audio:</span>
                        <span class="w-3 h-3 rounded-full {{ 'bg-green-500' if camera.audio_capable else 'bg-red-500' }}"></span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="font-medium">PTZ:</span>
                        <span class="w-3 h-3 rounded-full {{ 'bg-green-500' if camera.ptz_capable else 'bg-red-500' }}"></span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            {% if camera.status == 'online' %}
            <div class="camera-actions">
                <button onclick="window.open('/stream/{{ camera.name or camera.id }}', 'stream-{{ camera.name or camera.id }}', 'width=900,height=700')" class="action-button action-button-primary">
                    <svg class="w-4 h-4 mr-1 inline" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
                    </svg>
                    Start Stream
                </button>
                <button onclick="toggleAudioPanel('{{ camera.name or camera.id }}')" class="action-button">
                    <svg class="w-4 h-4 mr-1 inline" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0 5 5 0 01-10 0 1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path>
                    </svg>
                    üîä Audio
                </button>
                <button onclick="window.open('/api/cameras/{{ camera.name or camera.id }}/snapshot', 'snapshot-{{ camera.name or camera.id }}', 'width=800,height=600')" class="action-button">
                    <svg class="w-4 h-4 mr-1 inline" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm3 7a1 1 0 011-1h.01a1 1 0 110 2H8a1 1 0 01-1-1zm3-1a1 1 0 100 2h.01a1 1 0 100-2H10zm-2 4a1 1 0 011-1h.01a1 1 0 110 2H9a1 1 0 01-1-1zm6-4a1 1 0 100 2h.01a1 1 0 100-2H14zm-2 4a1 1 0 011-1h.01a1 1 0 110 2H12a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    üì∏ Snapshot
                </button>
                {% if camera.ptz_capable %}
                <button onclick="togglePTZ('{{ camera.name or camera.id }}')" class="action-button">
                    üéÆ PTZ Controls
                </button>
                {% endif %}
            </div>

            <!-- PTZ Control Panel (hidden by default) -->
            {% if camera.ptz_capable %}
            <div id="ptz-panel-{{ camera.name or camera.id }}" class="ptz-panel" style="display: none;">
                <div class="ptz-header">
                    <span class="ptz-title">üéÆ PTZ Controls</span>
                    <button onclick="togglePTZ('{{ camera.name or camera.id }}')" class="ptz-close">&times;</button>
                </div>
                <div class="ptz-controls">
                    <div class="ptz-dpad">
                        <button class="ptz-btn ptz-up" onmousedown="ptzMove('{{ camera.name or camera.id }}', 0, 0.5, 0)" onmouseup="ptzStop('{{ camera.name or camera.id }}')" onmouseleave="ptzStop('{{ camera.name or camera.id }}')">‚ñ≤</button>
                        <div class="ptz-middle-row">
                            <button class="ptz-btn ptz-left" onmousedown="ptzMove('{{ camera.name or camera.id }}', -0.5, 0, 0)" onmouseup="ptzStop('{{ camera.name or camera.id }}')" onmouseleave="ptzStop('{{ camera.name or camera.id }}')">‚óÄ</button>
                            <button class="ptz-btn ptz-center" onclick="ptzStop('{{ camera.name or camera.id }}')">‚¨§</button>
                            <button class="ptz-btn ptz-right" onmousedown="ptzMove('{{ camera.name or camera.id }}', 0.5, 0, 0)" onmouseup="ptzStop('{{ camera.name or camera.id }}')" onmouseleave="ptzStop('{{ camera.name or camera.id }}')">‚ñ∂</button>
                        </div>
                        <button class="ptz-btn ptz-down" onmousedown="ptzMove('{{ camera.name or camera.id }}', 0, -0.5, 0)" onmouseup="ptzStop('{{ camera.name or camera.id }}')" onmouseleave="ptzStop('{{ camera.name or camera.id }}')">‚ñº</button>
                    </div>
                    <div class="ptz-zoom">
                        <button class="ptz-btn ptz-zoom-in" onmousedown="ptzMove('{{ camera.name or camera.id }}', 0, 0, 0.3)" onmouseup="ptzStop('{{ camera.name or camera.id }}')" onmouseleave="ptzStop('{{ camera.name or camera.id }}')">üîç+</button>
                        <button class="ptz-btn ptz-zoom-out" onmousedown="ptzMove('{{ camera.name or camera.id }}', 0, 0, -0.3)" onmouseup="ptzStop('{{ camera.name or camera.id }}')" onmouseleave="ptzStop('{{ camera.name or camera.id }}')">üîç‚àí</button>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Audio Control Panel (hidden by default) -->
            <div id="audio-panel-{{ camera.name or camera.id }}" class="audio-panel" style="display: none;">
                <div class="audio-header">
                    <span class="audio-title">üîä Audio Stream</span>
                    <button onclick="toggleAudioPanel('{{ camera.name or camera.id }}')" class="audio-close">&times;</button>
                </div>
                <div class="audio-content">
                    <div class="audio-status" id="audio-status-{{ camera.name or camera.id }}">
                        Ready to listen
                    </div>
                    <div class="audio-controls">
                        <button class="audio-btn audio-btn-primary" onclick="openAudioPlayer('{{ camera.name or camera.id }}')">
                            üéß Open Audio Player
                        </button>
                        <button class="audio-btn audio-btn-vlc" onclick="openInVLC('{{ camera.name or camera.id }}')">
                            üé¨ Open in VLC
                        </button>
                        <button class="audio-btn" onclick="copyRtspUrl('{{ camera.name or camera.id }}')">
                            üìã Copy RTSP URL
                        </button>
                    </div>
                    <div class="audio-warning">
                        <strong>‚ö†Ô∏è Two-Way Audio Limitation</strong><br>
                        ONVIF only supports <em>listening</em>. For two-way talk, use the <strong>Tapo app</strong>.
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <svg class="empty-state-icon" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
        </svg>
        <h3 class="empty-state-title">No Cameras Configured</h3>
        <p class="empty-state-description">
            Get started by adding your first camera to the system. Configure IP cameras, webcams, or connect to cloud services.
        </p>
    </div>
    {% endif %}
    </div>

{% endblock %}

{% block extra_js %}
<script>
// PTZ Control Functions
function togglePTZ(cameraName) {
    const panel = document.getElementById('ptz-panel-' + cameraName);
    if (panel) {
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
}

async function ptzMove(cameraName, pan, tilt, zoom) {
    try {
        const response = await fetch('/api/ptz/move', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                camera_name: cameraName,
                pan: pan,
                tilt: tilt,
                zoom: zoom
            })
        });
        if (!response.ok) {
            const error = await response.json();
            console.error('PTZ move failed:', error.detail);
        }
    } catch (err) {
        console.error('PTZ move error:', err);
    }
}

async function ptzStop(cameraName) {
    try {
        await fetch('/api/ptz/stop/' + cameraName, { method: 'POST' });
    } catch (err) {
        console.error('PTZ stop error:', err);
    }
}

// Touch support for mobile
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.ptz-btn').forEach(btn => {
        btn.addEventListener('touchstart', function(e) {
            e.preventDefault();
            this.dispatchEvent(new Event('mousedown'));
        });
        btn.addEventListener('touchend', function(e) {
            e.preventDefault();
            this.dispatchEvent(new Event('mouseup'));
        });
    });
});

// Audio Control Functions
function toggleAudioPanel(cameraName) {
    const panel = document.getElementById('audio-panel-' + cameraName);
    if (panel) {
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
}

function openAudioPlayer(cameraName) {
    window.open('/api/audio/player/' + cameraName, 'audio-' + cameraName, 'width=900,height=700');
}

async function openInVLC(cameraName) {
    try {
        const response = await fetch('/api/audio/info/' + cameraName);
        const data = await response.json();
        if (data.rtsp_url_full) {
            // Try to open VLC protocol handler
            window.location.href = 'vlc://' + data.rtsp_url_full;
            // Also show the URL for manual copy
            const statusEl = document.getElementById('audio-status-' + cameraName);
            if (statusEl) {
                statusEl.innerHTML = 'üé¨ Opening VLC... If it doesn\'t open, copy the RTSP URL.';
            }
        }
    } catch (err) {
        console.error('Failed to get RTSP URL:', err);
        alert('Failed to get stream URL. Make sure camera is connected.');
    }
}

async function copyRtspUrl(cameraName) {
    try {
        const response = await fetch('/api/audio/info/' + cameraName);
        const data = await response.json();
        if (data.rtsp_url_full) {
            await navigator.clipboard.writeText(data.rtsp_url_full);
            const statusEl = document.getElementById('audio-status-' + cameraName);
            if (statusEl) {
                statusEl.innerHTML = '‚úÖ RTSP URL copied to clipboard!';
                setTimeout(() => {
                    statusEl.innerHTML = 'Ready to listen';
                }, 3000);
            }
        }
    } catch (err) {
        console.error('Failed to copy RTSP URL:', err);
        alert('Failed to copy URL. See console for details.');
    }
}
</script>
{% endblock %}
