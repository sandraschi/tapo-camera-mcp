{% extends "base.html" %}

{% block title %}Cameras - Home Security MCP{% endblock %}

{% block extra_css %}
<style>
    .cameras-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .camera-card {
        padding: 0;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.05);
        background: var(--glass-bg);
        backdrop-filter: var(--glass-blur);
        border-radius: 1.5rem;
        overflow: hidden;
    }

    .camera-card:hover {
        transform: translateY(-4px);
        border-color: rgba(212, 175, 55, 0.3);
        box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.5);
    }

    .camera-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2rem;
        background: rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .camera-name {
        font-size: 1.1rem;
        font-weight: 800;
        color: white;
        margin: 0;
        letter-spacing: -0.01em;
    }

    .status-badge {
        padding: 0.25rem 0.6rem;
        border-radius: 6px;
        font-size: 9px;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.15em;
    }

    .status-online {
        background-color: rgba(34, 197, 94, 0.1);
        color: #4ade80;
        border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .status-offline {
        background-color: rgba(234, 179, 8, 0.1);
        color: #fbbf24;
        border: 1px solid rgba(234, 179, 8, 0.2);
    }

    .status-error {
        background-color: rgba(239, 68, 68, 0.1);
        color: #f87171;
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .camera-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1.25rem;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
    }

    .detail-label {
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.25rem;
    }

    .detail-value {
        font-size: 0.875rem;
        color: var(--text-primary);
        font-weight: 500;
    }

    .capabilities-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .capability-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background-color: var(--bg-secondary);
        border-radius: 0.375rem;
        border: 1px solid var(--border-primary);
    }

    .capability-icon {
        width: 1rem;
        height: 1rem;
        color: #6b7280;
    }

    .capability-supported .capability-icon {
        color: #16a34a;
    }

    .capability-name {
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--text-primary);
    }

    .camera-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-primary);
    }

    .action-button {
        padding: 0.4rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.8rem;
        font-weight: 500;
        text-decoration: none;
        white-space: nowrap;
        flex-shrink: 0;
        transition: all 0.2s ease-in-out;
        border: 1px solid var(--border-primary);
        background-color: var(--bg-secondary);
        color: var(--text-primary);
    }

    .action-button:hover {
        background-color: #f9fafb;
        border-color: #9ca3af;
    }

    .action-button-primary {
        background-color: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .action-button-primary:hover {
        background-color: var(--accent-gold-hover);
        border-color: var(--accent-gold-hover);
    }

    .stats-overview {
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        font-weight: 500;
        margin-top: 0.25rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6b7280;
    }

    .empty-state-icon {
        width: 4rem;
        height: 4rem;
        margin: 0 auto 1rem;
        opacity: 0.5;
    }

    .empty-state-title {
        font-size: 1.125rem;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .empty-state-description {
        font-size: 0.875rem;
        color: #6b7280;
    }

    @media (max-width: 768px) {
        .cameras-grid {
            grid-template-columns: 1fr;
        }

        .camera-details {
            grid-template-columns: 1fr;
        }

        .capabilities-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .camera-actions {
            justify-content: center;
        }

        .action-button {
            padding: 0.35rem 0.6rem;
            font-size: 0.75rem;
        }

        .action-button svg {
            display: none;
        }
    }

    /* PTZ Control Panel Styles */
    .ptz-panel {
        margin-top: 1rem;
        padding: 1.5rem;
        background: var(--glass-bg);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border-radius: 0.75rem;
        border: 1px solid var(--accent-gold);
    }

    .ptz-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .ptz-title {
        color: #e2e8f0;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .ptz-close {
        background: none;
        border: none;
        color: #94a3b8;
        font-size: 1.25rem;
        cursor: pointer;
        padding: 0 0.25rem;
    }

    .ptz-close:hover {
        color: #f1f5f9;
    }

    .ptz-controls {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        justify-content: center;
    }

    .ptz-dpad {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
    }

    .ptz-middle-row {
        display: flex;
        gap: 0.25rem;
    }

    .ptz-btn {
        width: 44px;
        height: 44px;
        border: none;
        border-radius: 0.5rem;
        background: var(--accent-gold);
        color: white;
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
        user-select: none;
    }

    .ptz-btn:hover {
        background: var(--accent-gold-hover);
        transform: scale(1.05);
    }

    .ptz-btn:active {
        background: #1d4ed8;
        transform: scale(0.95);
    }

    .ptz-center {
        background: #64748b;
        font-size: 0.75rem;
    }

    .ptz-center:hover {
        background: #475569;
    }

    .ptz-zoom {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .ptz-zoom-in,
    .ptz-zoom-out {
        width: 50px;
        font-size: 0.85rem;
    }

    .zoom-label {
        font-size: 0.75rem;
        color: #fbbf24;
        font-weight: 600;
        text-align: center;
        margin-bottom: 0.25rem;
    }

    /* Audio Control Panel Styles */
    .audio-panel {
        margin-top: 1rem;
        padding: 1.5rem;
        background: var(--glass-bg);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border-radius: 0.75rem;
        border: 1px solid var(--accent-gold);
    }

    .audio-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .audio-title {
        color: #e2e8f0;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .audio-close {
        background: none;
        border: none;
        color: #94a3b8;
        font-size: 1.25rem;
        cursor: pointer;
        padding: 0 0.25rem;
    }

    .audio-close:hover {
        color: #f1f5f9;
    }

    .audio-content {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .audio-status {
        background: rgba(0, 0, 0, 0.2);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        text-align: center;
        color: #94a3b8;
        font-size: 0.85rem;
    }

    .audio-controls {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: center;
    }

    .audio-btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        background: rgba(255, 255, 255, 0.15);
        color: white;
    }

    .audio-btn:hover {
        background: rgba(255, 255, 255, 0.25);
    }

    .audio-btn-primary {
        background: var(--accent-gold);
    }

    .audio-btn-primary:hover {
        background: var(--accent-gold-hover);
    }

    .audio-btn-vlc {
        background: #ff6600;
    }

    .audio-btn-vlc:hover {
        background: #e55c00;
    }

    .audio-warning {
        background: rgba(251, 191, 36, 0.15);
        border: 1px solid rgba(251, 191, 36, 0.3);
        border-radius: 0.5rem;
        padding: 0.75rem;
        font-size: 0.8rem;
        color: #fde68a;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="page-header mb-12 border-b border-white/5 pb-8">
        <div class="flex items-center gap-4 mb-4">
            <span
                class="badge badge-primary bg-accent-gold text-slate-900 border-none font-black px-3 py-1 rounded-md text-[10px] uppercase tracking-widest flex items-center gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-slate-900 animate-pulse"></span>
                Optical Grid Active
            </span>
            <span class="text-[10px] font-black text-gray-500 uppercase tracking-[0.2em]">
                SOTA Sensor Topology
            </span>
        </div>
        <h1 class="text-5xl font-black tracking-tighter text-white mb-3">
            <span class="text-accent-gold">SENSOR</span> MATRIX
        </h1>
        <p class="text-gray-400 font-medium max-w-3xl leading-relaxed">
            Comprehensive surveillance management interface. Real-time telemetry, PTZ orchestration, and high-fidelity
            persistence monitoring for current-gen sensor nodes.
        </p>
    </div>

    <!-- Stats Overview -->
    <div class="stats-overview glass mb-12 border border-white/5 p-8 rounded-3xl">
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value text-4xl font-black tracking-tighter mb-1">{{ total_cameras }}</div>
                <div class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Aggregate Nodes</div>
            </div>
            <div class="stat-item">
                <div class="stat-value text-4xl font-black tracking-tighter mb-1 text-accent-gold">{{ online_cameras }}
                </div>
                <div class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Active Ingress</div>
            </div>
            <div class="stat-item">
                <div class="stat-value text-4xl font-black tracking-tighter mb-1 text-red-400">{{ total_cameras -
                    online_cameras }}</div>
                <div class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Node Failures</div>
            </div>
            <div class="stat-item">
                <div class="stat-value text-4xl font-black tracking-tighter mb-1 text-blue-400">{{ total_cameras }}
                </div>
                <div class="text-[10px] font-black text-gray-500 uppercase tracking-widest">SOTA Topology</div>
            </div>
        </div>
    </div>

    <!-- Cameras Grid -->
    {% if cameras %}
    <div class="cameras-grid">
        {% for camera in cameras %}
        <div class="camera-card glass">
            <!-- Camera Header -->
            <div class="camera-header">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <h3 class="camera-name" id="camera-name-{{ camera.name or camera.id }}">
                        {{ camera.custom_name if camera.custom_name else (camera.name or camera.id) }}
                        {% if camera.custom_name %}
                        <span style="font-size: 0.8rem; color: #6b7280; font-weight: normal;">({{ camera.name or
                            camera.id }})</span>
                        {% endif %}
                    </h3>
                    <button onclick="openRenameDialog('{{ camera.name or camera.id }}')"
                        class="btn btn-secondary border-gold" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                        title="Rename Camera">
                        ‚úèÔ∏è
                    </button>
                </div>
                <span
                    class="status-badge status-{{ 'online' if (camera.status == 'online' or (camera.status is mapping and camera.status.get('connected'))) else 'offline' if camera.status == 'offline' else 'error' }}">
                    {% if camera.status is mapping %}
                    {{ 'Online' if camera.status.get('connected') else 'Offline' }}
                    {% else %}
                    {{ (camera.status|string|title) if camera.status else 'Unknown' }}
                    {% endif %}
                </span>
            </div>

            <!-- Teams/Webcam Blocking Warning -->
            {% if camera.teams_blocked or (camera.warning and ('teams' in camera.warning.lower() or 'in use' in
            camera.warning.lower() or 'locked' in camera.warning.lower())) %}
            <div
                style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.25rem; color: var(--accent-gold);">‚ö†Ô∏è</span>
                    <strong style="color: var(--accent-gold);">Camera Blocked by Another Application</strong>
                </div>
                <p style="color: #78350f; margin: 0.5rem 0; font-size: 0.9rem;">
                    {{ camera.error_message or camera.warning or 'This USB camera is currently locked by Microsoft
                    Teams, Zoom, Skype, or another video application.' }}
                </p>
                <p style="color: #78350f; margin: 0.5rem 0 0 0; font-size: 0.85rem;">
                    <strong>üí° Solution:</strong> Close Microsoft Teams, Zoom, or other video applications that are
                    using the camera, then refresh this page.
                </p>
            </div>
            {% endif %}

            <!-- Camera Sensor Data + Visual Persistence -->
            <div class="p-8 space-y-8">
                <div class="camera-details grid grid-cols-2 gap-8">
                    <div class="detail-item">
                        <span class="text-[9px] font-black text-gray-500 uppercase tracking-widest block mb-2">Sensor
                            Architecture</span>
                        <span class="text-sm font-bold text-gray-300">{{ camera.type|title }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="text-[9px] font-black text-gray-500 uppercase tracking-widest block mb-2">Hardware
                            Model</span>
                        <span class="text-sm font-bold text-gray-300">{{ camera.model|default('SOTA Node') }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="text-[9px] font-black text-gray-500 uppercase tracking-widest block mb-2">Optical
                            Resolution</span>
                        <span class="text-sm font-bold text-gray-300">{{ camera.resolution|default('High-Fidelity')
                            }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="text-[9px] font-black text-gray-500 uppercase tracking-widest block mb-2">Firmware
                            Revision</span>
                        <span class="text-sm font-bold text-gray-300">{{ camera.firmware|default('Latest') }}</span>
                    </div>
                </div>

                <!-- Visual Persistence Matrix -->
                <div class="flex gap-8 items-start bg-black/20 p-6 rounded-2xl border border-white/5 shadow-inner">
                    <div class="relative group">
                        <div
                            class="w-40 h-40 rounded-xl overflow-hidden border border-white/10 bg-black group-hover:border-accent-gold/40 transition-colors shadow-2xl">
                            {% if camera.type == 'ring' %}
                            <img src="/api/ring/snapshot/{{ camera.id }}" alt="{{ camera.custom_name or camera.name }}"
                                class="w-full h-full object-cover grayscale-[0.3] hover:grayscale-0 transition-all duration-500"
                                onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                onload="this.nextElementSibling.style.display='none';">
                            {% else %}
                            <img src="/api/cameras/{{ camera.name or camera.id }}/snapshot" alt="{{ camera.name }}"
                                class="w-full h-full object-cover grayscale-[0.3] hover:grayscale-0 transition-all duration-500"
                                onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                onload="this.nextElementSibling.style.display='none';">
                            {% endif %}
                            <div class="hidden absolute inset-0 items-center justify-center bg-black/80 flex-col gap-3">
                                <i class="fas fa-eye-slash text-2xl text-red-400"></i>
                                <span class="text-[9px] font-black text-gray-500 uppercase tracking-widest">Signal
                                    Lost</span>
                            </div>
                        </div>
                        <div
                            class="absolute -bottom-2 -right-2 w-8 h-8 rounded-lg bg-accent-gold flex items-center justify-center text-slate-900 text-xs shadow-lg">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <div class="flex-1 space-y-4">
                        <div class="p-3 rounded-lg bg-white/5 border border-white/5">
                            <p class="text-[10px] leading-relaxed text-gray-400 font-medium">
                                Visual persistence stream active. Click <span class="text-accent-gold font-black">STREAM
                                    MATRIX</span> below for full-bandwidth telepresence.
                            </p>
                        </div>
                        {% if camera.type == 'ring' and camera.battery_life %}
                        <div class="flex gap-4">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-battery-three-quarters text-accent-gold text-[10px]"></i>
                                <span class="text-[10px] font-black text-gray-300 uppercase tracking-widest">{{
                                    camera.battery_life }}%</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-wifi text-blue-400 text-[10px]"></i>
                                <span class="text-[10px] font-black text-gray-300 uppercase tracking-widest">{{
                                    camera.wifi_signal }}</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Capabilities & Health Indicators -->
                <div class="grid grid-cols-2 gap-4 py-8 border-t border-white/5">
                    <div class="space-y-4">
                        <div
                            class="flex items-center justify-between px-4 py-3 bg-white/5 rounded-xl border border-white/5">
                            <span class="text-[9px] font-black text-gray-500 uppercase tracking-widest">Stream
                                Matrix</span>
                            <span
                                class="w-2 h-2 rounded-full {{ 'bg-accent-gold shadow-[0_0_8px_#d4af37]' if camera.streaming_capable else 'bg-red-500 shadow-[0_0_8px_#ef4444]' }}"></span>
                        </div>
                        <div
                            class="flex items-center justify-between px-4 py-3 bg-white/5 rounded-xl border border-white/5">
                            <span class="text-[9px] font-black text-gray-500 uppercase tracking-widest">Audio
                                Egress</span>
                            <span
                                class="w-2 h-2 rounded-full {{ 'bg-accent-gold shadow-[0_0_8px_#d4af37]' if camera.audio_capable else 'bg-red-500 shadow-[0_0_8px_#ef4444]' }}"></span>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div
                            class="flex items-center justify-between px-4 py-3 bg-white/5 rounded-xl border border-white/5">
                            <span class="text-[9px] font-black text-gray-500 uppercase tracking-widest">PTZ
                                Control</span>
                            <span
                                class="w-2 h-2 rounded-full {{ 'bg-accent-gold shadow-[0_0_8px_#d4af37]' if camera.ptz_capable else 'bg-red-500 shadow-[0_0_8px_#ef4444]' }}"></span>
                        </div>
                        <div
                            class="flex items-center justify-between px-4 py-3 bg-white/5 rounded-xl border border-white/5">
                            <span class="text-[9px] font-black text-gray-500 uppercase tracking-widest">Optic
                                Zoom</span>
                            <span
                                class="w-2 h-2 rounded-full {{ 'bg-accent-gold shadow-[0_0_8px_#d4af37]' if camera.digital_zoom_capable else 'bg-red-500 shadow-[0_0_8px_#ef4444]' }}"></span>
                        </div>
                    </div>
                </div>

                <!-- Command Interface -->
                {% if camera.status == 'online' %}
                <div class="flex flex-wrap gap-4 pt-8 border-t border-white/5">
                    {% if camera.type == 'ring' %}
                    <button onclick="viewRingLiveStream('{{ camera.id }}')"
                        class="btn btn-primary py-2 px-4 text-[10px] uppercase tracking-widest font-black shadow-[0_0_15px_rgba(212,175,55,0.2)]">
                        <i class="fas fa-play-circle mr-2"></i> LIVE INGRESS
                    </button>
                    <button onclick="getRingSnapshot('{{ camera.id }}')"
                        class="btn btn-secondary py-2 px-4 text-[10px] uppercase tracking-widest font-black">
                        <i class="fas fa-camera mr-2"></i> SNAPSHOT
                    </button>
                    <a href="/ring"
                        class="btn btn-secondary py-2 px-4 text-[10px] uppercase tracking-widest font-black">
                        <i class="fas fa-external-link-alt mr-2"></i> RING COMMAND
                    </a>
                    {% else %}
                    <button
                        onclick="window.open('/stream/{{ camera.name or camera.id }}', 'stream-{{ camera.name or camera.id }}', 'width=900,height=700')"
                        class="btn btn-primary py-2 px-4 text-[10px] uppercase tracking-widest font-black shadow-[0_0_15px_rgba(212,175,55,0.2)]">
                        <i class="fas fa-play-circle mr-2"></i> STREAM MATRIX
                    </button>
                    <button onclick="toggleAudioPanel('{{ camera.name or camera.id }}')"
                        class="btn btn-secondary py-2 px-4 text-[10px] uppercase tracking-widest font-black">
                        <i class="fas fa-volume-up mr-2"></i> AUDIO EGRESS
                    </button>
                    <button
                        onclick="window.open('/api/cameras/{{ camera.name or camera.id }}/snapshot', 'snapshot-{{ camera.name or camera.id }}', 'width=800,height=600')"
                        class="btn btn-secondary py-2 px-4 text-[10px] uppercase tracking-widest font-black">
                        <i class="fas fa-camera mr-2"></i> SNAPSHOT
                    </button>
                    {% if camera.ptz_capable or camera.digital_zoom_capable %}
                    <button onclick="togglePTZ('{{ camera.name or camera.id }}')"
                        class="btn btn-secondary py-2 px-4 text-[10px] uppercase tracking-widest font-black">
                        <i class="fas fa-gamepad mr-2"></i> {% if camera.ptz_capable %}PTZ{% else %}ZOOM{% endif %}
                        ORCHESTRATION
                    </button>
                    {% endif %}
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- PTZ Control Panel (hidden by default) -->
            {% if camera.ptz_capable or camera.digital_zoom_capable %}
            <div id="ptz-panel-{{ camera.name or camera.id }}" class="ptz-panel" style="display: none;">
                <div class="ptz-header">
                    <span class="ptz-title">
                        {% if camera.ptz_capable %}üéÆ PTZ{% else %}üîç Digital Zoom{% endif %} Controls
                    </span>
                    <button onclick="togglePTZ('{{ camera.name or camera.id }}')" class="ptz-close">&times;</button>
                </div>
                <div class="ptz-controls">
                    {% if camera.ptz_capable %}
                    <!-- Full PTZ Controls for cameras with physical PTZ -->
                    <div class="ptz-dpad">
                        <button class="ptz-btn ptz-up"
                            onclick="ptzMove('{{ camera.name or camera.id }}', 0, 1.0, 0)">‚ñ≤</button>
                        <div class="ptz-middle-row">
                            <button class="ptz-btn ptz-left"
                                onclick="ptzMove('{{ camera.name or camera.id }}', -1.0, 0, 0)">‚óÄ</button>
                            <button class="ptz-btn ptz-center"
                                onclick="ptzHome('{{ camera.name or camera.id }}')">‚åÇ</button>
                            <button class="ptz-btn ptz-right"
                                onclick="ptzMove('{{ camera.name or camera.id }}', 1.0, 0, 0)">‚ñ∂</button>
                        </div>
                        <button class="ptz-btn ptz-down"
                            onclick="ptzMove('{{ camera.name or camera.id }}', 0, -1.0, 0)">‚ñº</button>
                    </div>
                    {% endif %}
                    {% if camera.digital_zoom_capable %}
                    <!-- Digital Zoom Controls (available for all cameras) -->
                    <div class="ptz-zoom">
                        <div class="zoom-label">Digital Zoom</div>
                        <button class="ptz-btn ptz-zoom-in"
                            onclick="digitalZoomIn('{{ camera.name or camera.id }}')">üîç+</button>
                        <button class="ptz-btn ptz-zoom-out"
                            onclick="digitalZoomOut('{{ camera.name or camera.id }}')">üîç‚àí</button>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Audio Control Panel (hidden by default) -->
            <div id="audio-panel-{{ camera.name or camera.id }}" class="audio-panel" style="display: none;">
                <div class="audio-header">
                    <span class="audio-title">üîä Audio Stream</span>
                    <button onclick="toggleAudioPanel('{{ camera.name or camera.id }}')"
                        class="audio-close">&times;</button>
                </div>
                <div class="audio-content">
                    <div class="audio-status" id="audio-status-{{ camera.name or camera.id }}">
                        Ready to listen
                    </div>
                    <div class="audio-controls">
                        <button class="audio-btn audio-btn-primary"
                            onclick="openAudioPlayer('{{ camera.name or camera.id }}')">
                            üéß Open Audio Player
                        </button>
                        <button class="audio-btn audio-btn-vlc" onclick="openInVLC('{{ camera.name or camera.id }}')">
                            üé¨ Open in VLC
                        </button>
                        <button class="audio-btn" onclick="copyRtspUrl('{{ camera.name or camera.id }}')">
                            üìã Copy RTSP URL
                        </button>
                    </div>
                    <div class="audio-warning">
                        <strong>‚ö†Ô∏è Two-Way Audio Limitation</strong><br>
                        ONVIF only supports <em>listening</em>. For two-way talk, use the <strong>Tapo app</strong>.
                    </div>
                </div>

                <!-- Microscope Timelapse Controls -->
                {% if camera.type == "microscope" %}
                <div class="microscope-controls">
                    <h4>üî¨ Microscope Timelapse</h4>
                    <div class="control-group">
                        <button class="control-btn" onclick="openTimelapsePanel('{{ camera.name or camera.id }}')">
                            üìπ Start Plant Growth Timelapse
                        </button>
                        <button class="control-btn" onclick="getTimelapseStatus('{{ camera.name or camera.id }}')">
                            üìä Check Timelapse Status
                        </button>
                    </div>
                    <div class="microscope-info">
                        <strong>Plant Growth Monitoring Ready!</strong><br>
                        Built-in LED light ensures consistent illumination for time-lapse photography.
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div
        class="empty-state glass p-16 rounded-3xl border border-white/5 text-center flex flex-col items-center justify-center space-y-6">
        <div class="w-24 h-24 rounded-full bg-white/5 flex items-center justify-center text-gray-700">
            <i class="fas fa-camera-viewfinder text-4xl"></i>
        </div>
        <div>
            <h3 class="text-xl font-bold text-gray-300 mb-2 uppercase tracking-widest">Topology Empty</h3>
            <p class="text-gray-500 max-w-md mx-auto text-sm font-medium">
                No sensor nodes detected in the current grid configuration. Synchronize hardware nodes or manual entry
                to initialize monitoring.
            </p>
        </div>
        <button class="btn btn-secondary px-8 py-3 text-[10px] font-black uppercase tracking-widest">
            Initialize Auto-Discovery
        </button>
    </div>
    {% endif %}
</div>

<!-- Microscope Timelapse Management Section -->
<div class="mt-12 glass p-8 rounded-3xl border border-accent-gold/20 bg-accent-gold/5 relative overflow-hidden">
    <div class="absolute top-0 right-0 p-4">
        <i class="fas fa-seedling text-8xl text-accent-gold/5 -rotate-12 translate-x-8 translate-y-4"></i>
    </div>
    <div class="relative z-10">
        <div class="flex items-center gap-3 mb-6">
            <span
                class="w-8 h-8 rounded-lg bg-accent-gold flex items-center justify-center text-slate-900 text-xs shadow-lg">
                <i class="fas fa-leaf"></i>
            </span>
            <h3 class="text-xl font-black text-white uppercase tracking-widest">Plant Growth Monitoring</h3>
        </div>
        <p class="text-gray-400 font-medium mb-8 max-w-2xl text-sm leading-relaxed">
            High-fidelity microscope time-lapse photography for germinating biological entities. Automated LED
            orchestration and AI growth pattern analysis for SOTA botanical research.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="glass-dark p-6 rounded-2xl border border-white/5 space-y-4">
                <h4 class="text-[10px] font-black text-accent-gold uppercase tracking-widest">Quick Start</h4>
                <button onclick="startQuickTimelapse()" class="w-full btn btn-primary py-3 text-[10px] tracking-widest">
                    üöÄ START 10m INTERVALS
                </button>
                <p class="text-[9px] text-gray-500 font-black uppercase tracking-widest text-center">Germination
                    Baseline</p>
            </div>

            <div class="glass-dark p-6 rounded-2xl border border-white/5 space-y-4">
                <h4 class="text-[10px] font-black text-blue-400 uppercase tracking-widest">Video Synthesis</h4>
                <button onclick="createTimelapseVideo()"
                    class="w-full btn btn-secondary py-3 text-[10px] tracking-widest border-blue-400/20 hover:border-blue-400/50">
                    üé¨ SYNTHESIZE MP4
                </button>
                <p class="text-[9px] text-gray-500 font-black uppercase tracking-widest text-center">Batch Processing
                </p>
            </div>

            <div class="glass-dark p-6 rounded-2xl border border-white/5 space-y-4">
                <h4 class="text-[10px] font-black text-purple-400 uppercase tracking-widest">AI Analytics</h4>
                <button onclick="analyzePlantGrowth()"
                    class="w-full btn btn-secondary py-3 text-[10px] tracking-widest border-purple-400/20 hover:border-purple-400/50">
                    üìä ANALYZE GROWTH
                </button>
                <p class="text-[9px] text-gray-500 font-black uppercase tracking-widest text-center">Pattern Recognition
                </p>
            </div>
        </div>

        <div class="bg-black/40 border border-white/5 rounded-2xl p-6">
            <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                <i class="fas fa-info-circle text-accent-gold"></i> Operational Guidelines
            </h4>
            <ul
                class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-[11px] text-gray-500 font-medium leading-relaxed">
                <li class="flex items-center gap-2"><span class="w-1 h-1 rounded-full bg-accent-gold"></span> Position
                    microscope over germination site.</li>
                <li class="flex items-center gap-2"><span class="w-1 h-1 rounded-full bg-accent-gold"></span> Ensure
                    built-in LED saturation is nominal.</li>
                <li class="flex items-center gap-2"><span class="w-1 h-1 rounded-full bg-accent-gold"></span> 10-minute
                    intervals for high-velocity growth.</li>
                <li class="flex items-center gap-2"><span class="w-1 h-1 rounded-full bg-accent-gold"></span> 24-72h
                    duration for full cycle capture.</li>
                <li class="flex items-center gap-2"><span class="w-1 h-1 rounded-full bg-accent-gold"></span> AF-Matrix
                    optimization every 10 frames.</li>
                <li class="flex items-center gap-2"><span class="w-1 h-1 rounded-full bg-accent-gold"></span> Growth
                    acceleration visualization capable.</li>
            </ul>
        </div>
    </div>
</div>

<!-- Dymo Humorous Labels Section -->
<div class="mt-12 glass p-8 rounded-3xl border border-white/5 relative overflow-hidden mb-12">
    <div class="absolute top-0 right-0 p-4">
        <i class="fas fa-tags text-8xl text-white/5 -rotate-12 translate-x-8 translate-y-4"></i>
    </div>
    <div class="relative z-10">
        <div class="flex items-center gap-3 mb-6">
            <span
                class="w-8 h-8 rounded-lg bg-red-500/20 flex items-center justify-center text-red-400 text-xs border border-red-500/20">
                <i class="fas fa-laugh"></i>
            </span>
            <h3 class="text-xl font-black text-white uppercase tracking-widest">Humorous Fridge Protocols</h3>
        </div>
        <p class="text-gray-400 font-medium mb-8 max-w-2xl text-sm leading-relaxed">
            Generate AI-augmented humorous labels for physical deployment onto cooling apparatus. Direct Dymo synthesis
            for maximum chaotic coverage.
        </p>

        <div class="bg-red-500/10 border border-red-500/20 rounded-2xl p-6 mb-8 flex items-start gap-4">
            <i class="fas fa-exclamation-triangle text-red-400 mt-1"></i>
            <div>
                <h4 class="text-[10px] font-black text-red-300 uppercase tracking-widest mb-1">Warning: High Saturation
                    Output</h4>
                <p class="text-xs text-red-200/60 font-medium leading-relaxed">This operation will synthesize up to 50
                    physical labels. Ensure Dymo ribbon stock is nominal before deployment.</p>
            </div>
        </div>

        <form id="humorous-labels-form" class="space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div>
                    <label class="block text-[9px] font-black text-gray-500 uppercase tracking-widest mb-2">Humor
                        Theme</label>
                    <select id="humor-theme"
                        class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm font-bold text-gray-300 focus:border-accent-gold/40 focus:outline-none focus:ring-1 focus:ring-accent-gold/20">
                        <option value="random">Random Mix</option>
                        <option value="dad_jokes">Dad Jokes</option>
                        <option value="puns">Puns</option>
                        <option value="sarcastic">Sarcastic</option>
                        <option value="motivational">Motivational</option>
                        <option value="absurd">Absurd</option>
                    </select>
                </div>

                <div>
                    <label
                        class="block text-[9px] font-black text-gray-500 uppercase tracking-widest mb-2">Category</label>
                    <select id="humor-category"
                        class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm font-bold text-gray-300 focus:border-accent-gold/40 focus:outline-none focus:ring-1 focus:ring-accent-gold/20">
                        <option value="general">General</option>
                        <option value="food">Food</option>
                        <option value="chores">Chores</option>
                        <option value="pets">Pets</option>
                        <option value="tech">Tech</option>
                        <option value="life">Life</option>
                    </select>
                </div>

                <div>
                    <label
                        class="block text-[9px] font-black text-gray-500 uppercase tracking-widest mb-2">Complexity</label>
                    <select id="humor-style"
                        class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm font-bold text-gray-300 focus:border-accent-gold/40 focus:outline-none focus:ring-1 focus:ring-accent-gold/20">
                        <option value="short">Short</option>
                        <option value="medium">Medium</option>
                        <option value="long">Long</option>
                    </select>
                </div>

                <div>
                    <label class="block text-[9px] font-black text-gray-500 uppercase tracking-widest mb-2">Label
                        Count</label>
                    <input type="number" id="humor-count" value="50" min="1" max="100"
                        class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm font-bold text-gray-300 focus:border-accent-gold/40 focus:outline-none focus:ring-1 focus:ring-accent-gold/20">
                </div>
            </div>

            <div class="flex flex-wrap gap-4">
                <button type="button" onclick="generateHumorousLabels()"
                    class="btn btn-primary bg-red-600 hover:bg-red-700 border-none px-8 py-3 text-[10px] tracking-widest font-black">
                    üöÄ INITIALIZE PRINTING
                </button>

                <button type="button" onclick="previewHumorousLabels()"
                    class="btn btn-secondary px-8 py-3 text-[10px] tracking-widest font-black">
                    üëÅÔ∏è CACHE PREVIEW
                </button>
            </div>
        </form>

        <div id="humorous-results" class="mt-8 hidden space-y-4">
            <h4 class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Synthesis Preview</h4>
            <div id="label-preview" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-80 overflow-y-auto p-2">
                <!-- Preview will be shown here -->
            </div>
        </div>
    </div>
</div>

<!-- Camera Rename Dialog -->
<div id="rename-dialog" class="fixed inset-0 z-[1000] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm" onclick="closeRenameDialog()"></div>
    <div
        class="glass p-8 rounded-3xl border border-white/10 w-full max-w-md relative z-10 shadow-2xl animate-in zoom-in-95 duration-200">
        <div class="flex items-center gap-3 mb-6">
            <span
                class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400 text-xs border border-blue-500/20">
                <i class="fas fa-edit"></i>
            </span>
            <h3 class="text-xl font-black text-white uppercase tracking-widest">Rename Sensor</h3>
        </div>

        <div class="space-y-6">
            <div class="space-y-2">
                <label class="text-[9px] font-black text-gray-500 uppercase tracking-widest block">Hardware ID</label>
                <div id="rename-camera-id"
                    class="bg-black/40 border border-white/5 rounded-xl px-4 py-3 text-sm font-mono text-gray-400">
                </div>
            </div>

            <div class="space-y-2">
                <label for="rename-input"
                    class="text-[9px] font-black text-gray-500 uppercase tracking-widest block">Alias Assignment</label>
                <input type="text" id="rename-input" placeholder="e.g. PERIMETER_DELTA, LAB_MICROSCOPE"
                    class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm font-bold text-gray-300 focus:border-blue-400/40 focus:outline-none focus:ring-1 focus:ring-blue-400/20 placeholder:text-gray-600">
            </div>

            <div class="flex gap-4 pt-4">
                <button onclick="closeRenameDialog()"
                    class="flex-1 btn btn-secondary py-3 text-[10px] tracking-widest font-black">
                    ABORT
                </button>
                <button onclick="saveCameraName()"
                    class="flex-1 btn btn-primary py-3 text-[10px] tracking-widest font-black">
                    COMMIT
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // PTZ Control Functions
    function togglePTZ(cameraName) {
        const panel = document.getElementById('ptz-panel-' + cameraName);
        if (panel) {
            const isOpening = panel.style.display === 'none';
            panel.style.display = isOpening ? 'block' : 'none';

            // Reset digital zoom when closing PTZ panel
            if (!isOpening) {
                resetDigitalZoom(cameraName);
            }
        }
    }

    async function ptzMove(cameraName, pan, tilt, zoom) {
        try {
            // Send single relative PTZ movement command
            const response = await fetch('/api/ptz/move', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    camera_name: cameraName,
                    pan: pan,
                    tilt: tilt,
                    zoom: zoom
                })
            });

            if (!response.ok) {
                console.error('PTZ command failed:', response.status);
            } else {
                console.log(`PTZ moved: ${cameraName} pan=${pan}, tilt=${tilt}, zoom=${zoom}`);
            }
        } catch (error) {
            console.error('PTZ move error:', error);
        }
    }

    async function ptzStop(cameraName) {
        try {
            // Clear the movement interval for this camera
            const intervalId = ptzMovementIntervals.get(cameraName);
            if (intervalId) {
                clearInterval(intervalId);
                ptzMovementIntervals.delete(cameraName);
            }

            // Reset movement direction for this camera
            currentPTZMovements.delete(cameraName);

            // Send stop command to camera
            const response = await fetch('/api/ptz/stop/' + cameraName, { method: 'POST' });
            if (!response.ok) {
                console.error('PTZ stop failed for', cameraName);
            }

            console.log(`PTZ movement stopped for ${cameraName}`);

        } catch (err) {
            console.error('PTZ stop error:', err);
        }
    }

    // PTZ movement state (per camera)
    const ptzMovementIntervals = new Map(); // cameraName -> intervalId
    const currentPTZMovements = new Map(); // cameraName -> {pan, tilt, zoom}

    // Digital Zoom Functions (for cameras without optical zoom)
    const digitalZoomLevels = new Map(); // cameraName -> zoomLevel

    function digitalZoomIn(cameraName) {
        const currentLevel = digitalZoomLevels.get(cameraName) || 1.0;
        const newLevel = Math.min(3.0, currentLevel + 0.25);
        digitalZoomLevels.set(cameraName, newLevel);
        applyDigitalZoom(cameraName, newLevel);
        showToast(`Digital Zoom: ${newLevel.toFixed(1)}x`);
    }

    function digitalZoomOut(cameraName) {
        const currentLevel = digitalZoomLevels.get(cameraName) || 1.0;
        const newLevel = Math.max(1.0, currentLevel - 0.25);
        digitalZoomLevels.set(cameraName, newLevel);
        applyDigitalZoom(cameraName, newLevel);
        showToast(`Digital Zoom: ${newLevel.toFixed(1)}x`);
    }

    function applyDigitalZoom(cameraName, zoomLevel) {
        // For cameras.html, we need to find the camera's preview image
        // This is more complex since cameras.html shows thumbnails, not full streams
        // For now, just show the zoom level in a toast
        // Full digital zoom would need to be implemented in the thumbnail display
        console.log(`Digital zoom for ${cameraName}: ${zoomLevel}x`);
    }

    function resetDigitalZoom(cameraName) {
        digitalZoomLevels.set(cameraName, 1.0);
        applyDigitalZoom(cameraName, 1.0);
    }

    // Dymo humorous labels functions
    async function generateHumorousLabels() {
        const theme = document.getElementById('humor-theme').value;
        const category = document.getElementById('humor-category').value;
        const style = document.getElementById('humor-style').value;
        const count = parseInt(document.getElementById('humor-count').value);

        if (count > 50) {
            if (!confirm(`You're about to print ${count} labels! Are you sure you have enough tape?`)) {
                return;
            }
        }

        try {
            const response = await fetch('/api/dymo/humorous-fridge-labels', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    theme: theme,
                    category: category,
                    style: style,
                    count: count
                })
            });

            const result = await response.json();

            if (result.success) {
                showToast(`üé≠ Printed ${count} humorous ${category} labels with ${theme} theme!`);
                displayLabelPreview(result.result.generated_texts.slice(0, 10)); // Show first 10
            } else {
                alert('Failed to generate labels: ' + (result.error || 'Unknown error'));
            }

        } catch (error) {
            console.error('Failed to generate humorous labels:', error);
            alert('Failed to generate labels');
        }
    }

    async function previewHumorousLabels() {
        const theme = document.getElementById('humor-theme').value;
        const category = document.getElementById('humor-category').value;
        const style = document.getElementById('humor-style').value;

        try {
            // Generate just 5 for preview
            const response = await fetch('/api/dymo/humorous-fridge-labels', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    theme: theme,
                    category: category,
                    style: style,
                    count: 5
                })
            });

            const result = await response.json();

            if (result.success) {
                displayLabelPreview(result.result.generated_texts);
                document.getElementById('humorous-results').classList.remove('hidden');
            } else {
                alert('Failed to preview labels: ' + (result.error || 'Unknown error'));
            }

        } catch (error) {
            console.error('Failed to preview humorous labels:', error);
            alert('Failed to preview labels');
        }
    }

    function displayLabelPreview(labels) {
        const previewDiv = document.getElementById('label-preview');
        previewDiv.innerHTML = '';

        labels.forEach((label, index) => {
            const labelDiv = document.createElement('div');
            labelDiv.className = 'mb-2 p-2 bg-white border border-gray-200 rounded text-sm';
            labelDiv.innerHTML = `<strong>${index + 1}.</strong> ${label}`;
            previewDiv.appendChild(labelDiv);
        });

        document.getElementById('humorous-results').classList.remove('hidden');
    }

    // Microscope Timelapse Functions
    async function openTimelapsePanel(cameraName) {
        const sessionName = prompt("Enter timelapse session name (e.g., 'basil_germination'):");
        if (!sessionName) return;

        const interval = parseInt(prompt("Interval between photos (minutes):", "10")) || 10;
        const duration = parseInt(prompt("Duration in hours:", "24")) || 24;
        const autoFocus = confirm("Enable auto-focus every 10 shots? (Recommended for plant growth)");

        try {
            const response = await fetch('/api/microscope/timelapse/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    camera_name: cameraName,
                    session_name: sessionName,
                    interval_minutes: interval,
                    duration_hours: duration,
                    auto_focus: autoFocus
                })
            });

            const result = await response.json();

            if (result.success) {
                showToast(`üå± Timelapse started: ${sessionName} (${duration}h, every ${interval}min)`);
                alert(`Timelapse session started!\n\nSession: ${sessionName}\nDuration: ${duration} hours\nInterval: ${interval} minutes\nTotal shots: ${result.session_info.total_shots}\n\nImages will be saved to: ${result.session_info.session_dir}`);
            } else {
                alert('Failed to start timelapse: ' + (result.error || 'Unknown error'));
            }

        } catch (error) {
            console.error('Failed to start timelapse:', error);
            alert('Failed to start timelapse');
        }
    }

    async function getTimelapseStatus(cameraName) {
        try {
            const response = await fetch(`/api/microscope/timelapse/status/${cameraName}`);
            const result = await response.json();

            if (result.success) {
                let message = `Timelapse Status for ${cameraName}:\n\n`;

                if (result.status.active_sessions && result.status.active_sessions.length > 0) {
                    message += "ACTIVE SESSIONS:\n";
                    result.status.active_sessions.forEach(session => {
                        message += `- ${session.session_name}: ${session.status} (${session.shots_taken || 0}/${session.total_shots} shots)\n`;
                    });
                } else {
                    message += "No active timelapse sessions.\n";
                }

                if (result.status.recent_sessions && result.status.recent_sessions.length > 0) {
                    message += "\nRECENT SESSIONS:\n";
                    result.status.recent_sessions.slice(-3).forEach(session => {
                        message += `- ${session.session_name}: ${session.status}\n`;
                    });
                }

                alert(message);
            } else {
                alert('Failed to get timelapse status');
            }

        } catch (error) {
            console.error('Failed to get timelapse status:', error);
            alert('Failed to get timelapse status');
        }
    }

    async function createTimelapseVideo() {
        const sessionDir = prompt("Enter session directory path (e.g., 'data/timelapse/basil_germination_20251218_143000'):");
        if (!sessionDir) return;

        const fps = parseInt(prompt("Video FPS (frames per second):", "30")) || 30;
        const addTimestamp = confirm("Add timestamp overlay to video?");

        try {
            const response = await fetch('/api/microscope/timelapse/video', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_dir: sessionDir,
                    fps: fps,
                    add_timestamp: addTimestamp
                })
            });

            const result = await response.json();

            if (result.success) {
                showToast(`üé¨ Timelapse video created: ${result.video_path}`);
                alert(`Video created successfully!\n\nPath: ${result.video_path}\nFPS: ${fps}\nTimestamp overlay: ${addTimestamp ? 'Yes' : 'No'}`);
            } else {
                alert('Failed to create video: ' + (result.error || 'Unknown error'));
            }

        } catch (error) {
            console.error('Failed to create timelapse video:', error);
            alert('Failed to create video');
        }
    }

    async function startQuickTimelapse() {
        const plantName = prompt("What plant are you monitoring? (e.g., 'basil', 'tomato seeds'):");
        if (!plantName) return;

        const sessionName = `${plantName.replace(/\s+/g, '_')}_germination`;
        const confirmed = confirm(`Start timelapse for "${plantName}"?\n\n- 10-minute intervals\n- 24-hour duration\n- Auto-focus enabled\n- Session: ${sessionName}`);

        if (!confirmed) return;

        try {
            const response = await fetch('/api/microscope/timelapse/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    camera_name: "microscope", // Will use first available microscope
                    session_name: sessionName,
                    interval_minutes: 10,
                    duration_hours: 24,
                    auto_focus: true
                })
            });

            const result = await response.json();

            if (result.success) {
                showToast(`üå± Germination timelapse started for ${plantName}!`);
                alert(`Germination monitoring started!\n\nPlant: ${plantName}\nSession: ${sessionName}\nDuration: 24 hours\nInterval: 10 minutes\nTotal shots: ${result.session_info.total_shots}\n\nPosition your microscope over the germinating seeds now!`);
            } else {
                alert('Failed to start timelapse: ' + (result.error || 'Unknown error'));
            }

        } catch (error) {
            console.error('Failed to start quick timelapse:', error);
            alert('Failed to start timelapse');
        }
    }

    async function analyzePlantGrowth() {
        const sessionDir = prompt("Enter session directory path to analyze:");
        if (!sessionDir) return;

        try {
            const response = await fetch('/api/microscope/analyze-growth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_dir: sessionDir
                })
            });

            const result = await response.json();

            if (result.success) {
                let message = `Growth Analysis Results:\n\n`;
                message += `Session: ${result.analysis.session_name}\n`;
                message += `Total Images: ${result.analysis.total_images}\n\n`;
                message += `Analysis Results:\n`;

                for (const [key, value] of Object.entries(result.analysis.analysis)) {
                    message += `- ${key}: ${value}\n`;
                }

                message += `\nRecommendations:\n`;
                result.analysis.recommendations.forEach(rec => {
                    message += `- ${rec}\n`;
                });

                alert(message);
            } else {
                alert('Failed to analyze growth: ' + (result.error || 'Unknown error'));
            }

        } catch (error) {
            console.error('Failed to analyze plant growth:', error);
            alert('Failed to analyze growth');
        }
    }

    // Touch support for mobile
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.ptz-btn').forEach(btn => {
            btn.addEventListener('touchstart', function (e) {
                e.preventDefault();
                this.dispatchEvent(new Event('mousedown'));
            });
            btn.addEventListener('touchend', function (e) {
                e.preventDefault();
                this.dispatchEvent(new Event('mouseup'));
            });
        });
    });

    // Audio Control Functions
    function toggleAudioPanel(cameraName) {
        const panel = document.getElementById('audio-panel-' + cameraName);
        if (panel) {
            panel.classList.toggle('hidden');
        }
    }

    function openAudioPlayer(cameraName) {
        window.open('/api/audio/player/' + cameraName, 'audio-' + cameraName, 'width=900,height=700');
    }

    async function openInVLC(cameraName) {
        try {
            const response = await fetch('/api/audio/info/' + cameraName);
            const data = await response.json();
            if (data.rtsp_url_full) {
                // Try to open VLC protocol handler
                window.location.href = 'vlc://' + data.rtsp_url_full;
                // Also show the URL for manual copy
                const statusEl = document.getElementById('audio-status-' + cameraName);
                if (statusEl) {
                    statusEl.innerHTML = 'üé¨ Opening VLC... If it doesn\'t open, copy the RTSP URL.';
                }
            }
        } catch (err) {
            console.error('Failed to get RTSP URL:', err);
            alert('Failed to get stream URL. Make sure camera is connected.');
        }
    }

    async function copyRtspUrl(cameraName) {
        try {
            const response = await fetch('/api/audio/info/' + cameraName);
            const data = await response.json();
            if (data.rtsp_url_full) {
                await navigator.clipboard.writeText(data.rtsp_url_full);
                const statusEl = document.getElementById('audio-status-' + cameraName);
                if (statusEl) {
                    statusEl.innerHTML = '‚úÖ RTSP URL copied to clipboard!';
                    setTimeout(() => {
                        statusEl.innerHTML = 'Ready to listen';
                    }, 3000);
                }
            }
        } catch (err) {
            console.error('Failed to copy RTSP URL:', err);
            alert('Failed to copy URL. See console for details.');
        }
    }

    // Camera Naming Functions
    let currentRenameCameraId = null;

    function openRenameDialog(cameraId) {
        currentRenameCameraId = cameraId;
        document.getElementById('rename-camera-id').textContent = cameraId;
        document.getElementById('rename-input').value = '';
        const dialog = document.getElementById('rename-dialog');
        dialog.classList.remove('hidden');
        dialog.classList.add('flex');
        document.getElementById('rename-input').focus();
    }

    function closeRenameDialog() {
        const dialog = document.getElementById('rename-dialog');
        dialog.classList.add('hidden');
        dialog.classList.remove('flex');
        currentRenameCameraId = null;
    }

    async function saveCameraName() {
        const newName = document.getElementById('rename-input').value.trim();
        if (!newName) {
            alert('Please enter a name for the camera.');
            return;
        }

        try {
            const response = await fetch('/api/camera-names/set', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    camera_id: currentRenameCameraId,
                    name: newName
                })
            });

            const result = await response.json();

            if (result.success) {
                // Update the display name in the UI
                const nameElement = document.getElementById('camera-name-' + currentRenameCameraId);
                if (nameElement) {
                    nameElement.innerHTML = `${newName} <span style="font-size: 0.8rem; color: #6b7280; font-weight: normal;">(${currentRenameCameraId})</span>`;
                }

                showToast(`Camera renamed to "${newName}"`);
                closeRenameDialog();
            } else {
                alert('Failed to rename camera: ' + (result.error || 'Unknown error'));
            }
        } catch (err) {
            console.error('Failed to rename camera:', err);
            alert('Failed to rename camera. See console for details.');
        }
    }

    // Close dialog on Escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && !document.getElementById('rename-dialog').classList.contains('hidden')) {
            closeRenameDialog();
        }
    });

    // Close dialog when clicking outside
    document.getElementById('rename-dialog').addEventListener('click', function (e) {
        if (e.target === this) {
            closeRenameDialog();
        }
    });

    // Ring-specific functions
    async function viewRingLiveStream(deviceId) {
        window.open(`/stream/ring_${deviceId}`, `ring-${deviceId}`, 'width=900,height=700');
    }

    async function getRingSnapshot(deviceId) {
        const img = document.querySelector(`img[src*="/api/ring/snapshot/${deviceId}"]`);
        if (img) {
            img.src = `/api/ring/snapshot/${deviceId}?t=${Date.now()}`;
            showToast('Ring snapshot refreshed');
        }
    }

    // Toast notification function
    function showToast(message) {
        // Remove existing toast
        const existingToast = document.querySelector('.toast-notification');
        if (existingToast) {
            existingToast.remove();
        }

        // Create new toast
        const toast = document.createElement('div');
        toast.className = 'toast-notification glass border-white/10';
        toast.style.cssText = `
        position: fixed;
        bottom: 40px;
        right: 40px;
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        padding: 1rem 1.5rem;
        border-radius: 1rem;
        box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
        z-index: 2000;
        font-size: 0.75rem;
        font-weight: 900;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        backdrop-filter: blur(20px);
    `;
        toast.innerHTML = `<i class="fas fa-check-circle mr-2 text-xs"></i> ${message}`;

        document.body.appendChild(toast);

        // Show toast
        setTimeout(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateY(0)';
        }, 10);

        // Hide toast after 3 seconds
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(10px)';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 400);
        }, 3000);
    }
</script>
{% endblock %}