{% extends "base.html" %}

{% block title %}Weather Monitoring - Tapo Camera MCP{% endblock %}

{% block extra_css %}
<style>
    .weather-dashboard {
        padding: 20px;
    }
    
    .weather-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .weather-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        position: relative;
        overflow: hidden;
    }
    
    .weather-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #3b82f6, #10b981);
    }
    
    .weather-card h3 {
        margin: 0 0 16px 0;
        color: #1f2937;
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .weather-value {
        font-size: 32px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 8px;
    }
    
    .weather-unit {
        color: #6b7280;
        font-size: 14px;
    }
    
    .weather-trend {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 12px;
        font-size: 14px;
    }
    
    .trend-up {
        color: #dc2626;
    }
    
    .trend-down {
        color: #059669;
    }
    
    .trend-stable {
        color: #6b7280;
    }
    
    .health-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .health-excellent {
        background-color: #d1fae5;
        color: #065f46;
    }
    
    .health-good {
        background-color: #dbeafe;
        color: #1e40af;
    }
    
    .health-fair {
        background-color: #fef3c7;
        color: #92400e;
    }
    
    .health-poor {
        background-color: #fee2e2;
        color: #991b1b;
    }
    
    .stations-section {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        margin-bottom: 20px;
    }
    
    .station-card {
        background: #f9fafb;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 16px;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
    }
    
    .station-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    
    .station-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }
    
    .station-name {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
    }
    
    .station-location {
        color: #6b7280;
        font-size: 14px;
    }
    
    .station-status {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
    
    .status-online {
        background-color: #10b981;
    }
    
    .status-offline {
        background-color: #ef4444;
    }
    
    .station-modules {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }
    
    .module-card {
        background: white;
        border-radius: 6px;
        padding: 16px;
        border: 1px solid #e5e7eb;
    }
    
    .module-name {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
    }
    
    .module-data {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }
    
    .data-item {
        text-align: center;
    }
    
    .data-value {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
    }
    
    .data-label {
        font-size: 11px;
        color: #6b7280;
        margin-top: 2px;
    }
    
    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        margin-top: 20px;
    }
    
    .chart-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .chart-tab {
        padding: 8px 16px;
        border: none;
        background: none;
        color: #6b7280;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease;
    }
    
    .chart-tab.active {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
    }
    
    .chart-placeholder {
        height: 300px;
        background: #f9fafb;
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        font-size: 16px;
    }
    
    .setup-notice {
        background: #fef3c7;
        border: 1px solid #f59e0b;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .setup-notice h3 {
        margin: 0 0 12px 0;
        color: #92400e;
        font-size: 18px;
    }
    
    .setup-notice p {
        margin: 0;
        color: #92400e;
    }
    
    .setup-notice a {
        color: #92400e;
        text-decoration: underline;
        font-weight: 500;
    }
    
    .setup-notice a:hover {
        color: #78350f;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .section-title {
        font-size: 24px;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
    }
    
    .section-subtitle {
        color: #6b7280;
        margin: 4px 0 0 0;
        font-size: 14px;
    }
    
    .alert-section {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
    }
    
    .alert-item {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
    }
    
    .alert-item.info {
        background: #eff6ff;
        border-color: #bfdbfe;
    }
    
    .alert-item.warning {
        background: #fffbeb;
        border-color: #fed7aa;
    }
    
    .alert-item.success {
        background: #f0fdf4;
        border-color: #bbf7d0;
    }
    
    .alert-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .alert-title {
        font-weight: 600;
        color: #1f2937;
    }
    
    .alert-time {
        font-size: 12px;
        color: #6b7280;
    }
    
    .alert-description {
        color: #4b5563;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div class="weather-dashboard">
    <div class="page-header">
        <h1>üå°Ô∏è Weather Monitoring</h1>
        <p>Indoor air quality (Netatmo) and external weather (Vienna) side by side</p>
    </div>
    
    <!-- Two-Column Layout: Internal vs External -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 30px;">
        
        <!-- Internal Weather (Netatmo) -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 24px; color: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h2 style="margin: 0; font-size: 20px; font-weight: 600;">üè† Indoor</h2>
                    <p style="margin: 4px 0 0 0; opacity: 0.8; font-size: 14px;" id="internal-location">Netatmo Weather Station</p>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 48px; font-weight: 700;" id="internal-temp">--¬∞</div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; opacity: 0.8;">Humidity</div>
                    <div style="font-size: 20px; font-weight: 600;" id="internal-humidity">--%</div>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; opacity: 0.8;">CO2</div>
                    <div style="font-size: 20px; font-weight: 600;" id="internal-co2">-- ppm</div>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; opacity: 0.8;">Pressure</div>
                    <div style="font-size: 20px; font-weight: 600;" id="internal-pressure">-- hPa</div>
                </div>
            </div>
            <div style="margin-top: 12px; display: flex; gap: 12px;">
                <div style="background: rgba(255,255,255,0.15); padding: 8px 12px; border-radius: 8px; font-size: 12px;">
                    üîá <span id="internal-noise">--</span> dB
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 8px 12px; border-radius: 8px; font-size: 12px;" id="internal-trend">
                    üìà Stable
                </div>
            </div>
        </div>
        
        <!-- External Weather (Vienna) -->
        <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 16px; padding: 24px; color: white;" id="external-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h2 style="margin: 0; font-size: 20px; font-weight: 600;">üåç Vienna</h2>
                    <p style="margin: 4px 0 0 0; opacity: 0.8; font-size: 14px;" id="external-description">Loading...</p>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 48px; font-weight: 700;" id="external-temp">--¬∞</div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; opacity: 0.8;">Humidity</div>
                    <div style="font-size: 20px; font-weight: 600;" id="external-humidity">--%</div>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; opacity: 0.8;">Wind</div>
                    <div style="font-size: 20px; font-weight: 600;" id="external-wind">-- km/h</div>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; opacity: 0.8;">Clouds</div>
                    <div style="font-size: 20px; font-weight: 600;" id="external-clouds">--%</div>
                </div>
            </div>
            <div style="margin-top: 12px; display: flex; gap: 12px;">
                <div style="background: rgba(255,255,255,0.15); padding: 8px 12px; border-radius: 8px; font-size: 12px;">
                    üìä <span id="external-pressure">--</span> hPa
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 8px 12px; border-radius: 8px; font-size: 12px;" id="external-daynight">
                    üåô Night
                </div>
            </div>
        </div>
    </div>
    
    <!-- 5-Day Forecast -->
    <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 30px;">
        <h3 style="margin: 0 0 16px 0; color: #1f2937;">üìÖ 5-Day Forecast (Vienna)</h3>
        <div id="forecast-container" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px;">
            <!-- Forecast will be loaded dynamically -->
            <div style="text-align: center; padding: 16px; background: #f3f4f6; border-radius: 8px;">
                <div style="color: #6b7280;">Loading...</div>
            </div>
        </div>
    </div>
    
    <!-- Detailed Weather Cards -->
    <h3 style="margin: 0 0 16px 0; color: #1f2937;">üìä Indoor Details (Netatmo)</h3>
    <div class="weather-overview">
        <div class="weather-card">
            <h3>üå°Ô∏è Temperature</h3>
            <div class="weather-value" id="card-temp">--¬∞</div>
            <div class="weather-unit">Celsius</div>
            <div class="weather-trend trend-stable" id="card-temp-trend">
                <span>Loading...</span>
            </div>
        </div>
        
        <div class="weather-card">
            <h3>üíß Humidity</h3>
            <div class="weather-value" id="card-humidity">--%</div>
            <div class="weather-unit">Relative</div>
        </div>
        
        <div class="weather-card">
            <h3>üí® CO2 Level</h3>
            <div class="weather-value" id="card-co2">--</div>
            <div class="weather-unit">ppm</div>
            <div class="health-indicator health-excellent" id="card-co2-status">
                <span>--</span>
            </div>
        </div>
        
        <div class="weather-card">
            <h3>üîá Noise Level</h3>
            <div class="weather-value" id="card-noise">--</div>
            <div class="weather-unit">dB</div>
        </div>
        
        <div class="weather-card">
            <h3>üìä Pressure</h3>
            <div class="weather-value" id="card-pressure">--</div>
            <div class="weather-unit">hPa</div>
            <div class="weather-trend" id="card-pressure-trend">
                <span>--</span>
            </div>
        </div>
        
        <div class="weather-card">
            <h3>üå°Ô∏è Diff Indoor/Outdoor</h3>
            <div class="weather-value" id="card-temp-diff">--¬∞</div>
            <div class="weather-unit">Warmer inside</div>
        </div>
    </div>
    
    <!-- Weather Stations Section -->
    <div class="stations-section">
        <div class="section-header">
            <div>
                <h2 class="section-title">üè† Weather Stations</h2>
                <p class="section-subtitle">Netatmo indoor weather stations and connected modules</p>
            </div>
        </div>
        
        <!-- Mock Station Card -->
        <div class="station-card">
            <div class="station-header">
                <div>
                    <div class="station-name">Living Room Weather Station</div>
                    <div class="station-location">Living Room</div>
                </div>
                <div class="station-status">
                    <div class="status-indicator status-online"></div>
                    <span>Online</span>
                </div>
            </div>
            
            <div class="station-modules">
                <div class="module-card">
                    <div class="module-name">Main Module (Indoor)</div>
                    <div class="module-data">
                        <div class="data-item">
                            <div class="data-value">22.3¬∞C</div>
                            <div class="data-label">Temperature</div>
                        </div>
                        <div class="data-item">
                            <div class="data-value">45%</div>
                            <div class="data-label">Humidity</div>
                        </div>
                        <div class="data-item">
                            <div class="data-value">420ppm</div>
                            <div class="data-label">CO2</div>
                        </div>
                        <div class="data-item">
                            <div class="data-value">35dB</div>
                            <div class="data-label">Noise</div>
                        </div>
                    </div>
                </div>
                
                <div class="module-card">
                    <div class="module-name">Outdoor Module</div>
                    <div class="module-data">
                        <div class="data-item">
                            <div class="data-value">18.7¬∞C</div>
                            <div class="data-label">Temperature</div>
                        </div>
                        <div class="data-item">
                            <div class="data-value">62%</div>
                            <div class="data-label">Humidity</div>
                        </div>
                        <div class="data-item">
                            <div class="data-value">92%</div>
                            <div class="data-label">Battery</div>
                        </div>
                        <div class="data-item">
                            <div class="data-value">Good</div>
                            <div class="data-label">Signal</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Historical Data Charts -->
    <div class="chart-container">
        <div class="section-header">
            <div>
                <h3 class="section-title">üìä Historical Data</h3>
                <p class="section-subtitle">Track environmental trends over time</p>
            </div>
        </div>
        
        <div style="margin-bottom: 16px;">
            <button class="btn btn-secondary" onclick="changeTimeRange('24h')" id="btn-24h" style="margin-right: 8px;">24 Hours</button>
            <button class="btn btn-secondary" onclick="changeTimeRange('7d')" id="btn-7d" style="margin-right: 8px;">7 Days</button>
            <button class="btn btn-secondary" onclick="changeTimeRange('30d')" id="btn-30d">30 Days</button>
        </div>
        
        <div class="chart-tabs">
            <button class="chart-tab active" data-chart="temperature" onclick="switchChart('temperature')">üå°Ô∏è Temperature</button>
            <button class="chart-tab" data-chart="humidity" onclick="switchChart('humidity')">üíß Humidity</button>
            <button class="chart-tab" data-chart="co2" onclick="switchChart('co2')">üí® CO2 Levels</button>
            <button class="chart-tab" data-chart="pressure" onclick="switchChart('pressure')">üìä Pressure</button>
        </div>
        
        <div style="position: relative; height: 400px; margin-top: 20px;">
            <canvas id="environmentChart"></canvas>
        </div>
        
        <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
            <strong>‚ö†Ô∏è CO2 Alert Threshold:</strong>
            <span style="margin-left: 16px;">Headache Danger: <span style="color: #dc2626; font-weight: bold;">‚â•1000 ppm</span> - Ventilate immediately!</span>
            <span style="margin-left: 16px;">Warning Level: <span style="color: #f59e0b;">‚â•800 ppm</span></span>
        </div>
    </div>
    
    <!-- CO2 Alert Section -->
    <div class="alert-section" id="co2-alert-section" style="display: none;">
        <h3>üö® CO2 Alert - Headache Danger!</h3>
        <div id="co2-alert-container">
            <!-- CO2 alerts will be populated here -->
        </div>
    </div>
    
    <!-- Health Recommendations -->
    <div class="alert-section">
        <h3>üí° Health Recommendations</h3>
        <p>Optimize your indoor environment based on current readings</p>
        
        <div class="alert-item info">
            <div class="alert-header">
                <div class="alert-title">Optimal Temperature Range</div>
                <div class="alert-time">Current: 22.3¬∞C</div>
            </div>
            <div class="alert-description">Temperature is within the ideal range of 20-24¬∞C for comfort and energy efficiency.</div>
        </div>
        
        <div class="alert-item success">
            <div class="alert-header">
                <div class="alert-title">Excellent Air Quality</div>
                <div class="alert-time">CO2: 420ppm</div>
            </div>
            <div class="alert-description">CO2 levels are excellent. Your indoor air quality is optimal for health and productivity.</div>
        </div>
        
        <div class="alert-item info">
            <div class="alert-header">
                <div class="alert-title">Comfortable Humidity</div>
                <div class="alert-time">Current: 45%</div>
            </div>
            <div class="alert-description">Humidity is within the ideal range of 40-60%. No action needed.</div>
        </div>
        
        <div class="alert-item warning">
            <div class="alert-header">
                <div class="alert-title">Monitor Outdoor Module Battery</div>
                <div class="alert-time">Battery: 92%</div>
            </div>
            <div class="alert-description">Outdoor module battery is good but consider replacement when it drops below 20%.</div>
        </div>
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Global variables
let environmentChart = null;
let currentChartType = 'temperature';
let currentTimeRange = '24h';
let chartData = {
    temperature: { labels: [], values: [] },
    humidity: { labels: [], values: [] },
    co2: { labels: [], values: [], alerts: [] },
    pressure: { labels: [], values: [] }
};

// Initialize chart
function initChart() {
    const ctx = document.getElementById('environmentChart');
    if (!ctx) return;
    
    const config = getChartConfig(currentChartType);
    environmentChart = new Chart(ctx, config);
}

// Get chart configuration based on type
function getChartConfig(chartType) {
    const colors = {
        temperature: { color: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },
        humidity: { color: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },
        co2: { color: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },
        pressure: { color: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' }
    };
    
    const units = {
        temperature: '¬∞C',
        humidity: '%',
        co2: 'ppm',
        pressure: 'mbar'
    };
    
    const yAxisLabels = {
        temperature: 'Temperature (¬∞C)',
        humidity: 'Humidity (%)',
        co2: 'CO2 Level (ppm)',
        pressure: 'Pressure (mbar)'
    };
    
    const color = colors[chartType] || colors.temperature;
    const unit = units[chartType] || '';
    const yAxisLabel = yAxisLabels[chartType] || 'Value';
    
    const datasets = [{
        label: yAxisLabel,
        data: chartData[chartType].values || [],
        borderColor: color.color,
        backgroundColor: color.bg,
        borderWidth: 2,
        fill: true,
        tension: 0.4,
        pointRadius: 2,
        pointHoverRadius: 5
    }];
    
    // Add CO2 alert threshold line
    if (chartType === 'co2') {
        datasets.push({
            label: 'Warning Threshold (800 ppm)',
            data: (chartData.co2.values || []).map(() => 800),
            borderColor: '#f59e0b',
            backgroundColor: 'transparent',
            borderWidth: 2,
            borderDash: [5, 5],
            fill: false,
            pointRadius: 0
        });
        datasets.push({
            label: 'Danger Threshold (1000 ppm)',
            data: (chartData.co2.values || []).map(() => 1000),
            borderColor: '#dc2626',
            backgroundColor: 'transparent',
            borderWidth: 2,
            borderDash: [5, 5],
            fill: false,
            pointRadius: 0
        });
    }
    
    return {
        type: 'line',
        data: {
            labels: chartData[chartType].labels || [],
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toFixed(1) + ' ' + unit;
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Time'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: yAxisLabel
                    },
                    beginAtZero: chartType === 'humidity' || chartType === 'co2'
                }
            }
        }
    };
}

// Switch chart type
function switchChart(chartType) {
    currentChartType = chartType;
    
    // Update tab states
    document.querySelectorAll('.chart-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-chart="${chartType}"]`).classList.add('active');
    
    // Update chart
    if (environmentChart) {
        const config = getChartConfig(chartType);
        environmentChart.data.labels = config.data.labels;
        environmentChart.data.datasets = config.data.datasets;
        environmentChart.options.scales.y.title.text = config.options.scales.y.title.text;
        environmentChart.update();
    }
}

// Load chart data
async function loadChartData() {
    try {
        // Get station data
        const stationsResponse = await fetch('/api/weather/stations');
        const stations = await stationsResponse.json();
        
        if (!stations || stations.length === 0) {
            updateChartPlaceholder('No weather stations configured');
            return;
        }
        
        const station = stations[0]; // Use first station
        const stationId = station.station_id;
        
        // Get historical data for all metrics
        const timeRange = currentTimeRange === '24h' ? '24h' : currentTimeRange === '7d' ? '7d' : '30d';
        
        const metrics = ['temperature', 'humidity', 'co2', 'pressure'];
        const dataPromises = metrics.map(metric => 
            fetch(`/api/weather/stations/${stationId}/historical?data_type=${metric}&time_range=${timeRange}`)
                .then(r => r.json())
                .catch(e => {
                    console.error(`Error loading ${metric} data:`, e);
                    return { data_points: [] };
                })
        );
        
        const [tempData, humidityData, co2Data, pressureData] = await Promise.all(dataPromises);
        
        // Process data for each metric
        processMetricData('temperature', tempData.data_points || []);
        processMetricData('humidity', humidityData.data_points || []);
        processMetricData('co2', co2Data.data_points || []);
        processMetricData('pressure', pressureData.data_points || []);
        
        // Update current values in overview cards
        updateOverviewCards(stationId);
        
        // Update chart
        if (environmentChart) {
            const config = getChartConfig(currentChartType);
            environmentChart.data.labels = config.data.labels;
            environmentChart.data.datasets = config.data.datasets;
            environmentChart.update('none');
        } else {
            initChart();
        }
        
        // Check for CO2 alerts
        checkCO2Alerts();
        
    } catch (error) {
        console.error('Error loading chart data:', error);
        updateChartPlaceholder('Error loading data: ' + error.message);
    }
}

// Process metric data
function processMetricData(metric, dataPoints) {
    if (!dataPoints || dataPoints.length === 0) {
        chartData[metric] = { labels: [], values: [], alerts: [] };
        return;
    }
    
    // Normalize timestamps (database returns Unix timestamps in seconds)
    const normalized = dataPoints.map(point => ({
        ...point,
        timestamp: typeof point.timestamp === 'number' ? point.timestamp : new Date(point.timestamp).getTime() / 1000
    }));
    const sorted = normalized.sort((a, b) => a.timestamp - b.timestamp);
    
    chartData[metric].labels = sorted.map(point => {
        // Handle both Unix timestamp (seconds) and ISO string
        const timestamp = typeof point.timestamp === 'number' ? point.timestamp * 1000 : new Date(point.timestamp).getTime();
        const date = new Date(timestamp);
        if (currentTimeRange === '24h') {
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit' });
    });
    
    chartData[metric].values = sorted.map(point => point.value);
    
    // Detect CO2 alerts
    if (metric === 'co2') {
        chartData.co2.alerts = sorted.filter(point => point.value >= 1000).map(point => ({
            timestamp: point.timestamp,
            value: point.value,
            severity: point.value >= 1000 ? 'danger' : 'warning'
        }));
    }
}

// Update overview cards
async function updateOverviewCards(stationId) {
    try {
        const dataResponse = await fetch(`/api/weather/stations/${stationId}/data?module_type=indoor`);
        const data = await dataResponse.json();
        
        if (data.data && data.data.indoor) {
            const indoor = data.data.indoor;
            
            // Update temperature
            const tempCard = document.querySelector('.weather-card:nth-child(1) .weather-value');
            if (tempCard) tempCard.textContent = indoor.temperature.toFixed(1) + '¬∞';
            
            // Update humidity
            const humidityCard = document.querySelector('.weather-card:nth-child(2) .weather-value');
            if (humidityCard) humidityCard.textContent = indoor.humidity + '%';
            
            // Update CO2
            const co2Card = document.querySelector('.weather-card:nth-child(3) .weather-value');
            if (co2Card) {
                co2Card.textContent = indoor.co2;
                
                // Update health indicator
                const healthIndicator = document.querySelector('.weather-card:nth-child(3) .health-indicator');
                if (healthIndicator) {
                    if (indoor.co2 <= 400) {
                        healthIndicator.className = 'health-indicator health-excellent';
                        healthIndicator.innerHTML = '<i class="fas fa-check-circle"></i><span>Excellent</span>';
                    } else if (indoor.co2 <= 800) {
                        healthIndicator.className = 'health-indicator health-good';
                        healthIndicator.innerHTML = '<i class="fas fa-info-circle"></i><span>Good</span>';
                    } else if (indoor.co2 < 1000) {
                        healthIndicator.className = 'health-indicator health-fair';
                        healthIndicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Fair - Ventilate</span>';
                    } else {
                        healthIndicator.className = 'health-indicator health-poor';
                        healthIndicator.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>DANGER - Headache Risk!</span>';
                    }
                }
            }
            
            // Update pressure
            const pressureCard = document.querySelector('.weather-card:nth-child(5) .weather-value');
            if (pressureCard) pressureCard.textContent = indoor.pressure.toFixed(1);
        }
    } catch (error) {
        console.error('Error updating overview cards:', error);
    }
}

// Check for CO2 alerts
function checkCO2Alerts() {
    const alerts = chartData.co2.alerts || [];
    const alertSection = document.getElementById('co2-alert-section');
    const alertContainer = document.getElementById('co2-alert-container');
    
    if (alerts.length === 0) {
        alertSection.style.display = 'none';
        return;
    }
    
    // Get current CO2 value
    const currentCO2 = chartData.co2.values[chartData.co2.values.length - 1];
    
    if (currentCO2 && currentCO2 >= 1000) {
        alertSection.style.display = 'block';
        alertContainer.innerHTML = `
            <div class="alert-item" style="background: #fee2e2; border-color: #dc2626; border-left: 4px solid #dc2626;">
                <div class="alert-header">
                    <div class="alert-title" style="color: #dc2626; font-weight: bold; font-size: 18px;">
                        üö® CO2 DANGER - HEADACHE RISK!
                    </div>
                    <div class="alert-time">Current: ${currentCO2.toFixed(0)} ppm</div>
                </div>
                <div class="alert-description" style="color: #991b1b; font-weight: 500;">
                    CO2 levels are at ${currentCO2.toFixed(0)} ppm - above the 1000 ppm danger threshold. 
                    <strong>Ventilate immediately</strong> to prevent headaches and reduce health risks!
                </div>
            </div>
        `;
        
        // Play alert sound (if browser notifications allowed)
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('CO2 Alert - Headache Danger!', {
                body: `CO2 levels at ${currentCO2.toFixed(0)} ppm - Ventilate immediately!`,
                icon: '/static/img/placeholder.svg',
                tag: 'co2-alert',
                requireInteraction: true
            });
        }
    } else if (currentCO2 && currentCO2 >= 800) {
        alertSection.style.display = 'block';
        alertContainer.innerHTML = `
            <div class="alert-item warning">
                <div class="alert-header">
                    <div class="alert-title">‚ö†Ô∏è CO2 Warning</div>
                    <div class="alert-time">Current: ${currentCO2.toFixed(0)} ppm</div>
                </div>
                <div class="alert-description">
                    CO2 levels are elevated (${currentCO2.toFixed(0)} ppm). Consider ventilating to maintain optimal air quality.
                </div>
            </div>
        `;
    } else {
        alertSection.style.display = 'none';
    }
}

// Change time range
function changeTimeRange(range) {
    currentTimeRange = range;
    
    // Update button states
    document.querySelectorAll('[id^="btn-"]').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
    });
    const btn = document.getElementById(`btn-${range}`);
    if (btn) {
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-primary');
    }
    
    loadChartData();
}

// Update chart placeholder
function updateChartPlaceholder(message) {
    const canvas = document.getElementById('environmentChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.font = '16px Arial';
    ctx.fillStyle = '#6b7280';
    ctx.textAlign = 'center';
    ctx.fillText(message, canvas.width / 2, canvas.height / 2);
}

// Request notification permission
function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Weather dashboard loaded');
    
    // Request notification permission for CO2 alerts
    requestNotificationPermission();
    
    // Load combined weather data
    loadCombinedWeather();
    setInterval(loadCombinedWeather, 60000); // Refresh every minute
    
    // Initialize chart
    setTimeout(() => {
        if (typeof Chart !== 'undefined') {
            initChart();
            loadChartData();
            
            // Refresh every 30 seconds
            setInterval(loadChartData, 30000);
        }
    }, 500);
});

// Load combined internal + external weather
async function loadCombinedWeather() {
    try {
        const response = await fetch('/api/weather/combined');
        const data = await response.json();
        
        // Update internal weather (Netatmo)
        if (data.internal && data.internal.data) {
            const indoor = data.internal.data.indoor || {};
            document.getElementById('internal-location').textContent = data.internal.location || 'Home';
            document.getElementById('internal-temp').textContent = `${indoor.temperature?.toFixed(1) || '--'}¬∞`;
            document.getElementById('internal-humidity').textContent = `${indoor.humidity || '--'}%`;
            document.getElementById('internal-co2').textContent = `${indoor.co2 || '--'} ppm`;
            document.getElementById('internal-pressure').textContent = `${indoor.pressure?.toFixed(0) || '--'} hPa`;
            document.getElementById('internal-noise').textContent = indoor.noise || '--';
            document.getElementById('internal-trend').textContent = `üìà ${indoor.temp_trend || 'Stable'}`;
            
            // Update detail cards
            document.getElementById('card-temp').textContent = `${indoor.temperature?.toFixed(1) || '--'}¬∞`;
            document.getElementById('card-humidity').textContent = `${indoor.humidity || '--'}%`;
            document.getElementById('card-co2').textContent = indoor.co2 || '--';
            document.getElementById('card-noise').textContent = indoor.noise || '--';
            document.getElementById('card-pressure').textContent = indoor.pressure?.toFixed(0) || '--';
            document.getElementById('card-temp-trend').innerHTML = `<span>${indoor.temp_trend || 'Stable'}</span>`;
            document.getElementById('card-pressure-trend').innerHTML = `<span>${indoor.pressure_trend || '--'}</span>`;
            
            // CO2 status
            const co2 = indoor.co2 || 0;
            const co2Status = document.getElementById('card-co2-status');
            if (co2 < 600) {
                co2Status.className = 'health-indicator health-excellent';
                co2Status.innerHTML = '<span>Excellent</span>';
            } else if (co2 < 800) {
                co2Status.className = 'health-indicator health-good';
                co2Status.innerHTML = '<span>Good</span>';
            } else if (co2 < 1000) {
                co2Status.className = 'health-indicator health-fair';
                co2Status.innerHTML = '<span>Fair</span>';
            } else {
                co2Status.className = 'health-indicator health-poor';
                co2Status.innerHTML = '<span>Poor</span>';
            }
            
            // Temperature difference
            if (data.external) {
                const diff = indoor.temperature - data.external.temperature;
                document.getElementById('card-temp-diff').textContent = `${diff > 0 ? '+' : ''}${diff.toFixed(1)}¬∞`;
            }
        }
        
        // Update external weather (Vienna)
        if (data.external) {
            const ext = data.external;
            document.getElementById('external-temp').textContent = `${ext.temperature?.toFixed(1) || '--'}¬∞`;
            document.getElementById('external-humidity').textContent = `${ext.humidity || '--'}%`;
            document.getElementById('external-wind').textContent = `${ext.wind_speed?.toFixed(0) || '--'} km/h`;
            document.getElementById('external-clouds').textContent = `${ext.cloud_cover || '--'}%`;
            document.getElementById('external-pressure').textContent = ext.pressure?.toFixed(0) || '--';
            document.getElementById('external-description').textContent = ext.weather_description || 'Unknown';
            document.getElementById('external-daynight').textContent = ext.is_day ? '‚òÄÔ∏è Day' : 'üåô Night';
            
            // Change card color based on weather
            const card = document.getElementById('external-card');
            if (!ext.is_day) {
                card.style.background = 'linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%)';
            } else if (ext.cloud_cover > 70) {
                card.style.background = 'linear-gradient(135deg, #606c88 0%, #3f4c6b 100%)';
            } else {
                card.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
            }
        }
        
        // Update forecast
        if (data.forecast && data.forecast.length > 0) {
            const container = document.getElementById('forecast-container');
            container.innerHTML = data.forecast.map(day => {
                const weatherIcon = getWeatherIcon(day.weather_code);
                const date = new Date(day.date);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                return `
                    <div style="text-align: center; padding: 16px; background: #f3f4f6; border-radius: 8px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">${dayName}</div>
                        <div style="font-size: 28px; margin-bottom: 8px;">${weatherIcon}</div>
                        <div style="font-size: 18px; font-weight: 600; color: #1f2937;">
                            ${day.temp_max?.toFixed(0) || '--'}¬∞
                        </div>
                        <div style="font-size: 14px; color: #6b7280;">
                            ${day.temp_min?.toFixed(0) || '--'}¬∞
                        </div>
                        <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">
                            ${day.weather_description}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
    } catch (error) {
        console.error('Error loading combined weather:', error);
    }
}

// Get weather icon from WMO code
function getWeatherIcon(code) {
    const icons = {
        0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è',
        45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
        51: 'üå¶Ô∏è', 53: 'üå¶Ô∏è', 55: 'üåßÔ∏è',
        56: 'üåßÔ∏è', 57: 'üåßÔ∏è',
        61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è',
        66: 'üåßÔ∏è', 67: 'üåßÔ∏è',
        71: 'üå®Ô∏è', 73: 'üå®Ô∏è', 75: '‚ùÑÔ∏è',
        77: 'üå®Ô∏è',
        80: 'üå¶Ô∏è', 81: 'üåßÔ∏è', 82: '‚õàÔ∏è',
        85: 'üå®Ô∏è', 86: '‚ùÑÔ∏è',
        95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è',
    };
    return icons[code] || 'üå°Ô∏è';
}
</script>
{% endblock %}
