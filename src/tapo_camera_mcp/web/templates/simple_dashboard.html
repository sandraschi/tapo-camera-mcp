{% extends "base.html" %}

{% block title %}Dashboard - Home Security MCP{% endblock %}

{% block extra_css %}
<style>
    .card {
        background: white;
        border-radius: 0.5rem;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
    }

    .security-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #dc2626;
    }

    .status-online { border-left-color: #16a34a; }
    .status-offline { border-left-color: #6b7280; }
    .status-alert { border-left-color: #dc2626; }

    .alert-critical { border-left-color: #dc2626; background-color: #fef2f2; }
    .alert-warning { border-left-color: #d97706; background-color: #fffbeb; }
    .alert-info { border-left-color: #2563eb; background-color: #eff6ff; }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        text-align: center;
        text-decoration: none;
        color: inherit;
        display: block;
    }

    [data-theme="dark"] {
        --bg-color: #1f2937;
        --text-color: #f9fafb;
        --card-bg: #374151;
        --border-color: #4b5563;
    }

    [data-theme="dark"] body {
        background-color: var(--bg-color);
        color: var(--text-color);
    }

    [data-theme="dark"] .card,
    [data-theme="dark"] .security-card,
    [data-theme="dark"] .stat-card {
        background-color: var(--card-bg);
        color: var(--text-color);
        border-color: var(--border-color);
    }
</style>
{% endblock %}

{% block content %}
    <div class="dashboard-content">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">üè† Home Security Dashboard</h1>
            <a href="/settings" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                ‚öôÔ∏è Settings
            </a>
        </div>

        <!-- Quick Links -->
        <div class="stats-grid mb-6">
            <a href="/lighting" class="stat-card hover:shadow-lg transition-shadow cursor-pointer">
                <div class="text-3xl mb-1">üí°</div>
                <div class="text-lg font-bold text-yellow-600">Lighting</div>
                <div class="text-sm text-gray-600">18 Hue lights</div>
            </a>

            <a href="/weather" class="stat-card hover:shadow-lg transition-shadow cursor-pointer">
                <div class="text-3xl mb-1">üå§Ô∏è</div>
                <div class="text-lg font-bold text-blue-600">Weather</div>
                <div class="text-sm text-gray-600">Netatmo + Vienna</div>
            </a>

            <a href="/energy" class="stat-card hover:shadow-lg transition-shadow cursor-pointer">
                <div class="text-3xl mb-1">‚ö°</div>
                <div class="text-lg font-bold text-green-600">Energy</div>
                <div class="text-sm text-gray-600">3 Tapo P115 plugs</div>
            </a>

            <a href="/cameras" class="stat-card hover:shadow-lg transition-shadow cursor-pointer">
                <div class="text-3xl mb-1">üìπ</div>
                <div class="text-lg font-bold text-purple-600">Cameras</div>
                <div class="text-sm text-gray-600">View feeds</div>
            </a>
        </div>

        <!-- Vienna Public Alerts -->
        <div class="card mb-6" id="vienna-alerts-section">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">üö® Vienna Public Alerts</h3>
                <button onclick="refreshAlerts()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div id="alerts-container">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin text-gray-400 text-2xl"></i>
                    <p class="text-gray-500 mt-2">Loading alerts...</p>
                </div>
            </div>
        </div>

        <!-- Camera Thumbnails -->
        <div class="card mb-6" id="camera-thumbnails">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-semibold">üìπ Cameras</h3>
                <a href="/cameras" class="text-blue-600 hover:text-blue-800 text-sm">View All ‚Üí</a>
            </div>
            <div id="camera-row" class="flex gap-3 overflow-x-auto pb-2">
                <div class="text-center text-gray-500 text-sm py-4 w-full">
                    <i class="fas fa-spinner fa-spin"></i> Loading cameras...
                </div>
            </div>
        </div>

        <!-- Security Systems -->
        <div class="card mt-6">
            <h3 class="text-lg font-semibold mb-4">üõ°Ô∏è Security & Safety</h3>

            <!-- Fire & CO Alarms -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <!-- Smoke/Fire Alarm -->
                <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-orange-500">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">üî•</span>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">Smoke & Fire</h4>
                            <p class="text-sm text-gray-600">Nest Protect</p>
                        </div>
                        <div class="text-right">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                ‚úì OK
                            </span>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        Last test: Monthly self-check passed
                    </div>
                </div>

                <!-- CO Alarm -->
                <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-purple-500">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">üí®</span>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">Carbon Monoxide</h4>
                            <p class="text-sm text-gray-600">Nest Protect</p>
                        </div>
                        <div class="text-right">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                ‚úì OK
                            </span>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        CO Level: 0 ppm (Safe)
                    </div>
                </div>
            </div>

            <!-- Door/Window & Motion Sensors -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Door Sensors -->
                <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-blue-500">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">üö™</span>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">Entry Points</h4>
                            <p class="text-sm text-gray-600">Doors & Windows</p>
                        </div>
                        <div class="text-right">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                All Secured
                            </span>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        Ring sensors ‚Ä¢ 0 open
                    </div>
                </div>

                <!-- Motion -->
                <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-cyan-500">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">üëÅÔ∏è</span>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">Motion Detection</h4>
                            <p class="text-sm text-gray-600">All Zones</p>
                        </div>
                        <div class="text-right">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">
                                Monitoring
                            </span>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        Last motion: Living room, 5 min ago
                    </div>
                </div>
            </div>

            <!-- Status Banner -->
            <div class="mt-4 bg-green-50 border border-green-200 rounded-lg p-3 flex items-center gap-3">
                <span class="text-2xl">‚úÖ</span>
                <div>
                    <span class="font-semibold text-green-800">All Systems Normal</span>
                    <span class="text-green-600 text-sm ml-2">No alerts</span>
                </div>
            </div>
        </div>

        <div class="mt-8 text-center">
            <a href="/help" class="text-blue-600 hover:text-blue-800 underline">
                <i class="fas fa-question-circle mr-2"></i>Help & Documentation
            </a>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Load alerts and cameras on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadAlerts();
        loadCameras();
    });
    
    async function loadCameras() {
        const container = document.getElementById('camera-row');
        
        try {
            const response = await fetch('/api/cameras');
            if (!response.ok) throw new Error('Failed to fetch cameras');
            
            const data = await response.json();
            const cameras = data.cameras || [];
            
            if (cameras.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 text-sm py-2 w-full">
                        No cameras configured. <a href="/cameras" class="text-blue-600 hover:underline">Add cameras</a>
                    </div>
                `;
                return;
            }
            
            // Build thumbnails
            let html = '';
            for (const cam of cameras) {
                const name = cam.name || cam.id || 'Camera';
                const status = cam.status === 'online' ? 'üü¢' : 'üî¥';
                const thumbUrl = `/api/cameras/${encodeURIComponent(name)}/thumbnail`;
                
                html += `
                    <a href="/cameras" class="flex-shrink-0 group">
                        <div class="bg-gray-800 rounded-lg overflow-hidden relative" style="width: 320px; height: 240px;">
                            <img src="${thumbUrl}" 
                                 alt="${name}" 
                                 class="w-full h-full object-cover"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="w-full h-full bg-gray-700 items-center justify-center text-gray-400 text-4xl hidden">
                                üìπ
                            </div>
                            <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 px-3 py-2">
                                <span class="text-white text-sm truncate block">${status} ${name}</span>
                            </div>
                        </div>
                    </a>
                `;
            }
            
            container.innerHTML = html;
            
        } catch (error) {
            console.error('Error loading cameras:', error);
            container.innerHTML = `
                <div class="text-center text-gray-500 text-sm py-2 w-full">
                    <a href="/cameras" class="text-blue-600 hover:underline">View cameras</a>
                </div>
            `;
        }
    }
    
    // Refresh alerts every 5 minutes (don't reload full page for alerts)
    setInterval(loadAlerts, 5 * 60 * 1000);
    
    async function loadAlerts() {
        const container = document.getElementById('alerts-container');
        
        try {
            const response = await fetch('/alerts/summary');
            if (!response.ok) throw new Error('Failed to fetch alerts');
            
            const data = await response.json();
            renderAlerts(data);
        } catch (error) {
            console.error('Error loading alerts:', error);
            container.innerHTML = `
                <div class="text-center py-4">
                    <p class="text-gray-500">
                        <i class="fas fa-exclamation-triangle text-yellow-500"></i> 
                        Unable to load alerts. <a href="#" onclick="loadAlerts(); return false;" class="text-blue-600 hover:underline">Retry</a>
                    </p>
                </div>
            `;
        }
    }
    
    async function refreshAlerts() {
        const container = document.getElementById('alerts-container');
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-spinner fa-spin text-gray-400 text-2xl"></i>
                <p class="text-gray-500 mt-2">Refreshing alerts...</p>
            </div>
        `;
        
        try {
            const response = await fetch('/alerts/refresh');
            if (!response.ok) throw new Error('Failed to refresh');
            
            const data = await response.json();
            // Convert to summary format
            const summary = {
                total_alerts: data.total,
                highest_severity: data.alerts.length > 0 ? data.alerts[0].severity : 'unknown',
                highest_severity_color: data.alerts.length > 0 ? data.alerts[0].severity_color : '#9CA3AF',
                highest_severity_icon: data.alerts.length > 0 ? data.alerts[0].severity_icon : '‚úì',
                alerts: data.alerts.slice(0, 5),
                status: data.total === 0 ? 'ok' : 'warning'
            };
            renderAlerts(summary);
        } catch (error) {
            console.error('Error refreshing alerts:', error);
            loadAlerts(); // Fallback to cached
        }
    }
    
    function renderAlerts(data) {
        const container = document.getElementById('alerts-container');
        
        if (data.total_alerts === 0) {
            container.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                    <div class="text-4xl mb-2">‚úÖ</div>
                    <h4 class="font-semibold text-green-800">All Clear</h4>
                    <p class="text-green-600 text-sm">No active weather or emergency alerts for Vienna</p>
                    <p class="text-green-500 text-xs mt-2">Sources: GeoSphere Austria, Meteoalarm</p>
                </div>
            `;
            return;
        }
        
        // Build alerts HTML
        let alertsHtml = `
            <div class="flex gap-4">
                <div class="flex-shrink-0 text-center px-4 py-3 rounded-lg" style="background: ${data.highest_severity_color};">
                    <div class="text-2xl">${data.highest_severity_icon}</div>
                    <div class="text-2xl font-bold text-white">${data.total_alerts}</div>
                    <div class="text-xs text-white opacity-80">Alert${data.total_alerts !== 1 ? 's' : ''}</div>
                </div>
                <div class="flex-1 space-y-2">
        `;
        
        for (const alert of data.alerts) {
            const typeIcon = getAlertTypeIcon(alert.alert_type);
            alertsHtml += `
                <div class="bg-gray-50 p-3 rounded border-l-4" style="border-left-color: ${alert.severity_color};">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">${typeIcon}</span>
                        <div class="flex-1">
                            <div class="font-medium text-gray-800 text-sm">${escapeHtml(alert.title)}</div>
                            <div class="text-xs text-gray-500">${alert.region} ‚Ä¢ ${alert.source === 'geosphere' ? 'GeoSphere' : 'Meteoalarm'}</div>
                        </div>
                        <span class="text-sm" title="${alert.severity}">${alert.severity_icon}</span>
                    </div>
                    ${alert.description ? `<p class="text-gray-600 text-xs mt-1 ml-7">${escapeHtml(truncate(alert.description, 120))}</p>` : ''}
                </div>
            `;
        }
        
        alertsHtml += `
                </div>
            </div>
            <div class="text-center text-gray-400 text-xs mt-3">
                Last updated: ${new Date().toLocaleTimeString('de-AT')} ‚Ä¢ Sources: GeoSphere Austria, Meteoalarm
            </div>
        `;
        
        container.innerHTML = alertsHtml;
    }
    
    function getAlertTypeIcon(type) {
        const icons = {
            'weather': 'üå§Ô∏è', 'storm': 'üå™Ô∏è', 'wind': 'üí®', 'rain': 'üåßÔ∏è',
            'snow': '‚ùÑÔ∏è', 'ice': 'üßä', 'fog': 'üå´Ô∏è', 'heat': 'üå°Ô∏è',
            'cold': 'ü•∂', 'thunderstorm': '‚õàÔ∏è', 'flood': 'üåä', 'fire': 'üî•'
        };
        return icons[type] || '‚ö†Ô∏è';
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function truncate(text, maxLength) {
        if (!text || text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }
</script>
{% endblock %}



