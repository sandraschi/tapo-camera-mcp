{% extends "base.html" %}

{% block title %}Dashboard - Home Security MCP{% endblock %}

{% block extra_css %}
<style>
    .card {
        background: white;
        border-radius: 0.5rem;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
    }

    .security-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #dc2626;
    }

    .status-online { border-left-color: #16a34a; }
    .status-offline { border-left-color: #6b7280; }
    .status-alert { border-left-color: #dc2626; }

    .alert-critical { border-left-color: #dc2626; background-color: #fef2f2; }
    .alert-warning { border-left-color: #d97706; background-color: #fffbeb; }
    .alert-info { border-left-color: #2563eb; background-color: #eff6ff; }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        text-align: center;
        text-decoration: none;
        color: inherit;
        display: block;
    }

    [data-theme="dark"] {
        --bg-color: #1f2937;
        --text-color: #f9fafb;
        --card-bg: #374151;
        --border-color: #4b5563;
    }

    [data-theme="dark"] body {
        background-color: var(--bg-color);
        color: var(--text-color);
    }

    [data-theme="dark"] .card,
    [data-theme="dark"] .security-card,
    [data-theme="dark"] .stat-card {
        background-color: var(--card-bg);
        color: var(--text-color);
        border-color: var(--border-color);
    }
</style>
{% endblock %}

{% block content %}
    <div class="dashboard-content">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">üè† Home Security Dashboard</h1>
            <a href="/settings" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                ‚öôÔ∏è Settings
            </a>
        </div>

        <!-- Quick Links -->
        <div class="stats-grid mb-6">
            <a href="/lighting" class="stat-card hover:shadow-lg transition-shadow cursor-pointer">
                <div class="text-3xl mb-1">üí°</div>
                <div class="text-lg font-bold text-yellow-600">Lighting</div>
                <div class="text-sm text-gray-600">18 Hue lights</div>
            </a>

            <a href="/weather" class="stat-card hover:shadow-lg transition-shadow cursor-pointer">
                <div class="text-3xl mb-1">üå§Ô∏è</div>
                <div class="text-lg font-bold text-blue-600">Weather</div>
                <div class="text-sm text-gray-600">Netatmo + Vienna</div>
            </a>

            <a href="/energy" class="stat-card hover:shadow-lg transition-shadow cursor-pointer">
                <div class="text-3xl mb-1">‚ö°</div>
                <div class="text-lg font-bold text-green-600">Energy</div>
                <div class="text-sm text-gray-600">3 Tapo P115 plugs</div>
            </a>

            <a href="/cameras" class="stat-card hover:shadow-lg transition-shadow cursor-pointer">
                <div class="text-3xl mb-1">üìπ</div>
                <div class="text-lg font-bold text-purple-600">Cameras</div>
                <div class="text-sm text-gray-600">View feeds</div>
            </a>
        </div>

        <!-- Vienna Public Alerts -->
        <div class="card mb-6" id="vienna-alerts-section">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">üö® Vienna Public Alerts</h3>
                <button onclick="refreshAlerts()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div id="alerts-container">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin text-gray-400 text-2xl"></i>
                    <p class="text-gray-500 mt-2">Loading alerts...</p>
                </div>
            </div>
        </div>

        <!-- Security Systems -->
        <div class="security-card mt-6">
            <h3 class="text-lg font-semibold mb-4 text-red-800">
                üè† Security Systems
            </h3>

            <!-- System Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white p-4 rounded border">
                    <h3 class="font-semibold text-gray-800">System Status</h3>
                    <div class="mt-2">
                        {% if security_overview and security_overview.systems %}
                            {% for system_name, system_data in security_overview.systems.items() %}
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-sm capitalize">{{ system_name.replace('_', ' ') }}</span>
                                    <span class="text-xs px-2 py-1 rounded
                                        {% if system_data.get('health') == 'online' or system_data.get('online_devices', 0) > 0 %}bg-green-100 text-green-800
                                        {% elif system_data.get('error') %}bg-red-100 text-red-800
                                        {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                        {% if system_data.get('error') %}Error
                                        {% elif system_data.get('health') == 'online' or system_data.get('online_devices', 0) > 0 %}Online
                                        {% else %}Offline{% endif %}
                                    </span>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-sm text-gray-500">No security systems configured</p>
                        {% endif %}
                    </div>
                </div>

                <div class="bg-white p-4 rounded border">
                    <h3 class="font-semibold text-gray-800">Device Summary</h3>
                    <div class="mt-2 text-2xl font-bold text-blue-600">
                        {{ (security_overview.total_devices if security_overview else 0)|default(0) }}
                    </div>
                    <p class="text-sm text-gray-600">
                        {{ (security_overview.online_devices if security_overview else 0)|default(0) }} online
                    </p>
                </div>

                <div class="bg-white p-4 rounded border">
                    <h3 class="font-semibold text-gray-800">Active Alerts</h3>
                    <div class="mt-2 text-2xl font-bold text-red-600">
                        {{ security_alerts|length }}
                    </div>
                    <p class="text-sm text-gray-600">
                        {% if security_alerts %}
                            Requires attention
                        {% else %}
                            All clear
                        {% endif %}
                    </p>
                </div>
            </div>

            <!-- Security Devices -->
            {% if security_devices %}
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 text-gray-800">Security Devices</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for device in security_devices %}
                    <div class="bg-white p-4 rounded border-l-4
                                {% if device.status == 'online' %}border-green-500
                                {% elif device.status == 'alert' %}border-red-500
                                {% else %}border-gray-300{% endif %}">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold">{{ device.name }}</h4>
                            <span class="px-2 py-1 rounded text-xs
                                       {% if device.status == 'online' %}bg-green-100 text-green-800
                                       {% elif device.status == 'alert' %}bg-red-100 text-red-800
                                       {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ device.status }}
                            </span>
                        </div>

                        <div class="text-sm text-gray-600 space-y-1">
                            <p><strong>Type:</strong> {{ device.type.replace('_', ' ') }}</p>
                            {% if device.battery_level is not none %}
                            <p><strong>Battery:</strong> {{ device.battery_level }}%</p>
                            {% endif %}
                            {% if device.location %}
                            <p><strong>Location:</strong> {{ device.location }}</p>
                            {% endif %}
                            {% if device.last_seen %}
                            <p><strong>Last Seen:</strong> {{ device.last_seen.strftime('%H:%M %m/%d') }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Active Security Alerts -->
            {% if security_alerts %}
            <div class="bg-red-100 border border-red-300 rounded p-4">
                <h3 class="font-bold text-red-800 mb-3">üö® Active Security Alerts</h3>
                <div class="space-y-2">
                    {% for alert in security_alerts %}
                    <div class="bg-white p-3 rounded border-l-4
                                {% if alert.severity == 'critical' %}border-red-500
                                {% elif alert.severity == 'warning' %}border-yellow-500
                                {% else %}border-blue-500{% endif %}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">
                                    {{ alert.device_name }} - {{ alert.alert_type.title() }}
                                </p>
                                <p class="text-sm text-gray-600 mt-1">{{ alert.message }}</p>
                                <p class="text-xs text-gray-500 mt-1">
                                    {{ alert.timestamp.strftime('%H:%M %m/%d/%Y') }}
                                </p>
                            </div>
                            <span class="px-2 py-1 rounded text-xs font-semibold
                                       {% if alert.severity == 'critical' %}bg-red-100 text-red-800
                                       {% elif alert.severity == 'warning' %}bg-yellow-100 text-yellow-800
                                       {% else %}bg-blue-100 text-blue-800{% endif %}">
                                {{ alert.severity.upper() }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
                <div class="bg-green-100 border border-green-300 rounded p-4">
                    <div class="flex items-center">
                        <span class="text-green-600 text-xl mr-3">‚úÖ</span>
                        <div>
                            <h3 class="font-semibold text-green-800">All Clear</h3>
                            <p class="text-sm text-green-700">No active security alerts</p>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

        <div class="mt-8 text-center">
            <a href="/help" class="text-blue-600 hover:text-blue-800 underline">
                <i class="fas fa-question-circle mr-2"></i>Help & Documentation
            </a>
        </div>
    </div>

    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Load alerts on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadAlerts();
    });
    
    // Refresh alerts every 5 minutes (don't reload full page for alerts)
    setInterval(loadAlerts, 5 * 60 * 1000);
    
    async function loadAlerts() {
        const container = document.getElementById('alerts-container');
        
        try {
            const response = await fetch('/alerts/summary');
            if (!response.ok) throw new Error('Failed to fetch alerts');
            
            const data = await response.json();
            renderAlerts(data);
        } catch (error) {
            console.error('Error loading alerts:', error);
            container.innerHTML = `
                <div class="text-center py-4">
                    <p class="text-gray-500">
                        <i class="fas fa-exclamation-triangle text-yellow-500"></i> 
                        Unable to load alerts. <a href="#" onclick="loadAlerts(); return false;" class="text-blue-600 hover:underline">Retry</a>
                    </p>
                </div>
            `;
        }
    }
    
    async function refreshAlerts() {
        const container = document.getElementById('alerts-container');
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-spinner fa-spin text-gray-400 text-2xl"></i>
                <p class="text-gray-500 mt-2">Refreshing alerts...</p>
            </div>
        `;
        
        try {
            const response = await fetch('/alerts/refresh');
            if (!response.ok) throw new Error('Failed to refresh');
            
            const data = await response.json();
            // Convert to summary format
            const summary = {
                total_alerts: data.total,
                highest_severity: data.alerts.length > 0 ? data.alerts[0].severity : 'unknown',
                highest_severity_color: data.alerts.length > 0 ? data.alerts[0].severity_color : '#9CA3AF',
                highest_severity_icon: data.alerts.length > 0 ? data.alerts[0].severity_icon : '‚úì',
                alerts: data.alerts.slice(0, 5),
                status: data.total === 0 ? 'ok' : 'warning'
            };
            renderAlerts(summary);
        } catch (error) {
            console.error('Error refreshing alerts:', error);
            loadAlerts(); // Fallback to cached
        }
    }
    
    function renderAlerts(data) {
        const container = document.getElementById('alerts-container');
        
        if (data.total_alerts === 0) {
            container.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                    <div class="text-4xl mb-2">‚úÖ</div>
                    <h4 class="font-semibold text-green-800">All Clear</h4>
                    <p class="text-green-600 text-sm">No active weather or emergency alerts for Vienna</p>
                    <p class="text-green-500 text-xs mt-2">Sources: GeoSphere Austria, Meteoalarm</p>
                </div>
            `;
            return;
        }
        
        // Build alerts HTML
        let alertsHtml = `
            <div class="flex gap-4">
                <div class="flex-shrink-0 text-center px-4 py-3 rounded-lg" style="background: ${data.highest_severity_color};">
                    <div class="text-2xl">${data.highest_severity_icon}</div>
                    <div class="text-2xl font-bold text-white">${data.total_alerts}</div>
                    <div class="text-xs text-white opacity-80">Alert${data.total_alerts !== 1 ? 's' : ''}</div>
                </div>
                <div class="flex-1 space-y-2">
        `;
        
        for (const alert of data.alerts) {
            const typeIcon = getAlertTypeIcon(alert.alert_type);
            alertsHtml += `
                <div class="bg-gray-50 p-3 rounded border-l-4" style="border-left-color: ${alert.severity_color};">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">${typeIcon}</span>
                        <div class="flex-1">
                            <div class="font-medium text-gray-800 text-sm">${escapeHtml(alert.title)}</div>
                            <div class="text-xs text-gray-500">${alert.region} ‚Ä¢ ${alert.source === 'geosphere' ? 'GeoSphere' : 'Meteoalarm'}</div>
                        </div>
                        <span class="text-sm" title="${alert.severity}">${alert.severity_icon}</span>
                    </div>
                    ${alert.description ? `<p class="text-gray-600 text-xs mt-1 ml-7">${escapeHtml(truncate(alert.description, 120))}</p>` : ''}
                </div>
            `;
        }
        
        alertsHtml += `
                </div>
            </div>
            <div class="text-center text-gray-400 text-xs mt-3">
                Last updated: ${new Date().toLocaleTimeString('de-AT')} ‚Ä¢ Sources: GeoSphere Austria, Meteoalarm
            </div>
        `;
        
        container.innerHTML = alertsHtml;
    }
    
    function getAlertTypeIcon(type) {
        const icons = {
            'weather': 'üå§Ô∏è', 'storm': 'üå™Ô∏è', 'wind': 'üí®', 'rain': 'üåßÔ∏è',
            'snow': '‚ùÑÔ∏è', 'ice': 'üßä', 'fog': 'üå´Ô∏è', 'heat': 'üå°Ô∏è',
            'cold': 'ü•∂', 'thunderstorm': '‚õàÔ∏è', 'flood': 'üåä', 'fire': 'üî•'
        };
        return icons[type] || '‚ö†Ô∏è';
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function truncate(text, maxLength) {
        if (!text || text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }
</script>
{% endblock %}



