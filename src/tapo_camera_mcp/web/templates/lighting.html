{% extends "base.html" %}

{% block title %}Lighting Control - Tapo Camera MCP{% endblock %}

{% block extra_css %}
<style>
    .lighting-dashboard {
        padding: 20px;
    }
    
    .lighting-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .overview-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
    }
    
    .overview-card h3 {
        margin: 0 0 16px 0;
        color: #1f2937;
        font-size: 18px;
        font-weight: 600;
    }
    
    .overview-value {
        font-size: 32px;
        font-weight: 700;
        color: #3b82f6;
        margin-bottom: 8px;
    }
    
    .overview-label {
        color: #6b7280;
        font-size: 14px;
    }
    
    .lights-section, .groups-section {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        margin-bottom: 30px;
    }
    
    .light-card, .group-card, .scene-card {
        background: #f9fafb;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 16px;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
    }
    
    .light-card:hover, .group-card:hover, .scene-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    
    .scene-card {
        padding: 16px;
        margin-bottom: 0;
    }
    
    .light-header, .group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }
    
    .light-name, .group-name {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
    }
    
    .light-room, .group-type {
        color: #6b7280;
        font-size: 14px;
    }
    
    .light-status {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }
    
    .status-on {
        background-color: #10b981;
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
    }
    
    .status-off {
        background-color: #6b7280;
    }
    
    .status-unreachable {
        background-color: #ef4444;
    }
    
    .light-controls, .group-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 16px;
    }
    
    .brightness-control {
        flex: 1;
        min-width: 200px;
    }
    
    .brightness-slider {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: #e5e7eb;
        outline: none;
        -webkit-appearance: none;
    }
    
    .brightness-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #3b82f6;
        cursor: pointer;
    }
    
    .brightness-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #3b82f6;
        cursor: pointer;
        border: none;
    }
    
    .brightness-value {
        text-align: center;
        margin-top: 8px;
        font-weight: 600;
        color: #1f2937;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-primary {
        background-color: #3b82f6;
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #2563eb;
    }
    
    .btn-secondary {
        background-color: #6b7280;
        color: white;
    }
    
    .btn-secondary:hover {
        background-color: #4b5563;
    }
    
    .btn-success {
        background-color: #10b981;
        color: white;
    }
    
    .btn-success:hover {
        background-color: #059669;
    }
    
    .btn-danger {
        background-color: #ef4444;
        color: white;
    }
    
    .btn-danger:hover {
        background-color: #dc2626;
    }
    
    .setup-notice {
        background: #fef3c7;
        border: 1px solid #f59e0b;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .setup-notice h3 {
        margin: 0 0 12px 0;
        color: #92400e;
        font-size: 18px;
    }
    
    .setup-notice p {
        margin: 0 0 8px 0;
        color: #92400e;
    }
    
    .setup-notice code {
        background: #fbbf24;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: monospace;
    }
    
    .connection-status {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 12px;
    }
    
    .status-connected {
        background-color: #d1fae5;
        color: #065f46;
    }
    
    .status-disconnected {
        background-color: #fee2e2;
        color: #991b1b;
    }
</style>
{% endblock %}

{% block content %}
<div class="lighting-dashboard">
    <div class="page-header">
        <h1>üí° Lighting Control</h1>
        <p>Control your Philips Hue lights, groups, and scenes</p>
        <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px;">
            <span id="connection-status" class="connection-status status-disconnected">Disconnected</span>
            <button id="rescan-btn" class="btn btn-sm" onclick="rescanDevices()" title="Rescan all devices from bridge">üîÑ Rescan</button>
            <span id="last-scan" style="font-size: 12px; color: #6b7280;"></span>
        </div>
    </div>
    
    <!-- Setup Notice -->
    <div class="setup-notice" id="setup-notice" style="display: none;">
        <h3>üîß Setup Required</h3>
        <p>To connect to your Philips Hue Bridge:</p>
        <ol style="margin: 8px 0; padding-left: 24px; color: #92400e;">
            <li>Find your Hue Bridge IP address (check your router or Hue app)</li>
            <li>Press the button on your Hue Bridge</li>
            <li>Add the Bridge IP and username to <code>config.yaml</code> under <code>lighting.philips_hue</code></li>
        </ol>
    </div>
    
    <!-- Overview -->
    <div class="lighting-overview">
        <div class="overview-card">
            <h3>Total Lights</h3>
            <div class="overview-value" id="total-lights">0</div>
            <div class="overview-label">Connected</div>
        </div>
        
        <div class="overview-card">
            <h3>Lights On</h3>
            <div class="overview-value" id="lights-on">0</div>
            <div class="overview-label">Currently Active</div>
        </div>
        
        <div class="overview-card">
            <h3>Groups</h3>
            <div class="overview-value" id="total-groups">0</div>
            <div class="overview-label">Rooms/Zones</div>
        </div>
        
        <div class="overview-card">
            <h3>Reachable</h3>
            <div class="overview-value" id="reachable-lights">0</div>
            <div class="overview-label">Online</div>
        </div>
        
        <div class="overview-card">
            <h3>Scenes</h3>
            <div class="overview-value" id="total-scenes">0</div>
            <div class="overview-label">Available</div>
        </div>
    </div>
    
    <!-- Scenes Section -->
    <div class="lights-section">
        <h2>üé¨ Scenes</h2>
        <p>Predefined lighting scenes (showing unique scenes only)</p>
        
        <div id="scenes-container">
            <p>Loading scenes...</p>
        </div>
    </div>
    
    <!-- Groups Section -->
    <div class="groups-section">
        <h2>üè† Rooms & Groups</h2>
        <p>Control all lights in a room or zone at once</p>
        
        <div id="groups-container">
            <p>Loading groups...</p>
        </div>
    </div>
    
    <!-- Lights Section -->
    <div class="lights-section">
        <h2>üí° Individual Lights</h2>
        <p>Control individual Philips Hue lights</p>
        
        <div id="lights-container">
            <p>Loading lights...</p>
        </div>
    </div>
</div>

<script>
let lights = [];
let groups = [];
let scenes = [];

// Rescan all devices from bridge (force refresh)
async function rescanDevices() {
    const btn = document.getElementById('rescan-btn');
    const lastScanEl = document.getElementById('last-scan');
    
    btn.disabled = true;
    btn.textContent = '‚è≥ Scanning...';
    lastScanEl.textContent = 'Scanning...';
    
    try {
        const response = await fetch('/api/lighting/hue/rescan', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            lastScanEl.textContent = `Scanned: ${result.lights} lights, ${result.groups} groups`;
            // Reload UI with fresh data
            await loadData();
        } else {
            lastScanEl.textContent = 'Scan failed';
            alert('Rescan failed: ' + (result.detail || 'Unknown error'));
        }
    } catch (error) {
        console.error('Rescan error:', error);
        lastScanEl.textContent = 'Scan error';
        alert('Rescan error: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Rescan';
    }
}

// Load all data (from cache - fast)
async function loadData() {
    try {
        // Check connection status
        const statusResponse = await fetch('/api/lighting/hue/status');
        const status = await statusResponse.json();
        
        const statusEl = document.getElementById('connection-status');
        const setupNotice = document.getElementById('setup-notice');
        
        if (status.connected) {
            statusEl.textContent = 'Connected';
            statusEl.className = 'connection-status status-connected';
            setupNotice.style.display = 'none';
            
            // Show last scan time
            const lastScanEl = document.getElementById('last-scan');
            if (status.last_scan) {
                const scanDate = new Date(status.last_scan);
                lastScanEl.textContent = `Last scan: ${scanDate.toLocaleTimeString()}`;
            }
        } else {
            statusEl.textContent = 'Disconnected';
            statusEl.className = 'connection-status status-disconnected';
            if (status.error) {
                setupNotice.style.display = 'block';
            }
        }
        
        // Load lights
        const lightsResponse = await fetch('/api/lighting/hue/lights');
        const lightsData = await lightsResponse.json();
        lights = lightsData.lights || [];
        
        // Load groups
        const groupsResponse = await fetch('/api/lighting/hue/groups');
        const groupsData = await groupsResponse.json();
        groups = groupsData.groups || [];
        
        // Load scenes (with timeout)
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
            
            const scenesResponse = await fetch('/api/lighting/hue/scenes', {
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            
            if (!scenesResponse.ok) {
                console.error('Failed to load scenes:', scenesResponse.status, scenesResponse.statusText);
                const errorText = await scenesResponse.text();
                console.error('Error response:', errorText);
                scenes = [];
            } else {
                const scenesData = await scenesResponse.json();
                scenes = scenesData.scenes || [];
                console.log(`Loaded ${scenes.length} scenes`);
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                console.error('Scenes request timed out after 10 seconds');
            } else {
                console.error('Error loading scenes:', error);
            }
            scenes = [];
        }
        
        // Update overview
        updateOverview();
        
        // Render
        renderScenes();
        renderGroups();
        renderLights();
        
    } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('lights-container').innerHTML = '<p style="color: #ef4444;">Error loading lights. Check console for details.</p>';
        document.getElementById('groups-container').innerHTML = '<p style="color: #ef4444;">Error loading groups. Check console for details.</p>';
        document.getElementById('scenes-container').innerHTML = '<p style="color: #ef4444;">Error loading scenes. Check console for details.</p>';
    }
}

function updateOverview() {
    const totalLights = lights.length;
    const lightsOn = lights.filter(l => l.on).length;
    const totalGroups = groups.length;
    const reachable = lights.filter(l => l.reachable).length;
    const totalScenes = scenes.length;
    
    document.getElementById('total-lights').textContent = totalLights;
    document.getElementById('lights-on').textContent = lightsOn;
    document.getElementById('total-groups').textContent = totalGroups;
    document.getElementById('reachable-lights').textContent = reachable;
    document.getElementById('total-scenes').textContent = totalScenes;
}

function renderScenes() {
    const container = document.getElementById('scenes-container');
    
    if (scenes.length === 0) {
        container.innerHTML = '<p>No scenes found. Create scenes in the Philips Hue app.</p>';
        return;
    }
    
    // Render scenes in a compact grid layout
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
            ${scenes.map(scene => `
                <div class="scene-card" style="margin-bottom: 0; padding: 16px;">
                    <div style="margin-bottom: 12px;">
                        <div class="group-name" style="font-size: 16px; margin-bottom: 4px;">${scene.name}</div>
                        <div class="group-type" style="font-size: 12px; color: #9ca3af;">${scene.lights.length} light${scene.lights.length !== 1 ? 's' : ''}</div>
                    </div>
                    <button class="btn btn-primary" onclick="activateScene('${scene.scene_id}', '${scene.group || ''}')" style="width: 100%; padding: 8px 12px; font-size: 13px;">
                        Activate
                    </button>
                </div>
            `).join('')}
        </div>
    `;
}

function renderGroups() {
    const container = document.getElementById('groups-container');
    
    if (groups.length === 0) {
        container.innerHTML = '<p>No groups found. Create groups in the Philips Hue app.</p>';
        return;
    }
    
    container.innerHTML = groups.map(group => `
        <div class="group-card">
            <div class="group-header">
                <div>
                    <div class="group-name">${group.name}</div>
                    <div class="group-type">${group.type} ‚Ä¢ ${group.lights.length} lights</div>
                </div>
                <div class="light-status">
                    <span class="status-indicator ${group.on ? 'status-on' : 'status-off'}"></span>
                    <span>${group.on ? 'On' : 'Off'}</span>
                </div>
            </div>
            <div class="group-controls">
                <button class="btn ${group.on ? 'btn-danger' : 'btn-success'}" onclick="toggleGroup('${group.group_id}', ${!group.on})">
                    ${group.on ? 'Turn Off' : 'Turn On'}
                </button>
                <button class="btn btn-secondary" onclick="setGroupBrightness('${group.group_id}')">
                    Set Brightness
                </button>
            </div>
        </div>
    `).join('');
}

function renderLights() {
    const container = document.getElementById('lights-container');
    
    if (lights.length === 0) {
        container.innerHTML = '<p>No lights found. Make sure your Hue Bridge is connected and lights are powered on.</p>';
        return;
    }
    
    container.innerHTML = lights.map(light => `
        <div class="light-card" data-light-id="${light.light_id}">
            <div class="light-header">
                <div>
                    <div class="light-name">${light.name}</div>
                    <div class="light-room">${light.room || 'Unassigned'} ‚Ä¢ ${light.model || 'Unknown Model'}</div>
                </div>
                <div class="light-status">
                    <span class="status-indicator ${!light.reachable ? 'status-unreachable' : (light.on ? 'status-on' : 'status-off')}"></span>
                    <span>${!light.reachable ? 'Unreachable' : (light.on ? 'On' : 'Off')}</span>
                </div>
            </div>
            <div class="light-controls">
                <button class="btn ${light.on ? 'btn-danger' : 'btn-success'}" onclick="toggleLight('${light.light_id}', ${!light.on})" ${!light.reachable ? 'disabled' : ''}>
                    ${light.on ? 'Turn Off' : 'Turn On'}
                </button>
                <div class="brightness-control">
                    <input type="range" min="0" max="100" value="${light.brightness_percent || 0}" 
                           class="brightness-slider" 
                           onchange="setBrightness('${light.light_id}', this.value)"
                           ${!light.reachable || !light.on ? 'disabled' : ''}>
                    <div class="brightness-value">${light.brightness_percent || 0}%</div>
                </div>
            </div>
        </div>
    `).join('');
}

async function toggleLight(lightId, turnOn) {
    try {
        // Optimistically update UI
        const lightCard = document.querySelector(`[data-light-id="${lightId}"]`);
        if (lightCard) {
            const statusIndicator = lightCard.querySelector('.status-indicator');
            const statusText = lightCard.querySelector('.light-status span:last-child');
            const toggleBtn = lightCard.querySelector('button');
            if (statusIndicator) {
                statusIndicator.className = `status-indicator ${turnOn ? 'status-on' : 'status-off'}`;
            }
            if (statusText) {
                statusText.textContent = turnOn ? 'On' : 'Off';
            }
            if (toggleBtn) {
                toggleBtn.className = `btn ${turnOn ? 'btn-danger' : 'btn-success'}`;
                toggleBtn.textContent = turnOn ? 'Turn Off' : 'Turn On';
            }
        }

        const response = await fetch(`/api/lighting/hue/lights/${lightId}/control`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ on: turnOn }),
        });
        
        if (!response.ok) {
            let errorMessage = 'Failed to control light';
            try {
                const error = await response.json();
                errorMessage = error.detail || errorMessage;
            } catch (e) {
                errorMessage = `HTTP ${response.status}: ${response.statusText}`;
            }
            throw new Error(errorMessage);
        }

        let result;
        try {
            result = await response.json();
        } catch (e) {
            // If JSON parsing fails but response was OK, assume success
            console.warn('Could not parse response JSON, but request succeeded');
            // Wait a bit and refresh to get actual state
            await new Promise(resolve => setTimeout(resolve, 500));
            await loadData();
            return; // Exit successfully
        }
        
        // Update from API response if available
        if (result && result.light) {
            // Update the specific light in our array
            const lightIndex = lights.findIndex(l => l.light_id === lightId);
            if (lightIndex !== -1) {
                lights[lightIndex] = result.light;
                renderLights(); // Re-render to show updated state
            }
        } else {
            // Fallback: wait a bit for bridge to update, then reload
            await new Promise(resolve => setTimeout(resolve, 500));
            await loadData();
        }
    } catch (error) {
        console.error('Error toggling light:', error);
        // Only show alert if it's a real error, not just a network hiccup
        // Since the optimistic update already happened, the light likely worked
        // Just refresh to sync state
        await loadData();
        // Only alert on actual failures (not network timeouts if light worked)
        if (error.message && !error.message.includes('fetch')) {
            alert('Error: ' + error.message);
        }
    }
}

async function setBrightness(lightId, brightnessPercent) {
    try {
        const response = await fetch(`/api/lighting/hue/lights/${lightId}/control`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                on: true,  // Turn on if setting brightness
                brightness_percent: parseInt(brightnessPercent)
            }),
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to set brightness');
        }
        
        // Update UI immediately
        const light = lights.find(l => l.light_id === lightId);
        if (light) {
            light.brightness_percent = parseInt(brightnessPercent);
            light.on = true;
            renderLights();
        }
    } catch (error) {
        console.error('Error setting brightness:', error);
        alert('Error: ' + error.message);
    }
}

async function toggleGroup(groupId, turnOn) {
    try {
        const response = await fetch(`/api/lighting/hue/groups/${groupId}/control`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ on: turnOn }),
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to control group');
        }
        
        // Reload data
        await loadData();
    } catch (error) {
        console.error('Error toggling group:', error);
        alert('Error: ' + error.message);
    }
}

async function setGroupBrightness(groupId) {
    const brightness = prompt('Enter brightness (0-254):', '128');
    if (brightness === null) return;
    
    const brightnessValue = parseInt(brightness);
    if (isNaN(brightnessValue) || brightnessValue < 0 || brightnessValue > 254) {
        alert('Please enter a number between 0 and 254');
        return;
    }
    
    try {
        const response = await fetch(`/api/lighting/hue/groups/${groupId}/control`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                on: true,
                brightness: brightnessValue
            }),
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to set group brightness');
        }
        
        // Reload data
        await loadData();
    } catch (error) {
        console.error('Error setting group brightness:', error);
        alert('Error: ' + error.message);
    }
}

async function activateScene(sceneId, groupId) {
    try {
        const url = `/api/lighting/hue/scenes/${sceneId}/activate${groupId ? `?group_id=${groupId}` : ''}`;
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to activate scene');
        }
        
        const result = await response.json();
        if (result.success) {
            // Reload data to show updated light states
            await new Promise(resolve => setTimeout(resolve, 500));
            await loadData();
        }
    } catch (error) {
        console.error('Error activating scene:', error);
        alert('Error: ' + error.message);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    loadData();
    
    // Refresh every 30 seconds
    setInterval(loadData, 30000);
});
</script>
{% endblock %}

