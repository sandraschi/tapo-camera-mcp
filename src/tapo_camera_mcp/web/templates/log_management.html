{% extends "base.html" %}

{% block title %}Log Management - Tapo Camera MCP{% endblock %}

{% block extra_css %}
<style>
    .log-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
    }

    .stat-card {
        padding: 2rem;
        text-align: left;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, #3b82f6, transparent);
        opacity: 0.3;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 900;
        color: #fff;
        margin-bottom: 0.5rem;
        letter-spacing: -0.05em;
        font-family: 'Inter', sans-serif;
    }

    .stat-label {
        color: #6b7280;
        font-size: 0.75rem;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.2em;
    }

    .log-files {
        background: rgba(255, 255, 255, 0.02);
        border-radius: 24px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        overflow: hidden;
    }

    .log-file-item {
        padding: 1.25rem 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
    }

    .log-file-item:hover {
        background: rgba(255, 255, 255, 0.03);
    }

    .log-file-item:last-child {
        border-bottom: none;
    }

    .log-file-name {
        font-weight: 700;
        color: #fff;
        margin-bottom: 0.25rem;
        font-family: 'JetBrains Mono', monospace;
    }

    .log-file-meta {
        font-size: 0.75rem;
        color: #4b5563;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.7rem;
        font-weight: 900;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #9ca3af;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .btn-sm:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        border-color: rgba(255, 255, 255, 0.2);
    }

    .btn-primary-sm {
        background: rgba(59, 130, 246, 0.1);
        color: #60a5fa;
        border-color: rgba(59, 130, 246, 0.2);
    }

    .btn-primary-sm:hover {
        background: #3b82f6;
        color: #fff;
        border-color: #3b82f6;
    }

    .settings-section {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 24px;
        padding: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.05);
        margin-bottom: 2rem;
    }

    .settings-section h2 {
        font-size: 0.8rem;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: #4b5563;
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }

    .setting-input {
        background: rgba(0, 0, 0, 0.2);
        padding: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        font-size: 0.85rem;
        color: #fff;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .setting-input:focus {
        outline: none;
        border-color: #3b82f6;
        background: rgba(0, 0, 0, 0.3);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .loading {
        display: inline-block;
        width: 1.25rem;
        height: 1.25rem;
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        border-top-color: #3b82f6;
        animation: spin 0.8s cubic-bezier(0.5, 0, 0.5, 1) infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .terminal-header {
        display: flex;
        align-items: center;
        gap: 2rem;
        margin-bottom: 4rem;
    }

    .terminal-title-group {
        flex: 1;
    }

    .terminal-title-group h1 {
        font-size: 3rem;
        font-weight: 900;
        letter-spacing: -0.05em;
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, #fff 0%, #6b7280 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .terminal-subtitle {
        color: #4b5563;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.3em;
        font-size: 0.7rem;
    }

    /* Existing alert styles, kept as they were not explicitly removed */
    .alert {
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        display: none;
    }

    .alert-success {
        background-color: #d1fae5;
        border: 1px solid #10b981;
        color: #065f46;
    }

    .alert-error {
        background-color: #fee2e2;
        border: 1px solid #ef4444;
        color: #991b1b;
    }
</style>
{% endblock %}

{% block content %}
<div class="log-management max-w-7xl mx-auto px-4 py-12">
    <div class="terminal-header">
        <div
            class="w-16 h-16 rounded-2xl bg-blue-500/10 border border-blue-500/30 flex items-center justify-center text-2xl text-blue-500">
            <i class="fas fa-terminal"></i>
        </div>
        <div class="terminal-title-group">
            <h1>Log Stream</h1>
            <div class="terminal-subtitle">Application Oracle / Persistence Layer</div>
        </div>
    </div>

    <!-- Alerts (kept as they were not explicitly removed by the instruction) -->
    <div id="alert-success" class="alert alert-success">
        <span id="alert-success-text"></span>
    </div>
    <div id="alert-error" class="alert alert-error">
        <span id="alert-error-text"></span>
    </div>

    <!-- Log Statistics -->
    <div class="log-stats" id="log-stats">
        <div class="glass stat-card rounded-3xl border-white/10">
            <div class="stat-value" id="total-files">-</div>
            <div class="stat-label">File Count</div>
        </div>
        <div class="glass stat-card rounded-3xl border-white/10">
            <div class="stat-value" id="total-size">-</div>
            <div class="stat-label">Volume (MB)</div>
        </div>
        <div class="glass stat-card rounded-3xl border-white/10">
            <div class="stat-value" id="active-logs">-</div>
            <div class="stat-label">Active Nodes</div>
        </div>
        <div class="glass stat-card rounded-3xl border-white/10">
            <div class="stat-value" id="compressed-logs">-</div>
            <div class="stat-label">Archival Cluster</div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="settings-section">
        <h2><i class="fas fa-bolt text-blue-500"></i> Command Directives</h2>
        <div class="flex gap-4 flex-wrap">
            <button
                class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-4 rounded-2xl font-black uppercase tracking-widest text-[10px] transition-all duration-300 shadow-lg shadow-blue-500/20"
                onclick="sanitizeLogs()" id="sanitize-btn">
                <i class="fas fa-broom mr-2"></i> Sanitize Protocol
            </button>
            <button
                class="bg-white/5 hover:bg-white/10 border border-white/10 text-gray-400 hover:text-white px-8 py-4 rounded-2xl font-black uppercase tracking-widest text-[10px] transition-all duration-300"
                onclick="refreshStats()" id="refresh-btn">
                <i class="fas fa-sync-alt mr-2"></i> Refresh Matrix
            </button>
        </div>
    </div>

    <!-- Manual Log Rotation -->
    <div class="settings-section">
        <h2><i class="fas fa-history text-orange-500"></i> Manual Rotation</h2>
        <div class="flex gap-4 items-center">
            <select id="log-file-select" class="setting-input flex-1">
                <option value="">NODE SELECTION...</option>
            </select>
            <button
                class="bg-orange-500 hover:bg-orange-400 text-black px-8 py-4 rounded-2xl font-black uppercase tracking-widest text-[10px] transition-all duration-300"
                onclick="rotateSelectedLog()" id="rotate-btn">
                Execute Rotation
            </button>
        </div>
    </div>

    <!-- Log Files List -->
    <div class="terminal-list-header flex items-center justify-between mb-6 px-4">
        <div class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Persistence Registry</div>
        <div class="flex items-center gap-4">
            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
            <span class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Streaming</span>
        </div>
    </div>
    <div class="log-files" id="log-files-list">
        <div class="py-20 text-center color-[#4b5563]">
            <div class="loading mb-4"></div>
            <div class="text-[10px] font-black uppercase tracking-widest">Interrogating File System...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let logStats = {};
    let logFiles = [];

    document.addEventListener('DOMContentLoaded', function () {
        loadLogStats();
    });

    // Load log statistics
    async function loadLogStats() {
        try {
            const response = await fetch('/api/logs/stats');
            const data = await response.json();

            if (data.enabled === false) {
                showAlert('Log management is disabled in configuration', 'error');
                return;
            }

            logStats = data;
            updateStatsDisplay(data);
            await loadLogFiles();

        } catch (error) {
            console.error('Failed to load log stats:', error);
            showAlert('Failed to load log statistics', 'error');
        }
    }

    // Update statistics display
    function updateStatsDisplay(data) {
        document.getElementById('total-files').textContent = data.total_files || 0;
        document.getElementById('total-size').textContent = (data.total_size_mb || 0).toFixed(2);
        document.getElementById('active-logs').textContent = data.files_by_type?.active_logs || 0;
        document.getElementById('compressed-logs').textContent = data.files_by_type?.compressed_logs || 0;
    }

    // Load log files list
    async function loadLogFiles() {
        const container = document.getElementById('log-files-list');
        const select = document.getElementById('log-file-select');

        // Clear existing options
        select.innerHTML = '<option value="">Select a log file...</option>';

        try {
            // For now, we'll list common log files that might exist
            // In a full implementation, this would come from the API
            const commonLogFiles = [
                'tapo_mcp.log',
                'server.log',
                'error.log',
                'access.log'
            ];

            // Populate select dropdown
            commonLogFiles.forEach(filename => {
                const option = document.createElement('option');
                option.value = filename;
                option.textContent = filename;
                select.appendChild(option);
            });

            // Show file list (placeholder for now)
            container.innerHTML = `
            <div class="py-20 text-center">
                <div class="w-20 h-20 rounded-3xl bg-white/5 border border-white/10 flex items-center justify-center text-3xl text-gray-700 mx-auto mb-6">
                    <i class="fas fa-file-code"></i>
                </div>
                <div class="text-[10px] font-black text-white uppercase tracking-widest mb-2">Protocol History Ready</div>
                <div class="text-[9px] font-bold text-gray-600 uppercase tracking-widest">Metadata extraction available in next cycle</div>
            </div>
        `;

        } catch (error) {
            console.error('Failed to load log files:', error);
            container.innerHTML = `
            <div class="py-20 text-center">
                <div class="w-20 h-20 rounded-3xl bg-red-500/10 border border-red-500/20 flex items-center justify-center text-3xl text-red-500 mx-auto mb-6">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="text-[10px] font-black text-red-400 uppercase tracking-widest mb-2">Access Denied</div>
                <div class="text-[9px] font-bold text-red-900 uppercase tracking-widest">Persistence registry unreachable</div>
            </div>
        `;
        }
    }

    // Sanitize all logs
    async function sanitizeLogs() {
        const btn = document.getElementById('sanitize-btn');
        const originalText = btn.textContent;

        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Sanitizing...';

        try {
            const response = await fetch('/api/logs/sanitize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (response.ok) {
                showAlert('Log sanitization started successfully', 'success');
                // Refresh stats after a delay
                setTimeout(() => {
                    loadLogStats();
                }, 2000);
            } else {
                const error = await response.json();
                throw new Error(error.detail || 'Sanitization failed');
            }

        } catch (error) {
            console.error('Sanitization failed:', error);
            showAlert('Log sanitization failed: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }

    // Rotate selected log file
    async function rotateSelectedLog() {
        const select = document.getElementById('log-file-select');
        const filename = select.value;

        if (!filename) {
            showAlert('Please select a log file to rotate', 'error');
            return;
        }

        const btn = document.getElementById('rotate-btn');
        const originalText = btn.textContent;

        btn.disabled = true;
        btn.textContent = 'Rotating...';

        try {
            const response = await fetch(`/api/logs/rotate/${filename}`, {
                method: 'POST'
            });

            if (response.ok) {
                showAlert(`Log rotation started for ${filename}`, 'success');
                // Refresh stats after a delay
                setTimeout(() => {
                    loadLogStats();
                }, 1000);
            } else {
                const error = await response.json();
                throw new Error(error.detail || 'Rotation failed');
            }

        } catch (error) {
            console.error('Rotation failed:', error);
            showAlert('Log rotation failed: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }

    // Refresh statistics
    async function refreshStats() {
        const btn = document.getElementById('refresh-btn');
        const originalText = btn.textContent;

        btn.disabled = true;
        btn.textContent = 'Refreshing...';

        try {
            await loadLogStats();
            showAlert('Statistics refreshed', 'success');
        } catch (error) {
            showAlert('Failed to refresh statistics', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }

    // Show alert/toast messages
    function showAlert(message, type) {
        if (typeof showToast === 'function') {
            showToast(message);
        } else {
            const alertDiv = document.getElementById(`alert-${type}`);
            const alertText = document.getElementById(`alert-${type}-text`);

            if (alertDiv && alertText) {
                alertText.textContent = message;
                alertDiv.classList.remove('hidden');

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    alertDiv.classList.add('hidden');
                }, 5000);
            }
        }
    }

    function showToast(message) {
        // Remove existing
        const existing = document.querySelector('.toast-notification');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'toast-notification glass border-white/10';
        toast.style.cssText = `
        position: fixed;
        bottom: 40px;
        right: 40px;
        background: rgba(59, 130, 246, 0.2);
        color: #60a5fa;
        padding: 1rem 1.5rem;
        border-radius: 1rem;
        box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
        z-index: 2000;
        font-size: 0.75rem;
        font-weight: 900;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        backdrop-filter: blur(20px);
    `;
        toast.innerHTML = `<i class="fas fa-terminal mr-2 text-xs"></i> ${message}`;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateY(0)';
        }, 10);

        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(10px)';
            setTimeout(() => toast.remove(), 400);
        }, 4000);
    }
</script>
{% endblock %}