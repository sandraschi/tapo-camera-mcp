{% extends "base.html" %}

{% block title %}Log Management - Tapo Camera MCP{% endblock %}

{% block extra_css %}
<style>
    .log-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        text-align: center;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #3b82f6;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: #6b7280;
        font-size: 0.9rem;
    }

    .log-files {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }

    .log-file-item {
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .log-file-item:last-child {
        border-bottom: none;
    }

    .log-file-info {
        flex: 1;
    }

    .log-file-name {
        font-weight: 500;
        color: #1f2937;
        margin-bottom: 0.25rem;
    }

    .log-file-meta {
        font-size: 0.8rem;
        color: #6b7280;
    }

    .log-actions {
        display: flex;
        gap: 0.5rem;
    }

    .btn-sm {
        padding: 0.25rem 0.75rem;
        font-size: 0.8rem;
        border-radius: 4px;
        border: 1px solid #d1d5db;
        background: white;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-sm:hover {
        background: #f9fafb;
    }

    .btn-primary-sm {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .btn-primary-sm:hover {
        background: #2563eb;
    }

    .settings-section {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        margin-bottom: 2rem;
    }

    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .setting-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .setting-label {
        font-weight: 500;
        color: #1f2937;
    }

    .setting-input {
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .setting-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .alert {
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        display: none;
    }

    .alert-success {
        background-color: #d1fae5;
        border: 1px solid #10b981;
        color: #065f46;
    }

    .alert-error {
        background-color: #fee2e2;
        border: 1px solid #ef4444;
        color: #991b1b;
    }

    .loading {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 50%;
        border-top-color: #3b82f6;
        animation: spin 1s ease-in-out infinite;
        margin-right: 0.5rem;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="log-management">
    <div class="page-header">
        <h1>ðŸ“‹ Log Management</h1>
        <p>Monitor and manage application log files</p>
    </div>

    <!-- Alerts -->
    <div id="alert-success" class="alert alert-success">
        <span id="alert-success-text"></span>
    </div>
    <div id="alert-error" class="alert alert-error">
        <span id="alert-error-text"></span>
    </div>

    <!-- Log Statistics -->
    <div class="log-stats" id="log-stats">
        <div class="stat-card">
            <div class="stat-value" id="total-files">-</div>
            <div class="stat-label">Total Log Files</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="total-size">-</div>
            <div class="stat-label">Total Size (MB)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="active-logs">-</div>
            <div class="stat-label">Active Logs</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="compressed-logs">-</div>
            <div class="stat-label">Compressed</div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="settings-section">
        <h2>âš¡ Quick Actions</h2>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
            <button class="btn btn-primary" onclick="sanitizeLogs()" id="sanitize-btn">
                ðŸ§¹ Sanitize All Logs
            </button>
            <button class="btn" onclick="refreshStats()" id="refresh-btn">
                ðŸ”„ Refresh Stats
            </button>
        </div>
    </div>

    <!-- Manual Log Rotation -->
    <div class="settings-section">
        <h2>ðŸ”„ Manual Log Rotation</h2>
        <p>Rotate specific log files immediately</p>
        <div style="display: flex; gap: 1rem; align-items: center; margin-top: 1rem;">
            <select id="log-file-select" class="setting-input" style="flex: 1;">
                <option value="">Select a log file...</option>
            </select>
            <button class="btn btn-primary-sm" onclick="rotateSelectedLog()" id="rotate-btn">
                Rotate File
            </button>
        </div>
    </div>

    <!-- Log Files List -->
    <div class="log-files" id="log-files-list">
        <div style="padding: 2rem; text-align: center; color: #6b7280;">
            <div class="loading"></div>
            Loading log files...
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let logStats = {};
let logFiles = [];

document.addEventListener('DOMContentLoaded', function() {
    loadLogStats();
});

// Load log statistics
async function loadLogStats() {
    try {
        const response = await fetch('/api/logs/stats');
        const data = await response.json();

        if (data.enabled === false) {
            showAlert('Log management is disabled in configuration', 'error');
            return;
        }

        logStats = data;
        updateStatsDisplay(data);
        await loadLogFiles();

    } catch (error) {
        console.error('Failed to load log stats:', error);
        showAlert('Failed to load log statistics', 'error');
    }
}

// Update statistics display
function updateStatsDisplay(data) {
    document.getElementById('total-files').textContent = data.total_files || 0;
    document.getElementById('total-size').textContent = (data.total_size_mb || 0).toFixed(2);
    document.getElementById('active-logs').textContent = data.files_by_type?.active_logs || 0;
    document.getElementById('compressed-logs').textContent = data.files_by_type?.compressed_logs || 0;
}

// Load log files list
async function loadLogFiles() {
    const container = document.getElementById('log-files-list');
    const select = document.getElementById('log-file-select');

    // Clear existing options
    select.innerHTML = '<option value="">Select a log file...</option>';

    try {
        // For now, we'll list common log files that might exist
        // In a full implementation, this would come from the API
        const commonLogFiles = [
            'tapo_mcp.log',
            'server.log',
            'error.log',
            'access.log'
        ];

        // Populate select dropdown
        commonLogFiles.forEach(filename => {
            const option = document.createElement('option');
            option.value = filename;
            option.textContent = filename;
            select.appendChild(option);
        });

        // Show file list (placeholder for now)
        container.innerHTML = `
            <div style="padding: 2rem; text-align: center; color: #6b7280;">
                <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <p>Log file details will be displayed here</p>
                <p style="font-size: 0.9rem;">Use the Quick Actions to manage logs</p>
            </div>
        `;

    } catch (error) {
        console.error('Failed to load log files:', error);
        container.innerHTML = `
            <div style="padding: 2rem; text-align: center; color: #ef4444;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <p>Failed to load log files</p>
            </div>
        `;
    }
}

// Sanitize all logs
async function sanitizeLogs() {
    const btn = document.getElementById('sanitize-btn');
    const originalText = btn.textContent;

    btn.disabled = true;
    btn.innerHTML = '<span class="loading"></span> Sanitizing...';

    try {
        const response = await fetch('/api/logs/sanitize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
            showAlert('Log sanitization started successfully', 'success');
            // Refresh stats after a delay
            setTimeout(() => {
                loadLogStats();
            }, 2000);
        } else {
            const error = await response.json();
            throw new Error(error.detail || 'Sanitization failed');
        }

    } catch (error) {
        console.error('Sanitization failed:', error);
        showAlert('Log sanitization failed: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

// Rotate selected log file
async function rotateSelectedLog() {
    const select = document.getElementById('log-file-select');
    const filename = select.value;

    if (!filename) {
        showAlert('Please select a log file to rotate', 'error');
        return;
    }

    const btn = document.getElementById('rotate-btn');
    const originalText = btn.textContent;

    btn.disabled = true;
    btn.textContent = 'Rotating...';

    try {
        const response = await fetch(`/api/logs/rotate/${filename}`, {
            method: 'POST'
        });

        if (response.ok) {
            showAlert(`Log rotation started for ${filename}`, 'success');
            // Refresh stats after a delay
            setTimeout(() => {
                loadLogStats();
            }, 1000);
        } else {
            const error = await response.json();
            throw new Error(error.detail || 'Rotation failed');
        }

    } catch (error) {
        console.error('Rotation failed:', error);
        showAlert('Log rotation failed: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

// Refresh statistics
async function refreshStats() {
    const btn = document.getElementById('refresh-btn');
    const originalText = btn.textContent;

    btn.disabled = true;
    btn.textContent = 'Refreshing...';

    try {
        await loadLogStats();
        showAlert('Statistics refreshed', 'success');
    } catch (error) {
        showAlert('Failed to refresh statistics', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

// Show alert messages
function showAlert(message, type) {
    const alertDiv = document.getElementById(`alert-${type}`);
    const alertText = document.getElementById(`alert-${type}-text`);

    if (alertDiv && alertText) {
        alertText.textContent = message;
        alertDiv.style.display = 'block';

        // Auto-hide after 5 seconds
        setTimeout(() => {
            alertDiv.style.display = 'none';
        }, 5000);
    }
}
</script>
{% endblock %}