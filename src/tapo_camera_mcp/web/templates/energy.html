{% extends "base.html" %}

{% block title %}Energy Management - Tapo Camera MCP{% endblock %}

{% block extra_css %}
<style>
    .energy-dashboard {
        padding: 20px;
    }

    .energy-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .energy-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border-primary);
    }

    .energy-card h3 {
        margin: 0 0 16px 0;
        color: var(--text-primary);
        font-size: 18px;
        font-weight: 600;
    }

    .energy-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--success-color);
        margin-bottom: 8px;
    }

    .energy-unit {
        color: var(--text-secondary);
        font-size: 14px;
    }

    .energy-trend {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 12px;
    }

    .trend-up {
        color: var(--error-color);
    }

    .trend-down {
        color: var(--success-color);
    }

    .devices-section {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border-primary);
    }

    .device-card {
        background: var(--bg-primary);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 16px;
        border: 1px solid var(--border-primary);
        transition: all 0.2s ease;
    }

    .device-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .device-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 16px;
    }

    .device-name {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .device-location {
        color: var(--text-secondary);
        font-size: 14px;
    }

    .device-status {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .status-online {
        background-color: var(--success-color);
    }

    .status-offline {
        background-color: var(--error-color);
    }

    .device-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }

    .metric {
        text-align: center;
    }

    .metric-value {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .metric-label {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 4px;
    }

    .device-controls {
        display: flex;
        gap: 12px;
        margin-top: 16px;
    }

    .btn {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-primary {
        background-color: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        filter: brightness(1.1);
    }

    .btn-secondary {
        background-color: var(--hover-bg);
        color: var(--text-primary);
    }

    .btn-secondary:hover {
        filter: brightness(0.9);
    }

    .btn-danger {
        background-color: var(--error-color);
        color: white;
    }

    .btn-danger:hover {
        filter: brightness(0.9);
    }

    .chart-container {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border-primary);
        margin-top: 20px;
    }

    .chart-placeholder {
        height: 300px;
        background: var(--bg-primary);
        border: 2px dashed var(--border-primary);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        font-size: 16px;
    }

    .alert-item {
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .alert-warning {
        border-left-color: var(--warning-color) !important;
        background: var(--hover-bg) !important;
        color: var(--text-primary);
    }

    .alert-critical {
        border-left-color: var(--error-color) !important;
        background: var(--hover-bg) !important;
        color: var(--text-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="energy-dashboard">
    <div class="page-header">
        <h1>‚ö° Energy Management</h1>
        <p>Monitor and control your Tapo P115 smart plugs with real-time energy consumption tracking</p>
    </div>

    <!-- Energy Overview -->
    <div class="energy-overview">
        <div class="energy-card">
            <h3>üìä Total Power Consumption</h3>
            <div class="energy-value">245.8</div>
            <div class="energy-unit">Watts</div>
            <div class="energy-trend trend-up">
                <i class="fas fa-arrow-up"></i>
                <span>+12% from yesterday</span>
            </div>
        </div>

        <div class="energy-card">
            <h3>üí∞ Daily Cost</h3>
            <div class="energy-value">$0.76</div>
            <div class="energy-unit">Today</div>
            <div class="energy-trend trend-down">
                <i class="fas fa-arrow-down"></i>
                <span>-5% from yesterday</span>
            </div>
        </div>

        <div class="energy-card">
            <h3>üìà Monthly Usage</h3>
            <div class="energy-value">189.0</div>
            <div class="energy-unit">kWh</div>
            <div class="energy-trend trend-up">
                <i class="fas fa-arrow-up"></i>
                <span>+8% from last month</span>
            </div>
        </div>

        <div class="energy-card">
            <h3>üí° Monthly Cost</h3>
            <div class="energy-value">$22.68</div>
            <div class="energy-unit">This Month</div>
            <div class="energy-trend trend-up">
                <i class="fas fa-arrow-up"></i>
                <span>+8% from last month</span>
            </div>
        </div>
    </div>

    <!-- Smart Plugs Section -->
    <div class="devices-section">
        <h2>üîå Smart Plugs</h2>
        <p>Monitor and control your Tapo P115 smart plugs</p>

        <!-- Real Device Cards (populated via JavaScript) -->
        <div id="devices-container">
            <p>Loading devices...</p>
        </div>
    </div>

    <!-- Energy Chart -->
    <div class="chart-container">
        <h3>üìä Energy Consumption Over Time</h3>
        <div style="margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <label for="device-selector" style="font-weight: 500; color: var(--text-primary);">Device:</label>
                <select id="device-selector" onchange="changeDevice(this.value)"
                    style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-primary); background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; min-width: 180px;">
                    <option value="all">üìä All Devices (Combined)</option>
                </select>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary" onclick="changeTimeRange('24h')" id="btn-24h">24 Hours</button>
                <button class="btn btn-secondary" onclick="changeTimeRange('7d')" id="btn-7d">7 Days</button>
                <button class="btn btn-secondary" onclick="changeTimeRange('30d')" id="btn-30d">30 Days</button>
            </div>
            <div style="display: flex; gap: 8px; margin-left: auto;">
                <button class="btn btn-secondary" onclick="zoomIn()" title="Zoom In">üîç+</button>
                <button class="btn btn-secondary" onclick="zoomOut()" title="Zoom Out">üîç‚àí</button>
                <button class="btn btn-secondary" onclick="resetZoom()" title="Reset Zoom">‚Ü∫ Reset</button>
            </div>
        </div>
        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
            üí° Drag to pan, scroll to zoom, or use buttons above
        </div>
        <div style="position: relative; height: 400px;">
            <canvas id="powerChart"></canvas>
        </div>
        <div
            style="margin-top: 16px; padding: 12px; background: var(--hover-bg); border-radius: 8px; border-left: 4px solid var(--warning-color); color: var(--text-primary);">
            <strong>‚ö†Ô∏è Alert Thresholds:</strong>
            <span style="margin-left: 16px;">Power Spike: <span style="color: var(--warning-color);">>500W</span></span>
            <span style="margin-left: 16px;">Power Surge: <span style="color: var(--error-color);">>800W</span></span>
        </div>
    </div>

    <!-- Alerts Section -->
    <div class="chart-container" id="alerts-section" style="display: none;">
        <h3>üö® Active Power Alerts</h3>
        <div id="alerts-container">
            <!-- Alerts will be populated here -->
        </div>
    </div>
</div>

<!-- Chart.js Library + Zoom Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script>
    // Global variables
    let powerChart = null;
    let currentTimeRange = '24h';
    let selectedDevice = 'all';
    let availableDevices = [];
    let chartData = {
        labels: [],
        power: [],
        alerts: []
    };

    // Change selected device
    function changeDevice(deviceId) {
        selectedDevice = deviceId;
        loadChartData();
    }

    // Zoom controls
    function zoomIn() {
        if (powerChart) {
            powerChart.zoom(1.2);
        }
    }

    function zoomOut() {
        if (powerChart) {
            powerChart.zoom(0.8);
        }
    }

    function resetZoom() {
        if (powerChart) {
            powerChart.resetZoom();
        }
    }

    // Populate device selector
    function populateDeviceSelector(devices) {
        const selector = document.getElementById('device-selector');
        if (!selector) return;

        // Keep "All Devices" option
        selector.innerHTML = '<option value="all">üìä All Devices (Combined)</option>';

        devices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.device_id;
            option.textContent = `${device.power_state ? 'üü¢' : '‚ö™'} ${device.name || device.device_id}`;
            selector.appendChild(option);
        });

        // Restore selection if still valid
        if (selectedDevice !== 'all' && devices.some(d => d.device_id === selectedDevice)) {
            selector.value = selectedDevice;
        }
    }

    // Initialize chart
    function initChart() {
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded. Cannot initialize chart.');
            updateChartPlaceholder('Chart.js library is loading...');
            return;
        }

        const ctx = document.getElementById('powerChart');
        if (!ctx) return;

        powerChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: 'Power Consumption (W)',
                        data: chartData.power,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 2,
                        pointHoverRadius: 5
                    },
                    {
                        label: 'Alert Threshold (500W)',
                        data: chartData.power.map(() => 500),
                        borderColor: '#f59e0b',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0
                    },
                    {
                        label: 'Surge Threshold (800W)',
                        data: chartData.power.map(() => 800),
                        borderColor: '#dc2626',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(1) + 'W';
                                }
                                return label;
                            }
                        }
                    },
                    zoom: {
                        pan: {
                            enabled: true,
                            mode: 'x',
                            modifierKey: null
                        },
                        zoom: {
                            wheel: {
                                enabled: true,
                                modifierKey: null
                            },
                            pinch: {
                                enabled: true
                            },
                            drag: {
                                enabled: false
                            },
                            mode: 'x'
                        },
                        limits: {
                            x: { min: 'original', max: 'original' }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Power (Watts)'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Load chart data
    async function loadChartData() {
        try {
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                updateChartPlaceholder('Chart.js library is loading...');
                // Retry after a delay
                setTimeout(loadChartData, 1000);
                return;
            }

            const devices = await fetch('/api/sensors/tapo-p115').then(r => r.json()).then(d => d.devices || []);
            if (devices.length === 0) {
                updateChartPlaceholder('No devices configured');
                return;
            }

            // Update device selector and store available devices
            availableDevices = devices;
            populateDeviceSelector(devices);

            // Filter devices based on selection
            const devicesToQuery = selectedDevice === 'all'
                ? devices
                : devices.filter(d => d.device_id === selectedDevice);

            if (devicesToQuery.length === 0) {
                updateChartPlaceholder('Selected device not found');
                return;
            }

            // Get history for selected device(s)
            const hours = currentTimeRange === '24h' ? 24 : currentTimeRange === '7d' ? 168 : 720;

            // Aggregate data from selected devices
            const allHistoryData = [];
            for (const device of devicesToQuery) {
                try {
                    const history = await fetch(`/api/sensors/tapo-p115/${device.device_id}/history?hours=${hours}`)
                        .then(r => r.json())
                        .then(d => d.data_points || []);
                    allHistoryData.push(...history);
                } catch (e) {
                    console.error(`Error loading history for ${device.device_id}:`, e);
                }
            }

            if (allHistoryData.length === 0) {
                updateChartPlaceholder('No history data available');
                return;
            }

            // Group by timestamp and aggregate power
            const aggregated = {};
            allHistoryData.forEach(point => {
                // Normalize timestamp (database returns Unix timestamp in seconds)
                const ts = typeof point.timestamp === 'number' ? point.timestamp : new Date(point.timestamp).getTime() / 1000;
                if (!aggregated[ts]) {
                    aggregated[ts] = {
                        timestamp: ts,
                        power: 0,
                        count: 0
                    };
                }
                aggregated[ts].power += point.power_w || point.power_consumption || 0;
                aggregated[ts].count += 1;
            });

            // Sort by timestamp (already normalized to Unix seconds)
            // For "All Devices" - SUM the power values (total consumption)
            // For single device - use raw values (no averaging needed)
            const sortedData = Object.values(aggregated)
                .map(d => ({ ...d, power: selectedDevice === 'all' ? d.power : d.power / d.count }))
                .sort((a, b) => a.timestamp - b.timestamp);

            // Prepare chart data
            chartData.labels = sortedData.map(d => {
                // Handle both Unix timestamp (seconds) and ISO string
                const timestamp = typeof d.timestamp === 'number' ? d.timestamp * 1000 : d.timestamp;
                const date = new Date(timestamp);
                if (currentTimeRange === '24h') {
                    return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                }
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit' });
            });
            chartData.power = sortedData.map(d => d.power);

            // Detect alerts (power spikes)
            chartData.alerts = [];
            sortedData.forEach((d, idx) => {
                if (d.power > 500) {
                    chartData.alerts.push({
                        timestamp: d.timestamp,
                        power: d.power,
                        severity: d.power > 800 ? 'critical' : 'warning'
                    });
                }
            });

            // Update chart
            if (typeof Chart === 'undefined') {
                updateChartPlaceholder('Chart.js library is loading...');
                return;
            }

            // Get label for selected device
            const deviceLabel = selectedDevice === 'all'
                ? 'Power (All Devices)'
                : `Power (${devicesToQuery[0]?.name || selectedDevice})`;

            if (powerChart) {
                powerChart.data.labels = chartData.labels;
                powerChart.data.datasets[0].label = deviceLabel;
                powerChart.data.datasets[0].data = chartData.power;
                powerChart.data.datasets[1].data = chartData.power.map(() => 500);
                powerChart.data.datasets[2].data = chartData.power.map(() => 800);
                powerChart.update('none');
            } else {
                initChart();
            }

            // Update alerts display
            updateAlerts();

        } catch (error) {
            console.error('Error loading chart data:', error);
            updateChartPlaceholder('Error loading data: ' + error.message);
        }
    }

    // Update chart placeholder message
    function updateChartPlaceholder(message) {
        const canvas = document.getElementById('powerChart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.font = '16px Arial';
        ctx.fillStyle = '#6b7280';
        ctx.textAlign = 'center';
        ctx.fillText(message, canvas.width / 2, canvas.height / 2);
    }

    // Update alerts display
    function updateAlerts() {
        const alertsSection = document.getElementById('alerts-section');
        const alertsContainer = document.getElementById('alerts-container');

        if (chartData.alerts.length === 0) {
            alertsSection.style.display = 'none';
            return;
        }

        alertsSection.style.display = 'block';
        alertsContainer.innerHTML = chartData.alerts.map(alert => {
            const date = new Date(alert.timestamp);
            const severityClass = alert.severity === 'critical' ? 'alert-critical' : 'alert-warning';
            return `
            <div class="alert-item ${severityClass}" style="padding: 12px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid ${alert.severity === 'critical' ? 'var(--error-color)' : 'var(--warning-color)'}; background: var(--hover-bg); color: var(--text-primary);">
                <strong>${alert.severity === 'critical' ? 'üî¥ Power Surge' : '‚ö†Ô∏è Power Spike'}</strong>
                <div style="margin-top: 4px;">
                    <span>Power: <strong>${alert.power.toFixed(1)}W</strong></span>
                    <span style="margin-left: 16px;">Time: ${date.toLocaleString()}</span>
                </div>
            </div>
        `;
        }).join('');
    }

    // Change time range
    function changeTimeRange(range) {
        currentTimeRange = range;

        // Update button states
        document.querySelectorAll('[id^="btn-"]').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-secondary');
        });
        document.getElementById(`btn-${range}`).classList.remove('btn-secondary');
        document.getElementById(`btn-${range}`).classList.add('btn-primary');

        loadChartData();
    }

    // Real data fetching from API and chart initialization
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Energy dashboard loaded');
        loadDevices();

        // Refresh every 30 seconds
        setInterval(loadDevices, 30000);

        // Initialize chart after Chart.js loads
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                initChart();
                loadChartData();

                // Refresh chart every 30 seconds
                setInterval(loadChartData, 30000);
            } else {
                console.error('Chart.js failed to load. Check Content Security Policy settings.');
                const chartContainer = document.getElementById('powerChart');
                if (chartContainer && chartContainer.parentElement) {
                    chartContainer.parentElement.innerHTML = '<p style="color: red; padding: 20px;">Error: Chart.js library failed to load. Please check your browser console and Content Security Policy settings.</p>';
                }
            }
        }, 1000);
    });

    async function loadDevices() {
        try {
            console.log('Loading Tapo P115 devices...');
            const response = await fetch('/api/energy/devices');

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('API response:', data);

            let devices = data.devices || [];
            const container = document.getElementById('devices-container');

            if (!container) {
                console.error('devices-container element not found!');
                return;
            }

            console.log(`Found ${devices.length} devices`);

            if (devices.length === 0) {
                container.innerHTML = '<p>No devices found. Configure P115 plugs in config.yaml</p>';
                console.warn('No devices found in API response');
                return;
            }

            // Sort devices: primary real plug(s) first (non-readonly), then the rest.
            // If you have a known primary device_id (e.g. tapo_p115_aircon), it will float to the top.
            const PRIMARY_DEVICE_IDS = ['tapo_p115_aircon'];
            devices = devices.slice().sort((a, b) => {
                const aPrimary = PRIMARY_DEVICE_IDS.includes(a.device_id) || !a.readonly;
                const bPrimary = PRIMARY_DEVICE_IDS.includes(b.device_id) || !b.readonly;
                if (aPrimary && !bPrimary) return -1;
                if (!aPrimary && bPrimary) return 1;
                return (a.name || a.device_id).localeCompare(b.name || b.device_id);
            });

            // Update overview cards with totals
            updateOverview(devices);

            // Render device cards
            console.log('Rendering device cards...');
            const deviceCardsHtml = devices.map(device => {
                console.log(`  Rendering device: ${device.name} (${device.device_id})`);
                return createDeviceCard(device);
            }).join('');

            container.innerHTML = deviceCardsHtml;
            console.log(`Rendered ${devices.length} device cards`);

            // Add event listeners
            document.querySelectorAll('.toggle-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const deviceId = this.dataset.deviceId;
                    const currentState = this.dataset.state === 'true';
                    toggleDevice(deviceId, !currentState);
                });
            });

        } catch (error) {
            console.error('Error loading devices:', error);
            const container = document.getElementById('devices-container');
            if (container) {
                container.innerHTML =
                    '<p style="color: red;">Error loading devices: ' + error.message + '</p>';
            }
        }
    }

    function updateOverview(devices) {
        const totalPower = devices.reduce((sum, d) => sum + (d.current_power || 0), 0);
        const totalDailyEnergy = devices.reduce((sum, d) => sum + (d.daily_energy || 0), 0);
        const totalMonthlyEnergy = devices.reduce((sum, d) => sum + (d.monthly_energy || 0), 0);
        const totalDailyCost = devices.reduce((sum, d) => sum + (d.daily_cost || 0), 0);
        const totalMonthlyCost = devices.reduce((sum, d) => sum + (d.monthly_cost || 0), 0);

        // Update overview cards if they exist
        const powerCard = document.querySelector('.energy-card:first-child .energy-value');
        const dailyCostCard = document.querySelector('.energy-card:nth-child(2) .energy-value');
        const monthlyUsageCard = document.querySelector('.energy-card:nth-child(3) .energy-value');
        const monthlyCostCard = document.querySelector('.energy-card:nth-child(4) .energy-value');

        if (powerCard) powerCard.textContent = totalPower.toFixed(1);
        if (dailyCostCard) dailyCostCard.textContent = '$' + totalDailyCost.toFixed(2);
        if (monthlyUsageCard) monthlyUsageCard.textContent = totalMonthlyEnergy.toFixed(1);
        if (monthlyCostCard) monthlyCostCard.textContent = '$' + totalMonthlyCost.toFixed(2);
    }

    function createDeviceCard(device) {
        const isOnline = device.last_seen && new Date(device.last_seen) > new Date(Date.now() - 5 * 60000);
        const statusClass = isOnline ? 'status-online' : 'status-offline';
        const statusText = isOnline ? 'Online' : 'Offline';
        const powerState = device.power_state ? 'ON' : 'OFF';
        const isReadonly = !!device.readonly;
        const toggleBtnClass = isReadonly ? 'btn-secondary' : (device.power_state ? 'btn-danger' : 'btn-primary');
        const toggleBtnText = isReadonly ? 'Read-only' : (device.power_state ? 'Turn Off' : 'Turn On');

        return `
        <div class="device-card">
            <div class="device-header">
                <div>
                    <div class="device-name">${device.name || device.device_id}</div>
                    <div class="device-location">
                        ${device.location || 'Unknown'}
                        ${isReadonly ? ' ‚Ä¢ <span style="color:#6b7280;font-size:12px;">Read-only</span>' : ''}
                    </div>
                </div>
                <div class="device-status">
                    <div class="status-indicator ${statusClass}"></div>
                    <span>${statusText} (${powerState})</span>
                </div>
            </div>
            
            <div class="device-metrics">
                <div class="metric">
                    <div class="metric-value">${(device.current_power || 0).toFixed(1)}W</div>
                    <div class="metric-label">Current Power</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${(device.voltage || 0).toFixed(1)}V</div>
                    <div class="metric-label">Voltage</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${(device.current || 0).toFixed(2)}A</div>
                    <div class="metric-label">Current</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${(device.daily_energy || 0).toFixed(2)}kWh</div>
                    <div class="metric-label">Daily Usage</div>
                </div>
                <div class="metric">
                    <div class="metric-value">$${(device.daily_cost || 0).toFixed(2)}</div>
                    <div class="metric-label">Daily Cost</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${(device.monthly_energy || 0).toFixed(1)}kWh</div>
                    <div class="metric-label">Monthly Usage</div>
                </div>
            </div>
            
            <div class="device-controls">
                <button class="btn ${toggleBtnClass} toggle-btn" 
                        data-device-id="${device.device_id}" 
                        data-state="${device.power_state}"
                        ${!isOnline || isReadonly ? 'disabled' : ''}>
                    ${toggleBtnText}
                </button>
                <button class="btn btn-secondary" onclick="viewHistory('${device.device_id}')">History</button>
            </div>
        </div>
    `;
    }

    async function toggleDevice(deviceId, turnOn) {
        try {
            console.log(`Toggling device ${deviceId} to ${turnOn ? 'ON' : 'OFF'}`);
            const requestBody = { turn_on: turnOn };
            console.log('Request body:', JSON.stringify(requestBody));

            const response = await fetch(`/api/sensors/tapo-p115/${deviceId}/toggle`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            console.log('Response status:', response.status, response.statusText);

            if (!response.ok) {
                let errorMessage = `HTTP error! status: ${response.status} ${response.statusText}`;
                try {
                    const errorData = await response.json();
                    console.error('Error response JSON:', JSON.stringify(errorData, null, 2));
                    // Handle FastAPI validation errors
                    if (errorData.detail) {
                        if (Array.isArray(errorData.detail)) {
                            // Validation errors are arrays
                            errorMessage = errorData.detail.map(err => {
                                if (typeof err === 'string') return err;
                                return `${err.loc?.join('.') || 'field'}: ${err.msg || err.type || 'validation error'}`;
                            }).join('; ');
                        } else if (typeof errorData.detail === 'string') {
                            errorMessage = errorData.detail;
                        } else {
                            errorMessage = JSON.stringify(errorData.detail);
                        }
                    } else {
                        errorMessage = errorData.message || errorData.error || JSON.stringify(errorData);
                    }
                } catch (e) {
                    try {
                        const text = await response.text();
                        console.error('Error response text:', text);
                        errorMessage = text || errorMessage;
                    } catch (e2) {
                        console.error('Could not read error response:', e2);
                    }
                }
                throw new Error(errorMessage);
            }

            const result = await response.json();
            console.log('Toggle response:', result);

            if (result.success) {
                console.log(`Device ${deviceId} toggled successfully to ${result.power_state ? 'ON' : 'OFF'}`);
            }

            // Reload devices after toggle to get updated state
            await loadDevices();

            // Reload chart data to reflect changes
            if (typeof loadChartData === 'function') {
                loadChartData();
            }

        } catch (error) {
            console.error('Error toggling device:', error);
            console.error('Error stack:', error.stack);
            const errorMessage = error.message || String(error) || 'Unknown error occurred';
            alert('Error toggling device: ' + errorMessage);
        }
    }

    function viewHistory(deviceId) {
        window.location.href = `/energy?device=${deviceId}&view=history`;
    }
</script>
{% endblock %}