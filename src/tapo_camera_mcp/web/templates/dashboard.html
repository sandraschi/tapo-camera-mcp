{% extends "base.html" %}

{% block title %}Dashboard - Tapo Camera MCP{% endblock %}


{% block content %}
<div class="dashboard">
    <h1>Dashboard</h1>
    
    <!-- Status Overview -->
    <div class="status-overview">
        <div class="status-card">
            <div class="status-icon online">
                <i class="fas fa-video"></i>
            </div>
            <div class="status-info">
                <h3>Cameras Online</h3>
                <p class="count">{{ online_cameras }}/{{ total_cameras }}</p>
            </div>
        </div>
        
        <div class="status-card">
            <div class="status-icon storage">
                <i class="fas fa-hdd"></i>
            </div>
            <div class="status-info">
                <h3>Storage Used</h3>
                <p class="count">{{ storage_used }}%</p>
            </div>
        </div>
        
        <div class="status-card">
            <div class="status-icon alerts">
                <i class="fas fa-bell"></i>
            </div>
            <div class="status-info">
                <h3>Active Alerts</h3>
                <p class="count">{{ active_alerts }}</p>
            </div>
        </div>
        
        <div class="status-card">
            <div class="status-icon recording">
                <i class="fas fa-record-vinyl"></i>
            </div>
            <div class="status-info">
                <h3>Active Recordings</h3>
                <p class="count">{{ active_recordings }}</p>
            </div>
        </div>
    </div>
    
    <!-- Vienna Public Alerts -->
    <div class="section" id="vienna-alerts-section">
        <div class="section-header">
            <h2>üö® Vienna Public Alerts</h2>
            <button onclick="refreshAlerts()" class="btn btn-sm btn-secondary" title="Refresh alerts">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
        
        <div id="alerts-container">
            <div class="loading-state">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading alerts...</p>
            </div>
        </div>
    </div>
    
    <!-- Recent Events -->
    <div class="section">
        <div class="section-header">
            <h2>Recent Events</h2>
            <a href="{{ url_for('events') }}" class="btn btn-link">View All</a>
        </div>
        
        <div class="events-list">
            {% for event in recent_events %}
            <div class="event-item">
                <div class="event-icon">
                    {% if event.type == 'motion' %}
                    <i class="fas fa-running"></i>
                    {% elif event.type == 'recording' %}
                    <i class="fas fa-record-vinyl"></i>
                    {% else %}
                    <i class="fas fa-info-circle"></i>
                    {% endif %}
                </div>
                <div class="event-details">
                    <h4>{{ event.title }}</h4>
                    <p>{{ event.description }}</p>
                    <span class="event-time">{{ event.timestamp }}</span>
                </div>
                {% if event.has_thumbnail %}
                <div class="event-thumbnail">
                    <img src="{{ event.thumbnail_url }}" alt="Event Thumbnail">
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No recent events</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- System Status -->
    <div class="section">
        <div class="section-header">
            <h2>System Status</h2>
        </div>
        
        <div class="system-status">
            <div class="status-item">
                <div class="status-label">CPU Usage</div>
                <div class="status-bar">
                    <div class="progress" data-value="{{ system_status.cpu_usage }}">
                        <span class="sr-only">{{ system_status.cpu_usage }}%</span>
                    </div>
                    <span aria-hidden="true">{{ system_status.cpu_usage }}%</span>
                </div>
            </div>
            
            <div class="status-item">
                <div class="status-label">Memory Usage</div>
                <div class="status-bar">
                    <div class="progress" data-value="{{ system_status.memory_usage }}">
                        <span class="sr-only">{{ system_status.memory_usage }}%</span>
                    </div>
                    <span aria-hidden="true">{{ system_status.memory_usage }}%</span>
                </div>
            </div>
            
            <div class="status-item">
                <div class="status-label">Disk Usage</div>
                <div class="status-bar">
                    <div class="progress" data-value="{{ system_status.disk_usage }}">
                        <span class="sr-only">{{ system_status.disk_usage }}%</span>
                    </div>
                    <span aria-hidden="true">{{ system_status.disk_usage }}%</span>
                </div>
            </div>
            
            <div class="status-item">
                <div class="status-label">Network</div>
                <div class="status-details">
                    <span>‚Üë {{ system_status.network.upload }} MB/s</span>
                    <span>‚Üì {{ system_status.network.download }} MB/s</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Dashboard functionality (historical/system only)
    document.addEventListener('DOMContentLoaded', function() {
        // Set progress bar widths from data attributes
        document.querySelectorAll('.progress[data-value]').forEach(progress => {
            const value = progress.getAttribute('data-value');
            if (value) {
                progress.style.width = `${value}%`;
            }
        });
        
        // Load Vienna alerts
        loadAlerts();
        
        // Refresh alerts every 5 minutes
        setInterval(loadAlerts, 5 * 60 * 1000);
    });
    
    async function loadAlerts() {
        const container = document.getElementById('alerts-container');
        
        try {
            const response = await fetch('/alerts/summary');
            if (!response.ok) throw new Error('Failed to fetch alerts');
            
            const data = await response.json();
            renderAlerts(data);
        } catch (error) {
            console.error('Error loading alerts:', error);
            container.innerHTML = `
                <div class="alert-item" style="background: #374151; padding: 16px; border-radius: 8px; text-align: center;">
                    <p style="color: #9CA3AF; margin: 0;">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Unable to load alerts. <a href="#" onclick="loadAlerts(); return false;" style="color: #60A5FA;">Retry</a>
                    </p>
                </div>
            `;
        }
    }
    
    async function refreshAlerts() {
        const container = document.getElementById('alerts-container');
        container.innerHTML = `
            <div class="loading-state">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Refreshing alerts...</p>
            </div>
        `;
        
        try {
            const response = await fetch('/alerts/refresh');
            if (!response.ok) throw new Error('Failed to refresh alerts');
            
            const data = await response.json();
            // Convert to summary format
            const summary = {
                total_alerts: data.total,
                highest_severity: data.alerts.length > 0 ? data.alerts[0].severity : 'unknown',
                highest_severity_color: data.alerts.length > 0 ? data.alerts[0].severity_color : '#9CA3AF',
                highest_severity_icon: data.alerts.length > 0 ? data.alerts[0].severity_icon : '‚úì',
                alerts: data.alerts.slice(0, 5),
                status: data.total === 0 ? 'ok' : 'warning'
            };
            renderAlerts(summary);
        } catch (error) {
            console.error('Error refreshing alerts:', error);
            loadAlerts(); // Fallback to cached
        }
    }
    
    function renderAlerts(data) {
        const container = document.getElementById('alerts-container');
        
        if (data.total_alerts === 0) {
            container.innerHTML = `
                <div class="alert-status-ok" style="background: linear-gradient(135deg, #065F46, #047857); padding: 20px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 8px;">‚úÖ</div>
                    <h3 style="color: #A7F3D0; margin: 0 0 8px 0; font-size: 18px;">All Clear</h3>
                    <p style="color: #6EE7B7; margin: 0; font-size: 14px;">
                        No active weather or emergency alerts for Vienna
                    </p>
                    <p style="color: #34D399; margin: 8px 0 0 0; font-size: 12px;">
                        Sources: GeoSphere Austria, Meteoalarm
                    </p>
                </div>
            `;
            return;
        }
        
        // Build alerts HTML
        let alertsHtml = `
            <div class="alerts-summary" style="display: grid; grid-template-columns: auto 1fr; gap: 16px; margin-bottom: 16px;">
                <div class="alert-badge" style="background: ${data.highest_severity_color}; padding: 16px 24px; border-radius: 12px; text-align: center; min-width: 120px;">
                    <div style="font-size: 32px;">${data.highest_severity_icon}</div>
                    <div style="font-size: 24px; font-weight: bold; color: white;">${data.total_alerts}</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.8); text-transform: uppercase;">Alert${data.total_alerts !== 1 ? 's' : ''}</div>
                </div>
                <div class="alerts-list" style="display: flex; flex-direction: column; gap: 8px;">
        `;
        
        // Add each alert
        for (const alert of data.alerts) {
            const typeIcon = getAlertTypeIcon(alert.alert_type);
            alertsHtml += `
                <div class="alert-item" style="background: #374151; padding: 12px 16px; border-radius: 8px; border-left: 4px solid ${alert.severity_color};">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 20px;">${typeIcon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #F3F4F6; font-size: 14px;">${escapeHtml(alert.title)}</div>
                            <div style="color: #9CA3AF; font-size: 12px; margin-top: 2px;">
                                ${alert.region} ‚Ä¢ ${alert.source === 'geosphere' ? 'GeoSphere' : 'Meteoalarm'}
                            </div>
                        </div>
                        <span style="font-size: 16px;" title="${alert.severity}">${alert.severity_icon}</span>
                    </div>
                    ${alert.description ? `<p style="color: #D1D5DB; font-size: 13px; margin: 8px 0 0 32px; line-height: 1.4;">${escapeHtml(truncate(alert.description, 150))}</p>` : ''}
                </div>
            `;
        }
        
        alertsHtml += `
                </div>
            </div>
            <div style="text-align: center; color: #6B7280; font-size: 11px;">
                Last updated: ${new Date().toLocaleTimeString('de-AT')} ‚Ä¢ Sources: GeoSphere Austria, Meteoalarm
            </div>
        `;
        
        container.innerHTML = alertsHtml;
    }
    
    function getAlertTypeIcon(type) {
        const icons = {
            'weather': 'üå§Ô∏è',
            'storm': 'üå™Ô∏è',
            'wind': 'üí®',
            'rain': 'üåßÔ∏è',
            'snow': '‚ùÑÔ∏è',
            'ice': 'üßä',
            'fog': 'üå´Ô∏è',
            'heat': 'üå°Ô∏è',
            'cold': 'ü•∂',
            'thunderstorm': '‚õàÔ∏è',
            'flood': 'üåä',
            'fire': 'üî•',
            'avalanche': 'üèîÔ∏è',
        };
        return icons[type] || '‚ö†Ô∏è';
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function truncate(text, maxLength) {
        if (!text || text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }
</script>
{% endblock %}
